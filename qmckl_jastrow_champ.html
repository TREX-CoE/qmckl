<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2025-09-23 Tue 11:18 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>CHAMP Jastrow Factor</title>
<meta name="author" content="TREX CoE" />
<meta name="generator" content="Org Mode" />
<style>
  #content { max-width: 60em; margin: auto; }
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #e6e6e6;
    border-radius: 3px;
    background-color: #f2f2f2;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: auto;
  }
  pre.src:before {
    display: none;
    position: absolute;
    top: -8px;
    right: 12px;
    padding: 3px;
    color: #555;
    background-color: #f2f2f299;
  }
  pre.src:hover:before { display: inline; margin-top: 14px;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-authinfo::before { content: 'Authinfo'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .equation-container {
    display: table;
    text-align: center;
    width: 100%;
  }
  .equation {
    vertical-align: middle;
  }
  .equation-label {
    display: table-cell;
    text-align: right;
    vertical-align: middle;
  }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { }
</style>
<link rel="stylesheet" title="Standard" href="qmckl.css" type="text/css" />

<script src="org-info.js">
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
// @license-end
</script>

<script>
// @license magnet:?xt=urn:btih:1f739d935676111cfff4b4693e3816e664797050&amp;dn=gpl-3.0.txt GPL-v3-or-Later
org_html_manager.set("TOC_DEPTH", "4");
org_html_manager.set("LINK_HOME", "index.html");
org_html_manager.set("LINK_UP", "");
org_html_manager.set("LOCAL_TOC", "1");
org_html_manager.set("VIEW_BUTTONS", "0");
org_html_manager.set("MOUSE_HINT", "underline");
org_html_manager.set("FIXED_TOC", "0");
org_html_manager.set("TOC", "1");
org_html_manager.set("VIEW", "info");
org_html_manager.setup();  // activate after the parameters are set
// @license-end
</script>
<script>
  window.MathJax = {
    tex: {
      ams: {
        multlineWidth: '85%'
      },
      tags: 'ams',
      tagSide: 'right',
      tagIndent: '.8em'
    },
    chtml: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    svg: {
      scale: 1.0,
      displayAlign: 'center',
      displayIndent: '0em'
    },
    output: {
      font: 'mathjax-modern',
      displayOverflow: 'overflow'
    }
  };
</script>

<script
  id="MathJax-script"
  async
  src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js">
</script>
</head>
<body>
<div id="org-div-home-and-up">
 <a accesskey="h" href=""> UP </a>
 |
 <a accesskey="H" href="index.html"> HOME </a>
</div><div id="content" class="content">
<h1 class="title">CHAMP Jastrow Factor</h1>
<div id="table-of-contents" role="doc-toc">
<h2>Table of Contents</h2>
<div id="text-table-of-contents" role="doc-toc">
<ul>
<li><a href="#orgf936685">1. Introduction</a>
<ul>
<li><a href="#orga2df7ea">1.1. Reformulation of the three-body part</a></li>
</ul>
</li>
<li><a href="#orgbc7dfb2">2. </a></li>
<li><a href="#org84f47af">3. Context</a>
<ul>
<li><a href="#org6402e24">3.1. Data structure</a></li>
<li><a href="#org84a3010">3.2. Initialization functions</a>
<ul>
<li>
<ul>
<li><a href="#orga22d881">3.2.0.1. Fortran interface</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org86bb3d1">3.3. Access functions</a>
<ul>
<li>
<ul>
<li><a href="#orgd4db56d">3.3.0.1. Fortran interface</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
<li><a href="#org3d4c47c">4. Computation</a>
<ul>
<li><a href="#org671fedc">4.1. Electron-electron component</a>
<ul>
<li><a href="#org4f8890e">4.1.1. Asymptotic component</a>
<ul>
<li><a href="#orgc5730f9">4.1.1.1. Get</a></li>
<li><a href="#org05dee4f">4.1.1.2. Compute</a></li>
</ul>
</li>
<li><a href="#org59daaba">4.1.2. Electron-electron rescaled distances</a>
<ul>
<li><a href="#org8a2af70">4.1.2.1. Get</a></li>
<li><a href="#orgc5b1d8b">4.1.2.2. Compute</a></li>
</ul>
</li>
<li><a href="#orgcc23c9c">4.1.3. Electron-electron rescaled distance gradients and Laplacian with respect to electron coordinates</a>
<ul>
<li><a href="#org115c79a">4.1.3.1. Get</a></li>
<li><a href="#org3f3cc61">4.1.3.2. Compute</a></li>
</ul>
</li>
<li><a href="#orgdb3488f">4.1.4. Electron-electron component</a>
<ul>
<li><a href="#org1f4ab0e">4.1.4.1. Get</a></li>
<li><a href="#orgcb70e7b">4.1.4.2. Compute</a></li>
</ul>
</li>
<li><a href="#org8e58a92">4.1.5. Derivative</a>
<ul>
<li><a href="#org2b6c2aa">4.1.5.1. Get</a></li>
<li><a href="#org1e28694">4.1.5.2. Compute</a></li>
</ul>
</li>
<li><a href="#org9585eee">4.1.6. Parameter Derivative of the Asymptotic component</a>
<ul>
<li><a href="#org23bffe7">4.1.6.1. Get</a></li>
<li><a href="#org94ff431">4.1.6.2. Compute</a></li>
</ul>
</li>
<li><a href="#orgd8a8f7f">4.1.7. Parameter Derivative</a>
<ul>
<li><a href="#org4128caf">4.1.7.1. Get</a></li>
<li><a href="#org1f4ec04">4.1.7.2. Compute</a></li>
</ul>
</li>
<li><a href="#org6762315">4.1.8. Parameter Derivative of the gradient and Laplacian</a>
<ul>
<li><a href="#orgf569028">4.1.8.1. Get</a></li>
<li><a href="#orged03fc8">4.1.8.2. Compute</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org5566163">4.2. Electron-nucleus component</a>
<ul>
<li><a href="#org87a62bd">4.2.1. Asymptotic component</a>
<ul>
<li><a href="#org13a1acc">4.2.1.1. Get</a></li>
<li><a href="#orga1ccca8">4.2.1.2. Compute</a></li>
</ul>
</li>
<li><a href="#orge24abb6">4.2.2. Electron-nucleus rescaled distances</a>
<ul>
<li><a href="#org801ded4">4.2.2.1. Get</a></li>
<li><a href="#org63c8b7f">4.2.2.2. Compute</a></li>
</ul>
</li>
<li><a href="#orgab9f3dd">4.2.3. Electron-electron rescaled distance gradients and Laplacian with respect to electron coordinates</a>
<ul>
<li><a href="#orgd621f7c">4.2.3.1. Get</a></li>
<li><a href="#org52be062">4.2.3.2. Compute</a></li>
</ul>
</li>
<li><a href="#orgcb9b84a">4.2.4. Electron-nucleus component</a>
<ul>
<li><a href="#org7fc46a4">4.2.4.1. Get</a></li>
<li><a href="#org5542f68">4.2.4.2. Compute</a></li>
</ul>
</li>
<li><a href="#org1bceda1">4.2.5. Derivative</a>
<ul>
<li><a href="#org83c3338">4.2.5.1. Get</a></li>
<li><a href="#org0ed38ed">4.2.5.2. Compute</a></li>
<li><a href="#orgde5bc35">4.2.5.3. Test</a></li>
</ul>
</li>
<li><a href="#org348fe69">4.2.6. Parameter Derivative of the Asymptotic component</a>
<ul>
<li><a href="#org7fde76a">4.2.6.1. Get</a></li>
<li><a href="#orgeb0a641">4.2.6.2. Compute</a></li>
</ul>
</li>
<li><a href="#org4803ca5">4.2.7. Parameter Derivative</a>
<ul>
<li><a href="#orgb33651a">4.2.7.1. Get</a></li>
<li><a href="#org3fb026c">4.2.7.2. Compute</a></li>
</ul>
</li>
<li><a href="#org0738729">4.2.8. Parameter Derivative of the gradient and Laplacian</a>
<ul>
<li><a href="#org66bcb8b">4.2.8.1. Get</a></li>
<li><a href="#orgbfaeefe">4.2.8.2. Compute</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org7d2a0d5">4.3. Electron-electron-nucleus component</a>
<ul>
<li><a href="#org9d1e396">4.3.1. Electron-electron rescaled distances in \(J_\text{eeN}\)</a>
<ul>
<li><a href="#org52c11db">4.3.1.1. Get</a></li>
<li><a href="#orge82f62d">4.3.1.2. Compute</a></li>
<li><a href="#org72a1147">4.3.1.3. Test</a></li>
</ul>
</li>
<li><a href="#orgd2b3893">4.3.2. Electron-electron rescaled distances derivatives in \(J_\text{eeN}\)</a>
<ul>
<li><a href="#org1ead28a">4.3.2.1. Get</a></li>
<li><a href="#org24b4852">4.3.2.2. Compute</a></li>
</ul>
</li>
<li><a href="#org388d78d">4.3.3. Electron-nucleus rescaled distances in \(J_\text{eeN}\)</a>
<ul>
<li><a href="#orgf3e946c">4.3.3.1. Get</a></li>
<li><a href="#org0390a82">4.3.3.2. Compute</a></li>
</ul>
</li>
<li><a href="#org6c6c47e">4.3.4. Electron-nucleus rescaled distances derivatives in \(J_\text{eeN}\)</a>
<ul>
<li><a href="#orge3b7f72">4.3.4.1. Get</a></li>
<li><a href="#org55310d7">4.3.4.2. Compute</a></li>
</ul>
</li>
<li><a href="#org407b09a">4.3.5. Temporary arrays for electron-electron-nucleus Jastrow \(f_{een}\)</a>
<ul>
<li><a href="#orgbba6149">4.3.5.1. Compute dim<sub>c</sub><sub>vector</sub></a></li>
<li><a href="#orgeca1056">4.3.5.2. Get</a></li>
<li><a href="#orgdf879ab">4.3.5.3. Compute c<sub>vector</sub><sub>full</sub></a></li>
<li><a href="#orgbf551b6">4.3.5.4. Compute lkpm<sub>combined</sub><sub>index</sub></a></li>
<li><a href="#org2fddc6e">4.3.5.5. Compute tmp<sub>c</sub></a></li>
<li><a href="#org14a39c1">4.3.5.6. Compute dtmp<sub>c</sub></a></li>
</ul>
</li>
<li><a href="#orge68c493">4.3.6. Electron-electron-nucleus Jastrow \(f_{een}\)</a>
<ul>
<li><a href="#orged18fd9">4.3.6.1. Get</a></li>
<li><a href="#org8f92e0e">4.3.6.2. Compute naive</a></li>
<li><a href="#orga2aa6cb">4.3.6.3. Compute</a></li>
</ul>
</li>
<li><a href="#org8e6cb61">4.3.7. Electron-electron-nucleus Jastrow \(f_{een}\) derivative</a>
<ul>
<li><a href="#org52fc4bb">4.3.7.1. Get</a></li>
<li><a href="#orgaf36a02">4.3.7.2. Compute Naive</a></li>
<li><a href="#orge9c1060">4.3.7.3. Compute GL</a></li>
<li><a href="#org4c4e6e2">4.3.7.4. Compute Gradient only</a></li>
</ul>
</li>
<li><a href="#orgffe2e30">4.3.8. Electron-electron-nucleus Jastrow Parameter derivatives</a>
<ul>
<li><a href="#orgcc2b38b">4.3.8.1. Get</a></li>
<li><a href="#org2c68709">4.3.8.2. Compute</a></li>
</ul>
</li>
<li><a href="#org32333b6">4.3.9. Electron-electron-nucleus Parameter Derivative of the gradient and Laplacian</a>
<ul>
<li><a href="#org71f71e0">4.3.9.1. Get</a></li>
<li><a href="#orgfc7ef13">4.3.9.2. Compute</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#org0760f83">4.4. Total Jastrow</a>
<ul>
<li><a href="#org848d1c4">4.4.1. Value</a>
<ul>
<li><a href="#org5b0b780">4.4.1.1. Get</a></li>
<li><a href="#orgbd177d0">4.4.1.2. Compute</a></li>
</ul>
</li>
<li><a href="#org7563da5">4.4.2. Derivatives</a>
<ul>
<li><a href="#orgf3f5c6d">4.4.2.1. Get</a></li>
<li><a href="#org8c40b62">4.4.2.2. Compute GL</a></li>
<li><a href="#org4b72240">4.4.2.3. Compute Gradient only</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>

<div id="outline-container-orgf936685" class="outline-2">
<h2 id="orgf936685"><span class="section-number-2">1.</span> Introduction</h2>
<div class="outline-text-2" id="text-1">
<p>
The Jastrow factor depends on the electronic (\(\mathbf{r}\)) and
nuclear (\(\mathbf{R}\)) coordinates. Its defined as \(\exp(J(\mathbf{r},\mathbf{R}))\), where
</p>

<p>
\[
  J(\mathbf{r},\mathbf{R}) = J_{\text{eN}}(\mathbf{r},\mathbf{R}) + J_{\text{ee}}(\mathbf{r}) + J_{\text{eeN}}(\mathbf{r},\mathbf{R})
  \]
</p>

<p>
In the following, we use the notations \(r_{ij} = |\mathbf{r}_i - \mathbf{r}_j|\) and
\(R_{i\alpha} = |\mathbf{r}_i - \mathbf{R}_\alpha|\).
</p>

<p>
\(J_{\text{eN}}\) contains electron-nucleus  terms:
</p>

<p>
\[
  J_{\text{eN}}(\mathbf{r},\mathbf{R}) =
  \sum_{\alpha=1}^{N_\text{nucl}} \sum_{i=1}^{N_\text{elec}}
  \frac{a_{1\,\alpha}\, f_\alpha(R_{i\alpha})}{1+a_{2\,\alpha}\, f_\alpha(R_{i\alpha})} +
  \sum_{p=2}^{N_\text{ord}^a} a_{p+1\,\alpha}\, [f_\alpha(R_{i\alpha})]^p - J_{\text{eN}}^{\infty \alpha}
  \]
</p>

<p>
\(J_{\text{ee}}\) contains electron-electron terms:
\[
  J_{\text{ee}}(\mathbf{r}) =
  \sum_{i=1}^{N_\text{elec}} \sum_{j=1}^{i-1}
  \frac{\frac{1}{2}(1+\delta^{\uparrow\downarrow}_{ij}) b_1\, f_{\text{ee}}(r_{ij})}{1+b_2\, f_{\text{ee}}(r_{ij})} +
  \sum_{p=2}^{N_\text{ord}^b} b_{p+1}\, [f_{\text{ee}}(r_{ij})]^p  - J_{ee}^\infty
  \]
</p>

<p>
and \(J_{\text{eeN}}\) contains electron-electron-Nucleus terms:
</p>

<p>
\[
   J_{\text{eeN}}(\mathbf{r},\mathbf{R}) =
    \sum_{\alpha=1}^{N_{\text{nucl}}}
     \sum_{i=1}^{N_{\text{elec}}}
      \sum_{j=1}^{i-1}
       \sum_{p=2}^{N_{\text{ord}}}
        \sum_{k=0}^{p-1}
         \sum_{l=0}^{p-k-2\delta_{k,0}}
           c_{lkp\alpha} \left[ g_\text{e}({r}_{ij}) \right]^k
             \left[ \left[ g_\alpha({R}_{i\alpha}) \right]^l + \left[ g_\alpha({R}_{j\alpha}) \right]^l \right]
             \left[ g_\alpha({R}_{i\,\alpha}) \, g_\alpha({R}_{j\alpha}) \right]^{(p-k-l)/2}
   \]
</p>

<p>
\(c_{lkp\alpha}\) are non-zero only when \(p-k-l\) is even.
</p>

<p>
\(f\) and \(g\) are scaling function defined as
</p>

<p>
\[
  f_\alpha(r) = \frac{1-e^{-\kappa_\alpha\, r}}{\kappa_\alpha} \text{ and }
  g_\alpha(r) = e^{-\kappa_\alpha\, r} = 1-\kappa_\alpha f_\alpha(r).
  \]
</p>

<p>
The terms \(J_{\text{ee}}^\infty\) and \(J_{\text{eN}}^\infty\) are shifts to ensure that
\(J_{\text{ee}}\) and \(J_{\text{eN}}\) have an asymptotic value of zero.
</p>

<p>
The eN and eeN parameters are the same of all identical nuclei.
Warning: The types of nuclei use zero-based indexing.
</p>

<p>
The derivatives are computed with respect to the electron \(i\) for
\[ r_{ij} = |r_i - r_j| \]
</p>
</div>

<div id="outline-container-orga2df7ea" class="outline-3">
<h3 id="orga2df7ea"><span class="section-number-3">1.1.</span> Reformulation of the three-body part</h3>
<div class="outline-text-3" id="text-1-1">
<p>
To accelerate the computation of the three-body part, the Jastrow
factor is re-expressed as follows, with \(m=(p-k)/2 -l/2\):
</p>


\begin{eqnarray*}
   J_{kpl} & = & \sum_{\alpha=1}^{N_{\text{nucl}}}
     \sum_{i=1}^{N_{\text{elec}}}
      \sum_{j=1}^{i-1}
           c_{lkp\alpha} \left[ g_\text{e}({r}_{ij}) \right]^k
             \left[ \left[ g_\alpha({R}_{i\alpha}) \right]^l + \left[ g_\alpha({R}_{j\alpha}) \right]^l \right]
             \left[ g_\alpha({R}_{i\,\alpha}) \,
   g_\alpha({R}_{j\alpha}) \right]^{m} \\
   & = & \frac{1}{2}
    \sum_{\alpha=1}^{N_{\text{nucl}}}
     \sum_{i=1}^{N_{\text{elec}}}
      \sum_{j=1}^{N_{\text{elec}}}
           c_{lkp\alpha} \left[ g_\text{e}({r}_{ij}) \right]^k
             \left[ \left[ g_\alpha({R}_{i\alpha}) \right]^l + \left[ g_\alpha({R}_{j\alpha}) \right]^l \right]
             \left[ g_\alpha({R}_{i\,\alpha}) \, g_\alpha({R}_{j\alpha}) \right]^{m} \\
   & = & \frac{1}{2}
    \sum_{\alpha=1}^{N_{\text{nucl}}}
     \sum_{i=1}^{N_{\text{elec}}}
      \sum_{j=1}^{N_{\text{elec}}}
           c_{lkp\alpha} \left[ g_\text{e}({r}_{ij}) \right]^k
             \left[ \left[ g_\alpha({R}_{i\alpha}) \right]^{l+m} \left[ g_\alpha({R}_{j\alpha}) \right]^{m} +
                    \left[ g_\alpha({R}_{i\alpha}) \right]^{l} \left[
    g_\alpha({R}_{j\alpha}) \right]^{l+m} \right] \\
   & = & 
    \sum_{\alpha=1}^{N_{\text{nucl}}} c_{lkp\alpha}
     \sum_{i=1}^{N_{\text{elec}}}
      \sum_{j=1}^{N_{\text{elec}}} 
             \left[ g_\alpha({R}_{i\alpha}) \right]^{l+m}
             \left[ g_\text{e}({r}_{ij}) \right]^k
             \left[ g_\alpha({R}_{j\alpha}) \right]^{m} \\
   & = & 
    \sum_{\alpha=1}^{N_{\text{nucl}}} c_{lkp\alpha}
     \sum_{i=1}^{N_{\text{elec}}} 
             \left[ g_\alpha({R}_{i\alpha}) \right]^{l+m}
             P_{i\alpha}^{km}, \text{ with }
             P_{i\alpha}^{km} =
      \sum_{j=1}^{N_{\text{elec}}} 
             \left[ g_\text{e}({r}_{ij}) \right]^k
             \left[ g_\alpha({R}_{j\alpha}) \right]^{m}. \\
J   & = & 
   \sum_{p=2}^{N_{\text{ord}}}
    \sum_{k=0}^{p-1}
     \sum_{l=0}^{p-k-2\delta_{k,0}}
      \sum_{\alpha=1}^{N_{\text{nucl}}} c_{lkp\alpha}
       \sum_{i=1}^{N_{\text{elec}}}
        \left[ g_\alpha({R}_{i\alpha}) \right]^{(p-k+l)/2}
             P_{i\alpha}^{k, (p-k-l)/2}
   \end{eqnarray*}

<p>
The computation of \(P\) scales as   \(\mathcal{O}(N_\text{elec}^2 N_\text{nucl}n^2)\), and 
the computation of \(J\) scales as \(\mathcal{O}(N_\text{elec}N_\text{nucl}n^2)\).
</p>
</div>
</div>
</div>

<div id="outline-container-orgbc7dfb2" class="outline-2">
<h2 id="orgbc7dfb2"><span class="section-number-2">2.</span> </h2>
</div>
<div id="outline-container-org84f47af" class="outline-2">
<h2 id="org84f47af"><span class="section-number-2">3.</span> Context</h2>
<div class="outline-text-2" id="text-3">
<p>
The following data stored in the context:
</p>

<table id="org9b9cd26" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>uninitialized</code></td>
<td class="org-left"><code>int32_t</code></td>
<td class="org-left">Keeps bits set for uninitialized data</td>
</tr>

<tr>
<td class="org-left"><code>rescale_factor_ee</code></td>
<td class="org-left"><code>double</code></td>
<td class="org-left">The distance scaling factor</td>
</tr>

<tr>
<td class="org-left"><code>rescale_factor_en</code></td>
<td class="org-left"><code>double[type_nucl_num]</code></td>
<td class="org-left">The distance scaling factor</td>
</tr>

<tr>
<td class="org-left"><code>aord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">The number of a coeffecients</td>
</tr>

<tr>
<td class="org-left"><code>bord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">The number of b coeffecients</td>
</tr>

<tr>
<td class="org-left"><code>cord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">The number of c coeffecients</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">Number of Nuclei types</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_vector</code></td>
<td class="org-left"><code>int64_t[nucl_num]</code></td>
<td class="org-left">IDs of types of Nuclei. These use 0-based indexing as in C.</td>
</tr>

<tr>
<td class="org-left"><code>a_vector</code></td>
<td class="org-left"><code>double[aord_num + 1][type_nucl_num]</code></td>
<td class="org-left">a polynomial coefficients</td>
</tr>

<tr>
<td class="org-left"><code>b_vector</code></td>
<td class="org-left"><code>double[bord_num + 1]</code></td>
<td class="org-left">b polynomial coefficients</td>
</tr>

<tr>
<td class="org-left"><code>c_vector</code></td>
<td class="org-left"><code>double[dim_c_vector][type_nucl_num]</code></td>
<td class="org-left">c polynomial coefficients</td>
</tr>

<tr>
<td class="org-left"><code>spin_independent</code></td>
<td class="org-left"><code>int32_t</code></td>
<td class="org-left">If 1, use same parameters for parallel and anti-parallel spins. Otherwise, 0.</td>
</tr>
</tbody>
</table>

<p>
Computed data:
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">&#xa0;</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>dim_c_vector</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">Number of unique C coefficients</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>dim_c_vector_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Last modification of the number of unique C coefficients</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>asymp_jasa</code></td>
<td class="org-left"><code>double[type_nucl_num]</code></td>
<td class="org-left">Asymptotic component</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>asymp_jasa_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Last modification of the asymptotic component</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>asymp_jasa_pderiv</code></td>
<td class="org-left"><code>double[type_nucl_num][aord_num+1]</code></td>
<td class="org-left">Derivatives w.r.t. the A parameters of the Asymptotic component</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>asymp_jasa_pderiv_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Last modification of the asymptotic component derivative</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>asymp_jasb</code></td>
<td class="org-left"><code>double[2]</code></td>
<td class="org-left">Asymptotic component</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>asymp_jasb_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Last modification of derivative of the asymptotic jastrow</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>asymp_jasb_pderiv</code></td>
<td class="org-left"><code>double[2][bord_num+1]</code></td>
<td class="org-left">Derivative of the asymptotic jastrow w.r.t the jastrow parameters (up- or down-spin)</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>asymp_jasb_pderiv_date</code></td>
<td class="org-left"><code>double[2][bord_num+1]</code></td>
<td class="org-left">Last modification of psrameter derivative of the asymptotic jastrow</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>c_vector_full</code></td>
<td class="org-left"><code>double[dim_c_vector][nucl_num]</code></td>
<td class="org-left">vector of non-zero coefficients</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>c_vector_full_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Keep track of changes here</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>lkpm_combined_index</code></td>
<td class="org-left"><code>int64_t[4][dim_c_vector]</code></td>
<td class="org-left">Transform l,k,p, and m into consecutive indices</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>lkpm_combined_index_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Transform l,k,p, and m into consecutive indices</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>tmp_c</code></td>
<td class="org-left"><code>double[walk_num][cord_num][cord_num+1][nucl_num][elec_num]</code></td>
<td class="org-left">vector of non-zero coefficients</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>dtmp_c</code></td>
<td class="org-left"><code>double[walk_num][elec_num][4][nucl_num][cord_num+1][cord_num]</code></td>
<td class="org-left">vector of non-zero coefficients</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>ee_distance_rescaled</code></td>
<td class="org-left"><code>double[walk_num][num][num]</code></td>
<td class="org-left">Electron-electron rescaled distances</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>ee_distance_rescaled_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Last modification date of the electron-electron distances</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>ee_distance_rescaled_gl</code></td>
<td class="org-left"><code>double[walk_num][num][num][4]</code></td>
<td class="org-left">Electron-electron rescaled distances derivatives</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>ee_distance_rescaled_gl_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Last modification date of the electron-electron distance derivatives</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>en_distance_rescaled</code></td>
<td class="org-left"><code>double[walk_num][nucl_num][num]</code></td>
<td class="org-left">Electron-nucleus distances</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>en_distance_rescaled_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Last modification date of the electron-electron distances</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>en_distance_rescaled_gl</code></td>
<td class="org-left"><code>double[walk_num][nucl_num][num][4]</code></td>
<td class="org-left">Electron-electron rescaled distances derivatives</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>en_distance_rescaled_gl_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Last modification date of the electron-electron distance derivatives</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n</code></td>
<td class="org-left"><code>double[walk_num][cord_num+1][nucl_num][elec_num]</code></td>
<td class="org-left">The electron-electron rescaled distances raised to the powers defined by cord</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Keep track of the date of creation</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_e_gl</code></td>
<td class="org-left"><code>double[walk_num][cord_num+1][elec_num][4][elec_num]</code></td>
<td class="org-left">The electron-electron rescaled distances raised to the powers defined by cord derivatives wrt electrons</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_e_gl_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Keep track of the date of creation</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n_gl</code></td>
<td class="org-left"><code>double[walk_num][cord_num+1][nucl_num][4][elec_num]</code></td>
<td class="org-left">The electron-electron rescaled distances raised to the powers defined by cord derivatives wrt electrons</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n_gl_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Keep track of the date of creation</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_ee</code></td>
<td class="org-left"><code>double[walk_num]</code></td>
<td class="org-left">Jastrow factor: electron-electron part</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_ee_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Jastrow factor: electron-electron part</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_ee_pderiv</code></td>
<td class="org-left"><code>double[bord_num+1]</code></td>
<td class="org-left">Parameter derivatives Jastrow factor: electron-electron part</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_ee_pderiv_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Parameter derivatives Jastrow factor: electron-electron part</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_en</code></td>
<td class="org-left"><code>double[walk_num]</code></td>
<td class="org-left">Jastrow factor: electron-nucleus  part</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_en_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Jastrow factor: electron-nucleus  part</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_en_pderiv</code></td>
<td class="org-left"><code>double[type_nucl_num][aord_num+1]</code></td>
<td class="org-left">Parameter derivatives Jastrow factor: electron-nucleus  part</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_en_pderiv_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Parameter derivativesJastrow factor: electron-nucleus  part</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_een</code></td>
<td class="org-left"><code>double[walk_num]</code></td>
<td class="org-left">Jastrow factor: electron-electron-nucleus  part</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_een_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Jastrow factor: electron-electron-nucleus  part</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_een_pderiv</code></td>
<td class="org-left"><code>double[type_nucl_num][dim_c_vector]</code></td>
<td class="org-left">Parameter derivatives Jastrow factor: electron-electron-nucleus  part</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_een_pderiv_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Parameter derivatives Jastrow factor: electron-electron-nucleus  part</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_ee_gl</code></td>
<td class="org-left"><code>double[walk_num][4][elec_num]</code></td>
<td class="org-left">Parameter derivatives Jastrow factor: electron-electron-nucleus  part</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_ee_gl_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Keep track of the date for the derivative</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_ee_gl_pderiv</code></td>
<td class="org-left"><code>double[bord_num+1][elec_num][4]</code></td>
<td class="org-left">Parameter derivative of the gradient of the jastrow factor</td>
<td class="org-left">Derivative of the gradient and Laplacian with respect to the Jastrow parameters</td>
</tr>

<tr>
<td class="org-left"><code>factor_ee_gl_pderiv_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Parameter derivative of the gradient of the jastrow factor</td>
<td class="org-left">Derivative of the gradient and Laplacian with respect to the Jastrow parameters</td>
</tr>

<tr>
<td class="org-left"><code>factor_en_gl</code></td>
<td class="org-left"><code>double[walk_num][4][elec_num]</code></td>
<td class="org-left">Derivative of the Jastrow factor: electron-electron-nucleus  part</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_en_gl_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Keep track of the date for the en derivative</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_en_gl_pderiv</code></td>
<td class="org-left"><code>double[type_nucl_num][aord_num+1][elec_num][4]</code></td>
<td class="org-left">Derivative of the Jastrow factor: electron-electron-nucleus  part</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_en_gl_pderiv_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Keep track of the date for the en derivative</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_een_gl</code></td>
<td class="org-left"><code>double[walk_num][4][elec_num]</code></td>
<td class="org-left">Derivative of the Jastrow factor: electron-electron-nucleus  part</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_een_gl_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Keep track of the date for the een derivative</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_een_grad</code></td>
<td class="org-left"><code>double[walk_num][3][elec_num]</code></td>
<td class="org-left">Gradient of the Jastrow factor: electron-electron-nucleus  part</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_een_grad_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Keep track of the date for the een derivative</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_een_gl_pderiv</code></td>
<td class="org-left"><code>double[type_nucl_num][dim_c_vector][elec_num][4]</code></td>
<td class="org-left">Parameter Derivative of the Jastrow factor: electron-electron-nucleus  part</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_een_gl_pderiv_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Keep track of the date for the en derivative</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>value</code></td>
<td class="org-left"><code>double[walk_num]</code></td>
<td class="org-left">Value of the Jastrow factor</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>value_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Keep track of the date</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>gl</code></td>
<td class="org-left"><code>double[walk_num][4][elec_num]</code></td>
<td class="org-left">Gradient and Laplacian of the Jastrow factor</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>grad</code></td>
<td class="org-left"><code>double[walk_num][3][elec_num]</code></td>
<td class="org-left">Gradient of the Jastrow factor</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>value_date</code></td>
<td class="org-left"><code>uint64_t</code></td>
<td class="org-left">Keep track of the date</td>
<td class="org-left">&#xa0;</td>
</tr>
</tbody>
</table>
</div>

<div id="outline-container-org6402e24" class="outline-3">
<h3 id="org6402e24"><span class="section-number-3">3.1.</span> Data structure</h3>
<div class="outline-text-3" id="text-3-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #a020f0;">typedef</span> <span style="color: #a020f0;">struct</span> <span style="color: #228b22;">qmckl_jastrow_champ_struct</span>{
  <span style="color: #228b22;">int64_t</span> * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">lkpm_combined_index</span>;
  <span style="color: #228b22;">int64_t</span> * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">type_nucl_vector</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">asymp_jasa</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">asymp_jasa_pderiv</span>;
  <span style="color: #228b22;">double</span>             <span style="color: #a0522d;">asymp_jasb</span>[2];
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">asymp_jasb_pderiv</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">a_vector</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">b_vector</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">c_vector</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">c_vector_full</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">dtmp_c</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">ee_distance_rescaled</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">ee_distance_rescaled_gl</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">een_rescaled_e</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">een_rescaled_e_gl</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">een_rescaled_n</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">een_rescaled_n_gl</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">en_distance_rescaled</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">en_distance_rescaled_gl</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">factor_ee</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">factor_ee_gl</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">factor_ee_pderiv</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">factor_ee_gl_pderiv</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">factor_een</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">factor_een_gl</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">factor_een_grad</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">factor_een_pderiv</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">factor_een_gl_pderiv</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">factor_en</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">factor_en_gl</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">factor_en_pderiv</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">factor_en_gl_pderiv</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">rescale_factor_en</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">tmp_c</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">value</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">gl</span>;
  <span style="color: #228b22;">double</span>  * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">grad</span>;
  <span style="color: #228b22;">int64_t</span>   <span style="color: #a0522d;">aord_num</span>;
  <span style="color: #228b22;">int64_t</span>   <span style="color: #a0522d;">bord_num</span>;
  <span style="color: #228b22;">int64_t</span>   <span style="color: #a0522d;">cord_num</span>;
  <span style="color: #228b22;">int64_t</span>   <span style="color: #a0522d;">dim_c_vector</span>;
  <span style="color: #228b22;">int64_t</span>   <span style="color: #a0522d;">type_nucl_num</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">asymp_jasa_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">asymp_jasa_pderiv_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">asymp_jasb_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">asymp_jasb_pderiv_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">c_vector_full_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">dim_c_vector_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">dtmp_c_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">ee_distance_rescaled_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">ee_distance_rescaled_gl_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">een_rescaled_e_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">een_rescaled_e_gl_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">een_rescaled_n_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">een_rescaled_n_gl_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">en_distance_rescaled_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">en_distance_rescaled_gl_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">factor_ee_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">factor_ee_gl_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">factor_ee_pderiv_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">factor_ee_gl_pderiv_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">factor_een_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">factor_een_gl_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">factor_een_grad_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">factor_een_pderiv_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">factor_een_gl_pderiv_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">factor_en_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">factor_en_gl_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">factor_en_pderiv_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">factor_en_gl_pderiv_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">lkpm_combined_index_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">tmp_c_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">value_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">gl_date</span>;
  <span style="color: #228b22;">uint64_t</span>  <span style="color: #a0522d;">grad_date</span>;
  <span style="color: #228b22;">double</span>    <span style="color: #a0522d;">rescale_factor_ee</span>;
  <span style="color: #228b22;">int32_t</span>   <span style="color: #a0522d;">uninitialized</span>;
  <span style="color: #228b22;">int32_t</span>   <span style="color: #a0522d;">spin_independent</span>;
  <span style="color: #228b22;">bool</span>      <span style="color: #a0522d;">provided</span>;

} <span style="color: #228b22;">qmckl_jastrow_champ_struct</span>;
</pre>
</div>

<p>
The <code>uninitialized</code> integer contains one bit set to one for each
initialization function which has not been called. It becomes equal
to zero after all initialization functions have been called. The
struct is then initialized and <code>provided == true</code>.
Some values are initialized by default, and are not concerned by
this mechanism.
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_init_jastrow_champ</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_init_jastrow_champ</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>) {

  <span style="color: #a020f0;">if</span> (qmckl_context_check(context) == QMCKL_NULL_CONTEXT) {
    <span style="color: #a020f0;">return</span> <span style="color: #008b8b;">false</span>;
  }

  <span style="color: #228b22;">qmckl_context_struct</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">ctx</span> = (<span style="color: #228b22;">qmckl_context_struct</span>*) context;
  assert (ctx != <span style="color: #008b8b;">NULL</span>);

  ctx-&gt;jastrow_champ.uninitialized = (1 &lt;&lt; 11) - 1;

  /* <span style="color: #b22222;">Default values</span> */
  ctx-&gt;jastrow_champ.aord_num = -1;
  ctx-&gt;jastrow_champ.bord_num = -1;
  ctx-&gt;jastrow_champ.cord_num = -1;
  ctx-&gt;jastrow_champ.dim_c_vector = -1;
  ctx-&gt;jastrow_champ.type_nucl_num = -1;
  ctx-&gt;jastrow_champ.spin_independent = -1;

  <span style="color: #a020f0;">return</span> QMCKL_SUCCESS;
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org84a3010" class="outline-3">
<h3 id="org84a3010"><span class="section-number-3">3.2.</span> Initialization functions</h3>
<div class="outline-text-3" id="text-3-2">
<p>
To prepare for the Jastrow and its derivative, all the following functions need to be
called.
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>  <span style="color: #0000ff;">qmckl_set_jastrow_champ_rescale_factor_ee</span> (<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>, <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>  <span style="color: #a0522d;">kappa_ee</span>);
<span style="color: #228b22;">qmckl_exit_code</span>  <span style="color: #0000ff;">qmckl_set_jastrow_champ_rescale_factor_en</span> (<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>, <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">kappa_en</span>, <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
<span style="color: #228b22;">qmckl_exit_code</span>  <span style="color: #0000ff;">qmckl_set_jastrow_champ_aord_num</span>          (<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>, <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">aord_num</span>);
<span style="color: #228b22;">qmckl_exit_code</span>  <span style="color: #0000ff;">qmckl_set_jastrow_champ_bord_num</span>          (<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>, <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">bord_num</span>);
<span style="color: #228b22;">qmckl_exit_code</span>  <span style="color: #0000ff;">qmckl_set_jastrow_champ_cord_num</span>          (<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>, <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>);
<span style="color: #228b22;">qmckl_exit_code</span>  <span style="color: #0000ff;">qmckl_set_jastrow_champ_type_nucl_num</span>     (<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>, <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">type_nucl_num</span>);
<span style="color: #228b22;">qmckl_exit_code</span>  <span style="color: #0000ff;">qmckl_set_jastrow_champ_type_nucl_vector</span>  (<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>, <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span>* <span style="color: #a0522d;">type_nucl_vector</span>, <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
<span style="color: #228b22;">qmckl_exit_code</span>  <span style="color: #0000ff;">qmckl_set_jastrow_champ_a_vector</span>          (<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>, <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> * <span style="color: #a0522d;">a_vector</span>, <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
<span style="color: #228b22;">qmckl_exit_code</span>  <span style="color: #0000ff;">qmckl_set_jastrow_champ_b_vector</span>          (<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>, <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> * <span style="color: #a0522d;">b_vector</span>, <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
<span style="color: #228b22;">qmckl_exit_code</span>  <span style="color: #0000ff;">qmckl_set_jastrow_champ_c_vector</span>          (<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>, <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> * <span style="color: #a0522d;">c_vector</span>, <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
<span style="color: #228b22;">qmckl_exit_code</span>  <span style="color: #0000ff;">qmckl_set_jastrow_champ_spin_independent</span>  (<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>, <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int32_t</span> <span style="color: #a0522d;">spin_independent</span>);
</pre>
</div>

<p>
When the required information is completely entered, other data structures are
computed to accelerate the calculations. The intermediates factors
are precontracted using BLAS LEVEL 3 operations.
</p>
</div>

<div id="outline-container-orga22d881" class="outline-5">
<h5 id="orga22d881"><span class="section-number-5">3.2.0.1.</span> Fortran interface</h5>
<div class="outline-text-5" id="text-3-2-0-1">
<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_set_jastrow_champ_rescale_factor_ee</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        kappa_ee) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>  ::<span style="color: #a0522d;"> kappa_ee</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_set_jastrow_champ_rescale_factor_ee</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_set_jastrow_champ_rescale_factor_en</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        kappa_en, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>  ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(in) ::<span style="color: #a0522d;"> kappa_en(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_set_jastrow_champ_rescale_factor_en</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_set_jastrow_champ_aord_num</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        aord_num) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>  ::<span style="color: #a0522d;"> aord_num</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_set_jastrow_champ_aord_num</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_set_jastrow_champ_bord_num</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        bord_num) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>  ::<span style="color: #a0522d;"> bord_num</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_set_jastrow_champ_bord_num</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_set_jastrow_champ_cord_num</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        cord_num) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>  ::<span style="color: #a0522d;"> cord_num</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_set_jastrow_champ_cord_num</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_set_jastrow_champ_type_nucl_num</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        type_nucl_num) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>  ::<span style="color: #a0522d;"> type_nucl_num</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_set_jastrow_champ_type_nucl_num</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_set_jastrow_champ_type_nucl_vector</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        type_nucl_vector, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>  ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in) ::<span style="color: #a0522d;"> type_nucl_vector(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_set_jastrow_champ_type_nucl_vector</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_set_jastrow_champ_a_vector</span><span style="color: #a0522d;">(context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        a_vector, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>  ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(in) ::<span style="color: #a0522d;"> a_vector(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_set_jastrow_champ_a_vector</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_set_jastrow_champ_b_vector</span><span style="color: #a0522d;">(context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        b_vector, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>  ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(in) ::<span style="color: #a0522d;"> b_vector(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_set_jastrow_champ_b_vector</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_set_jastrow_champ_c_vector</span><span style="color: #a0522d;">(context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        c_vector, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>  ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(in) ::<span style="color: #a0522d;"> c_vector(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_set_jastrow_champ_c_vector</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_set_jastrow_champ_spin_independent</span><span style="color: #a0522d;">(context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        spin_independent) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span>(qmckl_context) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int32_t</span>),    <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>  ::<span style="color: #a0522d;"> spin_independent</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_set_jastrow_champ_spin_independent</span>

<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org86bb3d1" class="outline-3">
<h3 id="org86bb3d1"><span class="section-number-3">3.3.</span> Access functions</h3>
<div class="outline-text-3" id="text-3-3">
<p>
Along with these core functions, calculation of the jastrow factor
requires the following additional information to be set:
</p>


<p>
When all the data for the AOs have been provided, the following
function returns <code>true</code>.
</p>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">bool</span>      <span style="color: #0000ff;">qmckl_jastrow_champ_provided</span>           (<span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>);
</pre>
</div>
</div>

<div id="outline-container-orgd4db56d" class="outline-5">
<h5 id="orgd4db56d"><span class="section-number-5">3.3.0.1.</span> Fortran interface</h5>
<div class="outline-text-5" id="text-3-3-0-1">
<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_rescale_factor_ee</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        kappa_ee) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out) ::<span style="color: #a0522d;"> kappa_ee</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_rescale_factor_ee</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_rescale_factor_en</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        kappa_en, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> kappa_en(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_rescale_factor_en</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_aord_num</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        aord_num) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(out)             ::<span style="color: #a0522d;"> aord_num</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_aord_num</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_bord_num</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        bord_num) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(out)             ::<span style="color: #a0522d;"> bord_num</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_bord_num</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_cord_num</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        cord_num) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(out)             ::<span style="color: #a0522d;"> cord_num</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_cord_num</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_type_nucl_num</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        type_nucl_num) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(out)              ::<span style="color: #a0522d;"> type_nucl_num</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_type_nucl_num</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_type_nucl_vector</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        type_nucl_vector, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>      ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(out)            ::<span style="color: #a0522d;"> type_nucl_vector(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_type_nucl_vector</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_a_vector</span><span style="color: #a0522d;">(context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        a_vector, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> a_vector(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_a_vector</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_b_vector</span><span style="color: #a0522d;">(context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        b_vector, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>         ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)                 ::<span style="color: #a0522d;"> b_vector(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_b_vector</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_c_vector</span><span style="color: #a0522d;">(context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        c_vector, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>         ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)                 ::<span style="color: #a0522d;"> c_vector(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_c_vector</span>

   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_spin_independent</span><span style="color: #a0522d;">(context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        spin_independent) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span>(qmckl_context) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int32_t</span>),   <span style="color: #a020f0;">intent</span>(out)                ::<span style="color: #a0522d;"> spin_independent</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_spin_independent</span>

<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org3d4c47c" class="outline-2">
<h2 id="org3d4c47c"><span class="section-number-2">4.</span> Computation</h2>
<div class="outline-text-2" id="text-4">
<p>
The computed data is stored in the context so that it can be reused
by different kernels. To ensure that the data is valid, for each
computed data the date of the context is stored when it is computed.
To know if some data needs to be recomputed, we check if the date of
the dependencies are more recent than the date of the data to
compute. If it is the case, then the data is recomputed and the
current date is stored.
</p>
</div>

<div id="outline-container-org671fedc" class="outline-3">
<h3 id="org671fedc"><span class="section-number-3">4.1.</span> Electron-electron component</h3>
<div class="outline-text-3" id="text-4-1">
</div>
<div id="outline-container-org4f8890e" class="outline-4">
<h4 id="org4f8890e"><span class="section-number-4">4.1.1.</span> Asymptotic component</h4>
<div class="outline-text-4" id="text-4-1-1">
<p>
Calculate the asymptotic component <code>asymp_jasb</code> to be subtracted from the
electron-electron jastrow factor \(J_{\text{ee}}\). Two values are
computed. The first one is for parallel spin pairs, and the
second one for antiparallel spin pairs.
If the <code>spin_independent</code> variable is set to <code>1</code>, then
\(\delta^{\uparrow \downarrow}\) is always equal to one.
</p>

<p>
\[
   J_{\text{ee}}^{\infty} = \frac{\frac{1}{2}(1+\delta^{\uparrow \downarrow})\,b_1 \kappa_\text{ee}^{-1}}{1 + b_2\,
   \kappa_\text{ee}^{-1}} + \sum_{p=2}^{N_\text{ord}^b} b_{p+1}\, \kappa_\text{ee}^{-p}
   \]
</p>
</div>

<div id="outline-container-orgc5730f9" class="outline-5">
<h5 id="orgc5730f9"><span class="section-number-5">4.1.1.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-1-1-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_asymp_jasb</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                             <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">asymp_jasb</span>,
                             <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org0b5154e"></a>Fortran interface<br />
<div class="outline-text-6" id="text-4-1-1-1-1">
<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_asymp_jasb</span><span style="color: #a0522d;">(context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        asymp_jasb, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> asymp_jasb(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_asymp_jasb</span>
<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org05dee4f" class="outline-5">
<h5 id="org05dee4f"><span class="section-number-5">4.1.1.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-1-1-2">
<table id="org9dcc64c" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>bord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Order of the polynomial</td>
</tr>

<tr>
<td class="org-left"><code>b_vector</code></td>
<td class="org-left"><code>double[bord_num+1]</code></td>
<td class="org-left">in</td>
<td class="org-left">Values of b</td>
</tr>

<tr>
<td class="org-left"><code>rescale_factor_ee</code></td>
<td class="org-left"><code>double</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron coordinates</td>
</tr>

<tr>
<td class="org-left"><code>spin_independent</code></td>
<td class="org-left"><code>int32_t</code></td>
<td class="org-left">in</td>
<td class="org-left">If 1, same parameters for parallel and anti-parallel pairs</td>
</tr>

<tr>
<td class="org-left"><code>asymp_jasb</code></td>
<td class="org-left"><code>double[2]</code></td>
<td class="org-left">out</td>
<td class="org-left">Asymptotic value</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_asymp_jasb_doc</span>(context, <span style="color: #a020f0;">&amp;</span>
     bord_num, b_vector, rescale_factor_ee, spin_independent, asymp_jasb) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">bind</span>(C) <span style="color: #a020f0;">result</span>(info)
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>

  <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> bord_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> b_vector(bord_num+1)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> rescale_factor_ee</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int32_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> spin_independent</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> asymp_jasb(2)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, p</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> kappa_inv, x, asym_one</span>
  kappa_inv = 1.0d0 / rescale_factor_ee

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (bord_num &lt; 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  asym_one = b_vector(1) * kappa_inv / (1.0d0 + b_vector(2) * kappa_inv)
  <span style="color: #a020f0;">if</span> (spin_independent == 1) <span style="color: #a020f0;">then</span>
     asymp_jasb(:) = (/asym_one, asym_one/)
  <span style="color: #a020f0;">else</span>
     asymp_jasb(:) = (/0.5d0*asym_one, asym_one/)
  <span style="color: #a020f0;">end if</span>

  x = kappa_inv
  <span style="color: #a020f0;">do</span> p = 2, bord_num
     x = x * kappa_inv
     <span style="color: #a020f0;">do</span> i = 1, 2
        asymp_jasb(i) = asymp_jasb(i) + b_vector(p + 1) * x
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_asymp_jasb_doc</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_compute_jastrow_champ_asymp_jasb_hpc</span> (<span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                            <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">bord_num</span>,
                                            <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">b_vector</span>,
                                            <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">rescale_factor_ee</span>,
                                            <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int32_t</span> <span style="color: #a0522d;">spin_independent</span>,
                                            <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">asymp_jasb</span> )
{

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) {
    <span style="color: #a020f0;">return</span> QMCKL_INVALID_CONTEXT;
  }

  <span style="color: #a020f0;">if</span> (bord_num &lt; 0) {
    <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_2;
  }

  <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">kappa_inv</span> = 1.0 / rescale_factor_ee;
  <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">asym_one</span> = b_vector[0] * kappa_inv / (1.0 + b_vector[1] * kappa_inv);

  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">f</span> = 0.;
  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">x</span> = kappa_inv;
  <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">k</span> = 2; k &lt;= bord_num; ++k) {
    x *= kappa_inv;
    f = f + b_vector[k]*x;
  }

  asymp_jasb[0] = spin_independent == 1 ? asym_one + f : 0.5 * asym_one + f;
  asymp_jasb[1] = asym_one + f;

  <span style="color: #a020f0;">return</span> QMCKL_SUCCESS;
}
</pre>
</div>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_asymp_jasb</span> (<span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                                        <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">bord_num</span>,
                                                        <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">b_vector</span>,
                                                        <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">rescale_factor_ee</span>,
                                                        <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int32_t</span> <span style="color: #a0522d;">spin_independent</span>,
                                                        <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">asymp_jasb</span> )
{
<span style="color: #483d8b;">#ifdef</span> HAVE_HPC
  <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_asymp_jasb_hpc
<span style="color: #483d8b;">#else</span>
  <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_asymp_jasb_doc
<span style="color: #483d8b;">#endif</span>
    (context, bord_num, b_vector, rescale_factor_ee, spin_independent, asymp_jasb);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org59daaba" class="outline-4">
<h4 id="org59daaba"><span class="section-number-4">4.1.2.</span> Electron-electron rescaled distances</h4>
<div class="outline-text-4" id="text-4-1-2">
<p>
<code>ee_distance_rescaled</code> stores the matrix of the rescaled distances between all
pairs of electrons:
</p>

<p>
\[
    C_{ij} = \frac{ 1 - e^{-\kappa r_{ij}}}{\kappa}
    \]
</p>

<p>
where \(r_{ij}\) is the matrix of electron-electron distances.
</p>
</div>

<div id="outline-container-org8a2af70" class="outline-5">
<h5 id="org8a2af70"><span class="section-number-5">4.1.2.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-1-2-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_ee_distance_rescaled</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                                             <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">distance_rescaled</span>,
                                                             <span style="color: #228b22;">int64_t</span> <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgc5b1d8b" class="outline-5">
<h5 id="orgc5b1d8b"><span class="section-number-5">4.1.2.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-1-2-2">
<table id="orgbdd9373" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>rescale_factor_ee</code></td>
<td class="org-left"><code>double</code></td>
<td class="org-left">in</td>
<td class="org-left">Factor to rescale ee distances</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>coord</code></td>
<td class="org-left"><code>double[3][walk_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron coordinates</td>
</tr>

<tr>
<td class="org-left"><code>ee_distance</code></td>
<td class="org-left"><code>double[walk_num][elec_num][elec_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">Electron-electron rescaled distances</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_ee_distance_rescaled_doc</span>(context, <span style="color: #a020f0;">&amp;</span>
     elec_num, rescale_factor_ee, walk_num, <span style="color: #a020f0;">&amp;</span>
     coord, ee_distance_rescaled) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">bind</span>(C) <span style="color: #a020f0;">result</span>(info)
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>

  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> rescale_factor_ee</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> coord(elec_num,walk_num,3)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> ee_distance_rescaled(elec_num,elec_num,walk_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> k</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_3
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">do</span> k=1,walk_num
     info = qmckl_distance_rescaled(context, <span style="color: #8b2252;">'T'</span>, <span style="color: #8b2252;">'T'</span>, elec_num, elec_num, <span style="color: #a020f0;">&amp;</span>
          coord(1,k,1), elec_num * walk_num, <span style="color: #a020f0;">&amp;</span>
          coord(1,k,1), elec_num * walk_num, <span style="color: #a020f0;">&amp;</span>
          ee_distance_rescaled(1,1,k), elec_num, rescale_factor_ee)
     <span style="color: #a020f0;">if</span> (info /= QMCKL_SUCCESS) <span style="color: #a020f0;">then</span>
        <span style="color: #a020f0;">exit</span>
     <span style="color: #a020f0;">endif</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_ee_distance_rescaled_doc</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgcc23c9c" class="outline-4">
<h4 id="orgcc23c9c"><span class="section-number-4">4.1.3.</span> Electron-electron rescaled distance gradients and Laplacian with respect to electron coordinates</h4>
<div class="outline-text-4" id="text-4-1-3">
<p>
The rescaled distances, represented by \(C_{ij} = (1 - e^{-\kappa_\text{e} r_{ij}})/\kappa_\text{e}\)
are differentiated with respect to the electron coordinates.
This information is stored in the tensor
<code>ee_distance_rescaled_gl</code>. The initial three sequential
elements of this three-dimensional tensor provide the \(x\), \(y\), and \(z\)
direction derivatives, while the fourth index corresponds to the Laplacian.
</p>
</div>

<div id="outline-container-org115c79a" class="outline-5">
<h5 id="org115c79a"><span class="section-number-5">4.1.3.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-1-3-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_ee_distance_rescaled_gl</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                                                <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">distance_rescaled_gl</span>,
                                                                <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-org3f3cc61" class="outline-5">
<h5 id="org3f3cc61"><span class="section-number-5">4.1.3.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-1-3-2">
<table id="org7f20e06" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>rescale_factor_ee</code></td>
<td class="org-left"><code>double</code></td>
<td class="org-left">in</td>
<td class="org-left">Factor to rescale ee distances</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>coord</code></td>
<td class="org-left"><code>double[3][walk_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron coordinates</td>
</tr>

<tr>
<td class="org-left"><code>ee_distance_rescaled_gl</code></td>
<td class="org-left"><code>double[walk_num][elec_num][elec_num][4]</code></td>
<td class="org-left">out</td>
<td class="org-left">Electron-electron rescaled distance derivatives</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_ee_distance_rescaled_gl_doc</span>(context,  <span style="color: #a020f0;">&amp;</span>
     elec_num, rescale_factor_ee, walk_num, coord, ee_distance_rescaled_gl) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">bind</span>(C) <span style="color: #a020f0;">result</span>(info)
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>

  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> rescale_factor_ee</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> coord(elec_num,walk_num,3)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> ee_distance_rescaled_gl(4,elec_num,elec_num,walk_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> k</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_3
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">do</span> k=1,walk_num
     info = qmckl_distance_rescaled_gl(context, <span style="color: #8b2252;">'T'</span>, <span style="color: #8b2252;">'T'</span>, elec_num, elec_num, <span style="color: #a020f0;">&amp;</span>
          coord(1,k,1), elec_num*walk_num, <span style="color: #a020f0;">&amp;</span>
          coord(1,k,1), elec_num*walk_num, <span style="color: #a020f0;">&amp;</span>
          ee_distance_rescaled_gl(1,1,1,k), elec_num, rescale_factor_ee)
     <span style="color: #a020f0;">if</span> (info /= QMCKL_SUCCESS) <span style="color: #a020f0;">then</span>
        <span style="color: #a020f0;">exit</span>
     <span style="color: #a020f0;">endif</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_ee_distance_rescaled_gl_doc</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdb3488f" class="outline-4">
<h4 id="orgdb3488f"><span class="section-number-4">4.1.4.</span> Electron-electron component</h4>
<div class="outline-text-4" id="text-4-1-4">
<p>
Calculate the electron-electron jastrow component <code>factor_ee</code> using the <code>asymp_jasb</code>
component and the electron-electron rescaled distances <code>ee_distance_rescaled</code>.
If the <code>spin_independent</code> variable is set to <code>1</code>, then
\(\delta^{\uparrow \downarrow}\) is always equal to one.
</p>

<p>
\[
     f_\text{ee} = \sum_{i,j<i} \left[
     \frac{\delta_{ij}^{\uparrow\downarrow} B_0\, C_{ij}}{1 + B_1\,
     C_{ij}} + \sum_{k=2}^{n_\text{ord}} B_k\, C_{ij}^k - {J_{\text{ee}}^{\infty}}_{ij} \right]
   \]
</p>

<p>
\(\delta\) is the spin factor, \(B\) is the vector of \(b\) parameters,
\(C\) is the array of rescaled distances.
</p>

<p>
\(f_{\text{ee}}\) can be rewritten as:
</p>

<p>
\[
     f_\text{ee} = \frac{1}{2} \left[ \sum_{i,j} \frac{\delta_{ij}^{\uparrow\downarrow} B_0\, C_{ij}}{1 + B_1\, C_{ij}} + \sum_{i,j} \sum_{k=2}^{n_\text{ord}} B_k\, C_{ij}^k \right] - \left[ \frac{n_\uparrow (n_\uparrow-1) + n_\downarrow (n_\downarrow-1)}{2}\, J_{\text{ee}}^{\infty}}_{\uparrow \uparrow} + n_\uparrow\,n_\downarrow\, J_{\text{ee}}^{\infty}}_{\uparrow \downarrow} \right]
   \]
</p>
</div>

<div id="outline-container-org1f4ab0e" class="outline-5">
<h5 id="org1f4ab0e"><span class="section-number-5">4.1.4.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-1-4-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_ee</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                            <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_ee</span>,
                            <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="orga5014e3"></a>Fortran interface<br />
<div class="outline-text-6" id="text-4-1-4-1-1">
<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_ee</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        factor_ee, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> factor_ee(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_ee</span>
<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgcb70e7b" class="outline-5">
<h5 id="orgcb70e7b"><span class="section-number-5">4.1.4.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-1-4-2">
<table id="org924baa2" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>up_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of alpha electrons</td>
</tr>

<tr>
<td class="org-left"><code>bord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of coefficients</td>
</tr>

<tr>
<td class="org-left"><code>b_vector</code></td>
<td class="org-left"><code>double[bord_num+1]</code></td>
<td class="org-left">in</td>
<td class="org-left">List of coefficients</td>
</tr>

<tr>
<td class="org-left"><code>ee_distance_rescaled</code></td>
<td class="org-left"><code>double[walk_num][elec_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-electron distances</td>
</tr>

<tr>
<td class="org-left"><code>asymp_jasb</code></td>
<td class="org-left"><code>double[2]</code></td>
<td class="org-left">in</td>
<td class="org-left">Asymptotic value of the Jastrow</td>
</tr>

<tr>
<td class="org-left"><code>factor_ee</code></td>
<td class="org-left"><code>double[walk_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">\(f_{ee}\)</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_ee_doc</span>(context, <span style="color: #a020f0;">&amp;</span>
     walk_num, elec_num, up_num, bord_num, b_vector, <span style="color: #a020f0;">&amp;</span>
     ee_distance_rescaled, asymp_jasb, spin_independent, factor_ee) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">bind</span>(C) <span style="color: #a020f0;">result</span>(info)
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>

  <span style="color: #228b22;">integer</span> (qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>)    , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>)    , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>)    , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> up_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>)    , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> bord_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> )    , <span style="color: #a020f0;">intent</span>(in)        ::<span style="color: #a0522d;"> b_vector(bord_num+1)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> )    , <span style="color: #a020f0;">intent</span>(in)        ::<span style="color: #a0522d;"> ee_distance_rescaled(elec_num,elec_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> )    , <span style="color: #a020f0;">intent</span>(in)        ::<span style="color: #a0522d;"> asymp_jasb(2)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int32_t</span>)    , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> spin_independent</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> )    , <span style="color: #a020f0;">intent</span>(out)       ::<span style="color: #a0522d;"> factor_ee(walk_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                   ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, j, k, nw</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> x, xk</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_3
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (bord_num &lt; 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_4
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>



  <span style="color: #a020f0;">do</span> nw =1, walk_num

     factor_ee(nw) = 0.0d0
     <span style="color: #a020f0;">do</span> j=1,elec_num
        <span style="color: #a020f0;">do</span> i=1,j-1
           x = ee_distance_rescaled(i,j,nw)
           <span style="color: #a020f0;">if</span> (spin_independent == 1) <span style="color: #a020f0;">then</span>
              factor_ee(nw) = factor_ee(nw) + b_vector(1) * x / (1.d0 + b_vector(2) * x) - asymp_jasb(2)
           <span style="color: #a020f0;">else</span>
              <span style="color: #a020f0;">if</span> ( (j &lt;= up_num)<span style="color: #a020f0;">.or.</span>(i &gt; up_num) ) <span style="color: #a020f0;">then</span>
                 factor_ee(nw) = factor_ee(nw) + 0.5d0 * b_vector(1) * x / (1.d0 + b_vector(2) * x) - asymp_jasb(1)
              <span style="color: #a020f0;">else</span>
                 factor_ee(nw) = factor_ee(nw) + b_vector(1) * x / (1.d0 + b_vector(2) * x) - asymp_jasb(2)
              <span style="color: #a020f0;">endif</span>
           <span style="color: #a020f0;">endif</span>

           xk = x
           <span style="color: #a020f0;">do</span> k=2,bord_num
              xk = xk * x
              factor_ee(nw) = factor_ee(nw) + b_vector(k+1)* xk
           <span style="color: #a020f0;">end do</span>
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>

  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_ee_doc</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_ee_hpc</span> (<span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                           <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
                                           <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
                                           <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">up_num</span>,
                                           <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">bord_num</span>,
                                           <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">b_vector</span>,
                                           <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">ee_distance_rescaled</span>,
                                           <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">asymp_jasb</span>,
                                           <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int32_t</span> <span style="color: #a0522d;">spin_independent</span>,
                                           <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_ee</span> )
{

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) {
    <span style="color: #a020f0;">return</span> QMCKL_INVALID_CONTEXT;
  }

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) {
    <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_2;
  }

  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) {
    <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_3;
  }

  <span style="color: #a020f0;">if</span> (bord_num &lt; 0) {
    <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_4;
  }

  <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">dn_num</span> = elec_num - up_num;
  <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">fshift</span> = 0.5 * (<span style="color: #228b22;">double</span>) ((dn_num-1)*dn_num + (up_num-1)*up_num) * asymp_jasb[0] +
    (<span style="color: #228b22;">float</span>) (up_num*dn_num) * asymp_jasb[1];

<span style="color: #483d8b;">#ifdef</span> HAVE_OPENMP
<span style="color: #483d8b;">  #pragma</span> omp parallel
<span style="color: #483d8b;">#endif</span>
  <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">nw</span> = 0; nw &lt; walk_num; ++nw) {
    <span style="color: #228b22;">double</span> <span style="color: #a0522d;">result</span> = 0.;

    <span style="color: #228b22;">size_t</span> <span style="color: #a0522d;">ishift</span> = nw * elec_num * elec_num;

    <span style="color: #a020f0;">if</span> (spin_independent == 1) {

      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">j</span> = 0; j &lt; elec_num; ++j ) {
        <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">xj</span> = &amp;(ee_distance_rescaled[j * elec_num + ishift]);
        <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">i</span> = 0; i &lt; j ; ++i) {
          result = result + b_vector[0]*xj[i] / (1. + b_vector[1]*xj[i]);
        }
      }

    } <span style="color: #a020f0;">else</span> {

      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">j</span> = 0; j &lt; up_num; ++j ) {
        <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">xj</span> = &amp;(ee_distance_rescaled[j * elec_num + ishift]);
        <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">i</span> = 0; i &lt; j ; ++i) {
          result = result + 0.5 * b_vector[0]*xj[i] / (1. + b_vector[1]*xj[i]);
        }
      }

      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">j</span> = up_num ; j &lt; elec_num; ++j ) {
        <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">xj</span> = &amp;(ee_distance_rescaled[j * elec_num + ishift]);
        <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">i</span> = 0; i &lt; up_num; ++i) {
          result = result + b_vector[0]*xj[i] / (1. + b_vector[1]*xj[i]);
        }
        <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">i</span> = up_num ; i &lt; j ; ++i) {
          result = result + 0.5 * b_vector[0]*xj[i] / (1. + b_vector[1]*xj[i]);
        }

      }
    }

    result = result - fshift;

    <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">j</span>=0; j &lt; elec_num; ++j ) {
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">xj</span> = &amp;(ee_distance_rescaled[j * elec_num + ishift]);
      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">i</span>=0; i &lt; j ; ++i) {
        <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">x</span> = xj[i];
        <span style="color: #228b22;">double</span> <span style="color: #a0522d;">xk</span> = x;
        <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">k</span> = 2; k &lt;= bord_num; ++k) {
          xk *= x;
          result = result + b_vector[k] * xk;
        }

      }
    }
    factor_ee[nw] = result;
  }

  <span style="color: #a020f0;">return</span> QMCKL_SUCCESS;
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_ee</span> (<span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                       <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
                                       <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
                                       <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">up_num</span>,
                                       <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">bord_num</span>,
                                       <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">b_vector</span>,
                                       <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">ee_distance_rescaled</span>,
                                       <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">asymp_jasb</span>,
                                       <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int32_t</span> <span style="color: #a0522d;">spin_independent</span>,
                                       <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_ee</span> )
{

<span style="color: #483d8b;">#ifdef</span> HAVE_HPC
  <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_factor_ee_hpc
<span style="color: #483d8b;">#else</span>
  <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_factor_ee_doc
<span style="color: #483d8b;">#endif</span>
    (context, walk_num, elec_num, up_num, bord_num, b_vector,
     ee_distance_rescaled, asymp_jasb, spin_independent, factor_ee);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8e58a92" class="outline-4">
<h4 id="org8e58a92"><span class="section-number-4">4.1.5.</span> Derivative</h4>
<div class="outline-text-4" id="text-4-1-5">
<p>
The derivative of <code>factor_ee</code> is computed using the <code>ee_distance_rescaled</code> and
the electron-electron rescaled distances derivatives
<code>ee_distance_rescaled_gl</code>.
There are four components, the gradient which has 3 components in the \(x, y, z\)
directions and the laplacian as the last component.
</p>

<p>
\[ \nabla_i f_\text{ee} = \sum_{j\ne i}
 \left[\frac{\delta_{ij}^{\uparrow\downarrow} B_0\, \nabla_i
 C_{ij}}{(1 + B_1\, C_{ij})^2} + \sum^{n_\text{ord}}_{k=2}
 B_k\, k\, C_{ij}^{k-1} \nabla C_{ij} \right] \]
</p>

<p>
\[ \Delta_i f_\text{ee} = \sum_{j \ne i}
 \left[ \delta_{ij}^{\uparrow\downarrow} B_0
 \left(\frac{ \Delta_i C_{ij}}{(1 + B_1\, C_{ij})^2} -\frac{2\,B_1
 \left(\nabla_i C_{ij}\right)^2 }{(1 + B_1\, C_{ij})^3} \right) + \sum^{n_\text{ord}}_{k=2}
 B_k\, k\, \left((k-1)\, C_{ij}^{k-2} \left(\nabla_i C_{ij}\right)^2 + C_{ij}^{k-1} \Delta_i C_{ij} \right) \right] \]
</p>
</div>

<div id="outline-container-org2b6c2aa" class="outline-5">
<h5 id="org2b6c2aa"><span class="section-number-5">4.1.5.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-1-5-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_ee_gl</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                    <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_ee_gl</span>,
                                    <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="orgad61460"></a>Fortran interface<br />
<div class="outline-text-6" id="text-4-1-5-1-1">
<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_ee_gl</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        factor_ee_gl, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> factor_ee_gl(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_ee_gl</span>
<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org1e28694" class="outline-5">
<h5 id="org1e28694"><span class="section-number-5">4.1.5.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-1-5-2">
<table id="org72cc8f5" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>up_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of alpha electrons</td>
</tr>

<tr>
<td class="org-left"><code>bord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of coefficients</td>
</tr>

<tr>
<td class="org-left"><code>b_vector</code></td>
<td class="org-left"><code>double[bord_num+1]</code></td>
<td class="org-left">in</td>
<td class="org-left">List of coefficients</td>
</tr>

<tr>
<td class="org-left"><code>ee_distance_rescaled</code></td>
<td class="org-left"><code>double[walk_num][elec_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-electron distances</td>
</tr>

<tr>
<td class="org-left"><code>ee_distance_rescaled_gl</code></td>
<td class="org-left"><code>double[walk_num][elec_num][elec_num][4]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-electron distances</td>
</tr>

<tr>
<td class="org-left"><code>spin_independent</code></td>
<td class="org-left"><code>int32_t</code></td>
<td class="org-left">in</td>
<td class="org-left">If 1, same parameters for parallel and antiparallel spins</td>
</tr>

<tr>
<td class="org-left"><code>factor_ee_gl</code></td>
<td class="org-left"><code>double[walk_num][4][elec_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">Electron-electron distances</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_ee_gl_doc</span>( <span style="color: #a020f0;">&amp;</span>
     context, walk_num, elec_num, up_num, bord_num, <span style="color: #a020f0;">&amp;</span>
     b_vector, ee_distance_rescaled, ee_distance_rescaled_gl,  <span style="color: #a020f0;">&amp;</span>
     spin_independent, factor_ee_gl) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">bind</span>(C) <span style="color: #a020f0;">result</span>(info)
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>

  <span style="color: #228b22;">integer</span> (qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> up_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> bord_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> b_vector(bord_num+1)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> ee_distance_rescaled(elec_num,elec_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> ee_distance_rescaled_gl(4,elec_num,elec_num,walk_num)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int32_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> spin_independent</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> factor_ee_gl(elec_num,4,walk_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, j, k, nw, ii</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> x, x1, kf</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> denom, invdenom, invdenom2, f</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> grad_c2</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> dx(4)</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_3
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (bord_num &lt; 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_4
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> ((spin_independent &lt; 0)<span style="color: #a020f0;">.or.</span>(spin_independent &gt; 1)) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_8
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">do</span> nw =1, walk_num
     factor_ee_gl(:,:,nw) = 0.0d0

     <span style="color: #a020f0;">do</span> j = 1, elec_num
        <span style="color: #a020f0;">do</span> i = 1, elec_num
           <span style="color: #a020f0;">if</span> (i == j) <span style="color: #a020f0;">cycle</span>

           x = ee_distance_rescaled(i,j,nw)

           denom         = 1.0d0 + b_vector(2) * x
           invdenom      = 1.0d0 / denom
           invdenom2     = invdenom * invdenom

           dx(1) = ee_distance_rescaled_gl(1, i, j, nw)
           dx(2) = ee_distance_rescaled_gl(2, i, j, nw)
           dx(3) = ee_distance_rescaled_gl(3, i, j, nw)
           dx(4) = ee_distance_rescaled_gl(4, i, j, nw)

           grad_c2 = dx(1)*dx(1) + dx(2)*dx(2) + dx(3)*dx(3)

           <span style="color: #a020f0;">if</span> (spin_independent == 1) <span style="color: #a020f0;">then</span>
              f = b_vector(1) * invdenom2
           <span style="color: #a020f0;">else</span>
              <span style="color: #a020f0;">if</span>((i &lt;= up_num <span style="color: #a020f0;">.and.</span> j &lt;= up_num ) <span style="color: #a020f0;">.or.</span> (i &gt;  up_num <span style="color: #a020f0;">.and.</span> j &gt;  up_num)) <span style="color: #a020f0;">then</span>
                 f = 0.5d0 * b_vector(1) * invdenom2
              <span style="color: #a020f0;">else</span>
                 f = b_vector(1) * invdenom2
              <span style="color: #a020f0;">end if</span>
           <span style="color: #a020f0;">end if</span>

           factor_ee_gl(i,1,nw) = factor_ee_gl(i,1,nw) + f * dx(1)
           factor_ee_gl(i,2,nw) = factor_ee_gl(i,2,nw) + f * dx(2)
           factor_ee_gl(i,3,nw) = factor_ee_gl(i,3,nw) + f * dx(3)
           factor_ee_gl(i,4,nw) = factor_ee_gl(i,4,nw) <span style="color: #a020f0;">&amp;</span>
                + f * (dx(4) - 2.d0 * b_vector(2) * grad_c2 * invdenom)


           kf = 2.d0
           x1 = x
           x = 1.d0
           <span style="color: #a020f0;">do</span> k=2, bord_num
              f = b_vector(k+1) * kf * x
              factor_ee_gl(i,1,nw) = factor_ee_gl(i,1,nw) + f * x1 * dx(1)
              factor_ee_gl(i,2,nw) = factor_ee_gl(i,2,nw) + f * x1 * dx(2)
              factor_ee_gl(i,3,nw) = factor_ee_gl(i,3,nw) + f * x1 * dx(3)
              factor_ee_gl(i,4,nw) = factor_ee_gl(i,4,nw) <span style="color: #a020f0;">&amp;</span>
                   + f * (x1 * dx(4) + (kf-1.d0) * grad_c2)
              x = x*x1
              kf = kf + 1.d0
           <span style="color: #a020f0;">end do</span>

        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>

  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_ee_gl_doc</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_ee_gl_hpc</span>(<span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                             <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
                                             <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
                                             <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">up_num</span>,
                                             <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">bord_num</span>,
                                             <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">b_vector</span>,
                                             <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">ee_distance_rescaled</span>,
                                             <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">ee_distance_rescaled_gl</span>,
                                             <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int32_t</span> <span style="color: #a0522d;">spin_independent</span>,
                                             <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_ee_gl</span> )
{

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">return</span> QMCKL_INVALID_CONTEXT;
  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_2;
  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_3;
  <span style="color: #a020f0;">if</span> (up_num &lt;= 0) <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_4;
  <span style="color: #a020f0;">if</span> (bord_num &lt; 0) <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_5;
  <span style="color: #a020f0;">if</span> (b_vector == <span style="color: #008b8b;">NULL</span>) <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_6;
  <span style="color: #a020f0;">if</span> (ee_distance_rescaled == <span style="color: #008b8b;">NULL</span>) <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_7;
  <span style="color: #a020f0;">if</span> (ee_distance_rescaled_gl == <span style="color: #008b8b;">NULL</span>) <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_8;
  <span style="color: #a020f0;">if</span> (spin_independent &amp; (<span style="color: #228b22;">int32_t</span>) (-2)) <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_8;
  <span style="color: #a020f0;">if</span> (factor_ee_gl == <span style="color: #008b8b;">NULL</span>) <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_9;

  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">kf</span>[bord_num+1];
  <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">k</span>=0 ; k&lt;=bord_num ; ++k) {
    kf[k] = (<span style="color: #228b22;">double</span>) k;
  }

<span style="color: #483d8b;">#ifdef</span> HAVE_OPENMP
<span style="color: #483d8b;">#pragma</span> omp parallel <span style="color: #a020f0;">for</span>
<span style="color: #483d8b;">#endif</span>
  <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">nw</span> = 0; nw &lt; walk_num; ++nw) {
    <span style="color: #228b22;">double</span> <span style="color: #a0522d;">xk</span>[bord_num+1];
    <span style="color: #228b22;">bool</span> <span style="color: #a0522d;">touched</span> = <span style="color: #008b8b;">false</span>;

    <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">j</span> = 0; j &lt; elec_num; ++j) {
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">dxj</span> = &amp;ee_distance_rescaled_gl[4*elec_num*(j+nw*elec_num)];
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>*  <span style="color: #a0522d;">xj</span> = &amp;ee_distance_rescaled   [  elec_num*(j+nw*elec_num)];

      <span style="color: #228b22;">double</span> * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">factor_ee_gl_0</span> = &amp;(factor_ee_gl[nw*elec_num*4]);
      <span style="color: #228b22;">double</span> * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">factor_ee_gl_1</span> = factor_ee_gl_0 + elec_num;
      <span style="color: #228b22;">double</span> * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">factor_ee_gl_2</span> = factor_ee_gl_1 + elec_num;
      <span style="color: #228b22;">double</span> * <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">factor_ee_gl_3</span> = factor_ee_gl_2 + elec_num;

      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">i</span> = 0; i &lt; elec_num; ++i) {
        <span style="color: #a020f0;">if</span> (j == i) {
          <span style="color: #a020f0;">if</span> (j == 0) {
            factor_ee_gl_0[i] = 0.0;
            factor_ee_gl_1[i] = 0.0;
            factor_ee_gl_2[i] = 0.0;
            factor_ee_gl_3[i] = 0.0;
          }
          <span style="color: #a020f0;">continue</span>;
        }

        <span style="color: #228b22;">double</span> <span style="color: #a0522d;">x</span> = xj[i];

        <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">denom</span>      = 1.0 + b_vector[1]*x;
        <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">invdenom</span>   = 1.0  / denom;
        <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">invdenom2</span>  = invdenom * invdenom;

        <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">dx</span> = dxj + 4*i;

        <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">grad_c2</span> = dx[0]*dx[0] + dx[1]*dx[1] + dx[2]*dx[2];

        <span style="color: #228b22;">double</span> <span style="color: #a0522d;">f</span> = b_vector[0] * invdenom2;
        <span style="color: #a020f0;">if</span> ((spin_independent == 0) &amp;&amp; (
            ((i &lt;  up_num) &amp;&amp; (j &lt;  up_num)) ||
            ((i &gt;= up_num) &amp;&amp; (j &gt;= up_num))) ) {
          f *= 0.5;
        }

        <span style="color: #a020f0;">if</span> (touched) {
          factor_ee_gl_0[i] = factor_ee_gl_0[i] + f*dx[0];
          factor_ee_gl_1[i] = factor_ee_gl_1[i] + f*dx[1];
          factor_ee_gl_2[i] = factor_ee_gl_2[i] + f*dx[2];
          factor_ee_gl_3[i] = factor_ee_gl_3[i] + f*dx[3];
        } <span style="color: #a020f0;">else</span> {
          factor_ee_gl_0[i] = f*dx[0];
          factor_ee_gl_1[i] = f*dx[1];
          factor_ee_gl_2[i] = f*dx[2];
          factor_ee_gl_3[i] = f*dx[3];
        }
        factor_ee_gl_3[i] = factor_ee_gl_3[i] - f*grad_c2*invdenom*2.0 * b_vector[1];

        xk[0] = 1.0;
        <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">k</span>=1 ; k&lt;= bord_num ; ++k) {
          xk[k] = xk[k-1]*x;
        }

        <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">k</span>=2 ; k&lt;= bord_num ; ++k) {
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">f1</span> = b_vector[k] * kf[k] * xk[k-2];
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">f2</span> = f1*xk[1];
          factor_ee_gl_0[i] = factor_ee_gl_0[i] + f2*dx[0];
          factor_ee_gl_1[i] = factor_ee_gl_1[i] + f2*dx[1];
          factor_ee_gl_2[i] = factor_ee_gl_2[i] + f2*dx[2];
          factor_ee_gl_3[i] = factor_ee_gl_3[i] + f2*dx[3];
          factor_ee_gl_3[i] = factor_ee_gl_3[i] + f1*kf[k-1]*grad_c2;
        }
      }
      touched = <span style="color: #008b8b;">true</span>;
    }
    <span style="color: #a020f0;">if</span> (!touched) {
      memset(&amp;(factor_ee_gl[nw*4*elec_num]), 0, elec_num*4*<span style="color: #a020f0;">sizeof</span>(<span style="color: #228b22;">double</span>));
    }
  }

  <span style="color: #a020f0;">return</span> QMCKL_SUCCESS;
}
</pre>
</div>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_ee_gl_hpc</span> (<span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">up_num</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">bord_num</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">b_vector</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">ee_distance_rescaled</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">ee_distance_rescaled_gl</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int32_t</span> <span style="color: #a0522d;">spin_independent</span>,
                                              <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_ee_gl</span> );

</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_ee_gl_doc</span> (<span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">up_num</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">bord_num</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">b_vector</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">ee_distance_rescaled</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">ee_distance_rescaled_gl</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int32_t</span> <span style="color: #a0522d;">spin_independent</span>,
                                              <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_ee_gl</span> );
</pre>
</div>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_ee_gl</span> (<span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
                                          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
                                          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">up_num</span>,
                                          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">bord_num</span>,
                                          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">b_vector</span>,
                                          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">ee_distance_rescaled</span>,
                                          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">ee_distance_rescaled_gl</span>,
                                          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int32_t</span> <span style="color: #a0522d;">spin_independent</span>,
                                          <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_ee_gl</span> )
{
<span style="color: #483d8b;">#ifdef</span> HAVE_HPC
  <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_factor_ee_gl_hpc
<span style="color: #483d8b;">#else</span>
    <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_factor_ee_gl_doc
<span style="color: #483d8b;">#endif</span>
    (context, walk_num, elec_num, up_num, bord_num, b_vector,
     ee_distance_rescaled, ee_distance_rescaled_gl, spin_independent, factor_ee_gl );
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org9585eee" class="outline-4">
<h4 id="org9585eee"><span class="section-number-4">4.1.6.</span> Parameter Derivative of the Asymptotic component</h4>
<div class="outline-text-4" id="text-4-1-6">
<p>
Calculate the derivatives of the asymptotic component w.r.t. the
jastrow parameters <code>asymp_jasb_pderiv</code> to be subtracted from the
electron-electron jastrow factor \(J_{\text{ee}}\) derivatives. Two values are
computed. The first one is for parallel spin pairs, and the
second one for antiparallel spin pairs.
If the <code>spin_independent</code> variable is set to <code>1</code>, then
\(\delta^{\uparrow \downarrow}\) is always equal to one.
</p>

<p>
\[
   J_{\text{ee}}^{\infty} = \frac{\frac{1}{2}(1+\delta^{\uparrow \downarrow})\,B_0 \kappa_\text{ee}^{-1}}{1 + B_1\,
   \kappa_\text{ee}^{-1}} + \sum_{p=2}^{N_\text{ord}^B} B_{p+1}\, \kappa_\text{ee}^{-p}
   \]
</p>

<p>
\[ \partial_{B_0} J_{\text{ee}}^\infty = \frac{\frac{1}{2}(1 + \delta^{\uparrow\downarrow}_{ij})
   \kappa_{\text{ee}}^{-1}}{1 + B_1 \kappa_{\text{ee}}^{-1}} \]
</p>

<p>
\[ \partial_{B_1}J_{\text{ee}}^\infty =  -\frac{ \frac{1}{2}(1 + \delta_{ij}) \kappa_{\text{ee}}^{-2}}
   {(1 + B_1 \kappa_{\text{ee}}^{-1})^2 } \]
</p>

<p>
\[ \partial_{B_k} J_{\text{ee}}^\infty = \kappa_{\text{ee}}^{-(k-1)} \] for \(k > 1\)
</p>
</div>


<div id="outline-container-org23bffe7" class="outline-5">
<h5 id="org23bffe7"><span class="section-number-5">4.1.6.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-1-6-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_asymp_jasb_pderiv</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                          <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">asymp_jasb_pderiv</span>,
                                          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="orgaa07eaf"></a>Fortran interface<br />
<div class="outline-text-6" id="text-4-1-6-1-1">
<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_asymp_jasb_pderiv</span><span style="color: #a0522d;">(context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        asymp_jasb_pderiv, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> asymp_jasb_pderiv(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_asymp_jasb_pderiv</span>
<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org94ff431" class="outline-5">
<h5 id="org94ff431"><span class="section-number-5">4.1.6.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-1-6-2">
<table id="org4979e31" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>bord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Order of the polynomial</td>
</tr>

<tr>
<td class="org-left"><code>b_vector</code></td>
<td class="org-left"><code>double[bord_num+1]</code></td>
<td class="org-left">in</td>
<td class="org-left">Values of b</td>
</tr>

<tr>
<td class="org-left"><code>rescale_factor_ee</code></td>
<td class="org-left"><code>double</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron coordinates</td>
</tr>

<tr>
<td class="org-left"><code>spin_independent</code></td>
<td class="org-left"><code>int32_t</code></td>
<td class="org-left">in</td>
<td class="org-left">If 1, same parameters for parallel and anti-parallel pairs</td>
</tr>

<tr>
<td class="org-left"><code>asymp_jasb</code></td>
<td class="org-left"><code>double[2][bord_num+1]</code></td>
<td class="org-left">out</td>
<td class="org-left">Asymptotic value</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_asymp_jasb_pderiv_doc</span>(context, <span style="color: #a020f0;">&amp;</span>
     bord_num, b_vector, rescale_factor_ee, spin_independent, asymp_jasb_pderiv) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">bind</span>(C) <span style="color: #a020f0;">result</span>(info)
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>

  <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> bord_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> b_vector(bord_num+1)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> rescale_factor_ee</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int32_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> spin_independent</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> asymp_jasb_pderiv(bord_num+1,2)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, p</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> kappa_inv, x, asym_one, asym_two</span>
  kappa_inv = 1.0d0 / rescale_factor_ee

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (bord_num &lt; 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  asym_one = kappa_inv / (1.0d0 + b_vector(2) * kappa_inv)
  asym_two = -b_vector(1) * kappa_inv**2 / (1.0d0 + b_vector(2) * kappa_inv)**2
  <span style="color: #a020f0;">if</span> (spin_independent == 1) <span style="color: #a020f0;">then</span>
     asymp_jasb_pderiv(1,:) = (/asym_one, asym_one/)
     asymp_jasb_pderiv(2,:) = (/asym_two, asym_two/)
  <span style="color: #a020f0;">else</span>
     asymp_jasb_pderiv(1,:) = (/0.5d0*asym_one, asym_one/)
     asymp_jasb_pderiv(2,:) = (/0.5d0*asym_two, asym_two/)
  <span style="color: #a020f0;">end if</span>

  x = kappa_inv
  <span style="color: #a020f0;">do</span> p = 2, bord_num
     x = x * kappa_inv
     <span style="color: #a020f0;">do</span> i = 1, 2
        asymp_jasb_pderiv(p+1,i) = x
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_asymp_jasb_pderiv_doc</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd8a8f7f" class="outline-4">
<h4 id="orgd8a8f7f"><span class="section-number-4">4.1.7.</span> Parameter Derivative</h4>
<div class="outline-text-4" id="text-4-1-7">
<p>
The derivative of <code>factor_ee</code> with respect to the jastrow parameters
<code>b_vector</code> is computed. These derivatives are computed fron the
<code>ee_rescaled_distances</code> and the parameter derivatives of the asymptotic part
<code>asymp_jasb_pderiv</code>. If <code>spin_independent</code> is set to <code>1</code>, then
\(\delta^{\uparrow \downarrow}\) is always equal to 1.
</p>


<p>
\[ \partial_{B_0} f_\text{ee} = \sum_{j,i<j}
   \frac{ \frac{1}{2}(1 + \delta^{\uparrow \downarrow}_{ij}) r_{ij} }{ 1 + B_1
   r_{ij} } - \partial_{B_0} J^{\infty}_\text{ee} \]
</p>

<p>
\[ \partial_{B_1} f_\text{ee} = -\sum_{j,i<j}
   \frac{ \frac{1}{2}(1 + \delta^{\uparrow \downarrow}_{ij}) B_0 r_{ij}^2 }{ (1 + B_1
   r_{ij})^2 } - \partial_{B_1} J^{\infty}_\text{ee} \]
</p>

<p>
\[ \partial_{B_k} f_\text{ee} = \sum_{j, i<j} r_{ij}^{k} - \partial_{B_k}
   J^{\infty}_\text{ee} \quad \text{for} \quad k > 1 \]
</p>
</div>

<div id="outline-container-org4128caf" class="outline-5">
<h5 id="org4128caf"><span class="section-number-5">4.1.7.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-1-7-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_ee_pderiv</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                         <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_ee_pderiv</span>,
                                         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_ee_pderiv</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        factor_ee_pderiv, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> factor_ee_pderiv(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_ee_pderiv</span>
<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org1f4ec04" class="outline-5">
<h5 id="org1f4ec04"><span class="section-number-5">4.1.7.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-1-7-2">
<table id="org1a9237e" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>up_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of alpha electrons</td>
</tr>

<tr>
<td class="org-left"><code>bord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of coefficients</td>
</tr>

<tr>
<td class="org-left"><code>b_vector</code></td>
<td class="org-left"><code>double[bord_num+1]</code></td>
<td class="org-left">in</td>
<td class="org-left">List of coefficients</td>
</tr>

<tr>
<td class="org-left"><code>ee_distance_rescaled</code></td>
<td class="org-left"><code>double[walk_num][elec_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-electron distances</td>
</tr>

<tr>
<td class="org-left"><code>asymp_jasb_pderiv</code></td>
<td class="org-left"><code>double[2][bord_num+1]</code></td>
<td class="org-left">in</td>
<td class="org-left">Asymptotic value of the Jastrow</td>
</tr>

<tr>
<td class="org-left"><code>spin_independent</code></td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
<td class="org-left">&#xa0;</td>
</tr>

<tr>
<td class="org-left"><code>factor_ee_pderiv</code></td>
<td class="org-left"><code>double[bord_num+1]</code></td>
<td class="org-left">out</td>
<td class="org-left">\(\partial_{B_i} f_{ee}\)</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_ee_pderiv_doc</span>(context, <span style="color: #a020f0;">&amp;</span>
     walk_num, elec_num, up_num, bord_num, b_vector, <span style="color: #a020f0;">&amp;</span>
     ee_distance_rescaled, asymp_jasb_pderiv, spin_independent, factor_ee_pderiv) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">bind</span>(C) <span style="color: #a020f0;">result</span>(info)

  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>

  <span style="color: #228b22;">integer</span> (qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>)    , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>)    , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>)    , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> up_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>)    , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> bord_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> )    , <span style="color: #a020f0;">intent</span>(in)        ::<span style="color: #a0522d;"> b_vector(bord_num+1)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> )    , <span style="color: #a020f0;">intent</span>(in)        ::<span style="color: #a0522d;"> ee_distance_rescaled(elec_num,elec_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> )    , <span style="color: #a020f0;">intent</span>(in)        ::<span style="color: #a0522d;"> asymp_jasb_pderiv(bord_num+1, 2)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int32_t</span>)    , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> spin_independent</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> )    , <span style="color: #a020f0;">intent</span>(out)       ::<span style="color: #a0522d;"> factor_ee_pderiv(bord_num+1)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                   ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, j, k, nw</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> x, xk</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_3
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (bord_num &lt; 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_4
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>


  factor_ee_pderiv = 0.0d0

  <span style="color: #a020f0;">do</span> nw = 1, walk_num

     <span style="color: #a020f0;">do</span> j = 1, elec_num
        <span style="color: #a020f0;">do</span> i = 1, j - 1

           x = ee_distance_rescaled(i,j,nw)

           <span style="color: #a020f0;">if</span> (spin_independent == 1) <span style="color: #a020f0;">then</span>
              factor_ee_pderiv(1) = factor_ee_pderiv(1) + x / (1.d0 + b_vector(2) * x) - asymp_jasb_pderiv(1,2)
              factor_ee_pderiv(2) = factor_ee_pderiv(2) - b_vector(1) * x**2 / (1.d0 + b_vector(2) * x)**2 - asymp_jasb_pderiv(2,2)
           <span style="color: #a020f0;">else</span>
              <span style="color: #a020f0;">if</span> ( (j &lt;= up_num)<span style="color: #a020f0;">.or.</span>(i &gt; up_num) ) <span style="color: #a020f0;">then</span>
                 factor_ee_pderiv(1) = factor_ee_pderiv(1) + 0.5d0 * x / (1.d0 + b_vector(2) * x) - asymp_jasb_pderiv(1,1)
                 factor_ee_pderiv(2) = factor_ee_pderiv(2) - 0.5d0 * b_vector(1) * x**2 / (1.d0 + b_vector(2) * x)**2 <span style="color: #a020f0;">&amp;</span>
                      - asymp_jasb_pderiv(2,1)
              <span style="color: #a020f0;">else</span>
                 factor_ee_pderiv(1) = factor_ee_pderiv(1) + x / (1.d0 + b_vector(2) * x) - asymp_jasb_pderiv(2,1)
                 factor_ee_pderiv(2) = factor_ee_pderiv(2) - b_vector(1) * x**2 / (1.d0 + b_vector(2) * x)**2 <span style="color: #a020f0;">&amp;</span>
                      - asymp_jasb_pderiv(2,2)
              <span style="color: #a020f0;">endif</span>
           <span style="color: #a020f0;">endif</span>
           xk = x
           <span style="color: #a020f0;">do</span> k = 2, bord_num
              xk = xk * x
              factor_ee_pderiv(k+1) = factor_ee_pderiv(k+1) + xk - asymp_jasb_pderiv(k+1, 1)
           <span style="color: #a020f0;">end do</span>
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

  factor_ee_pderiv = factor_ee_pderiv / <span style="color: #a020f0;">dble</span>(walk_num)

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_ee_pderiv_doc</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_ee_pderiv</span> (<span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">up_num</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">bord_num</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">b_vector</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">ee_distance_rescaled</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">asymp_jasb_pderiv</span>,
                                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int32_t</span> <span style="color: #a0522d;">spin_independent</span>,
                                              <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_ee_pderiv</span> )
{
    <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_factor_ee_pderiv_doc
    (context, walk_num, elec_num, up_num, bord_num, b_vector,
     ee_distance_rescaled, asymp_jasb_pderiv, spin_independent, factor_ee_pderiv );
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org6762315" class="outline-4">
<h4 id="org6762315"><span class="section-number-4">4.1.8.</span> Parameter Derivative of the gradient and Laplacian</h4>
<div class="outline-text-4" id="text-4-1-8">
<p>
The derivative of <code>factor_ee_gl</code> with respect to all the jastrow parameters C is computed and stored into <code>factor_ee_gl_pderiv</code>
</p>
</div>

<div id="outline-container-orgf569028" class="outline-5">
<h5 id="orgf569028"><span class="section-number-5">4.1.8.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-1-8-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_ee_gl_pderiv</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                            <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_ee_gl_pderiv</span>,
                                            <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="orgdf417fb"></a>Fortran interface<br />
<div class="outline-text-6" id="text-4-1-8-1-1">
<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_ee_gl_pderiv</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        factor_ee_gl_pderiv, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> factor_ee_gl_pderiv(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_ee_gl_pderiv</span>
<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orged03fc8" class="outline-5">
<h5 id="orged03fc8"><span class="section-number-5">4.1.8.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-1-8-2">
<table id="org46b18f2" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>up_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of alpha electrons</td>
</tr>

<tr>
<td class="org-left"><code>bord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of coefficients</td>
</tr>

<tr>
<td class="org-left"><code>b_vector</code></td>
<td class="org-left"><code>double[bord_num+1]</code></td>
<td class="org-left">in</td>
<td class="org-left">List of coefficients</td>
</tr>

<tr>
<td class="org-left"><code>ee_distance_rescaled</code></td>
<td class="org-left"><code>double[walk_num][elec_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-electron distances</td>
</tr>

<tr>
<td class="org-left"><code>ee_distance_rescaled_gl</code></td>
<td class="org-left"><code>double[walk_num][elec_num][elec_num][4]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-electron distances</td>
</tr>

<tr>
<td class="org-left"><code>spin_independent</code></td>
<td class="org-left"><code>int32_t</code></td>
<td class="org-left">in</td>
<td class="org-left">If 1, same parameters for parallel and antiparallel spins</td>
</tr>

<tr>
<td class="org-left"><code>factor_ee_gl_pderiv</code></td>
<td class="org-left"><code>double[4][elec_num][bord_num+1]</code></td>
<td class="org-left">out</td>
<td class="org-left">Electron-electron distances</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_ee_gl_pderiv_doc</span>( <span style="color: #a020f0;">&amp;</span>
     context, walk_num, elec_num, up_num, bord_num, <span style="color: #a020f0;">&amp;</span>
     b_vector, ee_distance_rescaled, ee_distance_rescaled_gl,  <span style="color: #a020f0;">&amp;</span>
     spin_independent, factor_ee_gl_pderiv) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">bind</span>(C) <span style="color: #a020f0;">result</span>(info)
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>

  <span style="color: #228b22;">integer</span> (qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> up_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> bord_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> b_vector(bord_num+1)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> ee_distance_rescaled(elec_num,elec_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> ee_distance_rescaled_gl(4,elec_num,elec_num,walk_num)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int32_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> spin_independent</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> factor_ee_gl_pderiv(4,elec_num,bord_num+1)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, j, k, nw, ii</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> x, x1, kf</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> denom, invdenom, invdenom2, invdenom3, f, f1, f2</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> grad_c2</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> dx(4)</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_3
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (bord_num &lt; 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_4
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> ((spin_independent &lt; 0)<span style="color: #a020f0;">.or.</span>(spin_independent &gt; 1)) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_8
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  factor_ee_gl_pderiv(:,:,:) = 0.0d0
  <span style="color: #a020f0;">do</span> nw = 1, walk_num
     <span style="color: #a020f0;">do</span> j = 1, elec_num
        <span style="color: #a020f0;">do</span> i = 1, elec_num
           <span style="color: #a020f0;">if</span> (i == j) <span style="color: #a020f0;">cycle</span>

           x = ee_distance_rescaled(i,j,nw)

           denom         = 1.0d0 + b_vector(2) * x
           invdenom      = 1.0d0 / denom
           invdenom2     = invdenom * invdenom
           invdenom3     = invdenom2 * invdenom

           dx(1) = ee_distance_rescaled_gl(1, i, j, nw)
           dx(2) = ee_distance_rescaled_gl(2, i, j, nw)
           dx(3) = ee_distance_rescaled_gl(3, i, j, nw)
           dx(4) = ee_distance_rescaled_gl(4, i, j, nw)

           grad_c2 = dx(1)*dx(1) + dx(2)*dx(2) + dx(3)*dx(3)

           <span style="color: #a020f0;">if</span> (spin_independent == 1) <span style="color: #a020f0;">then</span>
              f1 = invdenom2
              f2 = -2.d0 * b_vector(1) * x * invdenom3
           <span style="color: #a020f0;">else</span>
              <span style="color: #a020f0;">if</span>((i &lt;= up_num <span style="color: #a020f0;">.and.</span> j &lt;= up_num ) <span style="color: #a020f0;">.or.</span> (i &gt;  up_num <span style="color: #a020f0;">.and.</span> j &gt;  up_num)) <span style="color: #a020f0;">then</span>
                 f1 = 0.5d0 * invdenom2
                 f2 = -1.d0 * b_vector(1) * x * invdenom3
              <span style="color: #a020f0;">else</span>
                 f1 = invdenom2
                 f2 = -2.d0 * b_vector(1) * x * invdenom3
              <span style="color: #a020f0;">end if</span>
           <span style="color: #a020f0;">end if</span>

           factor_ee_gl_pderiv(1,i,1) = factor_ee_gl_pderiv(1,i,1) + f1 * dx(1)
           factor_ee_gl_pderiv(2,i,1) = factor_ee_gl_pderiv(2,i,1) + f1 * dx(2)
           factor_ee_gl_pderiv(3,i,1) = factor_ee_gl_pderiv(3,i,1) + f1 * dx(3)
           factor_ee_gl_pderiv(4,i,1) = factor_ee_gl_pderiv(4,i,1) + f1 * dx(4) <span style="color: #a020f0;">&amp;</span>
           + 2.d0 * b_vector(2) * grad_c2 * f1 * invdenom

           factor_ee_gl_pderiv(1,i,2) = factor_ee_gl_pderiv(1,i,2) + f2 * dx(1)
           factor_ee_gl_pderiv(2,i,2) = factor_ee_gl_pderiv(2,i,2) + f2 * dx(2)
           factor_ee_gl_pderiv(3,i,2) = factor_ee_gl_pderiv(3,i,2) + f2 * dx(3)
           factor_ee_gl_pderiv(4,i,2) = factor_ee_gl_pderiv(4,i,2) <span style="color: #a020f0;">&amp;</span>
           + 2.d0 * f1 * b_vector(1) * (-invdenom * x * dx(4) - invdenom2 * grad_c2 * (1 - 2.d0 * x * b_vector(2)))


           kf = 2.d0
           x1 = x
           x = 1.d0
           <span style="color: #a020f0;">do</span> k=3, bord_num + 1
              f = kf * x
              factor_ee_gl_pderiv(1,i,k) = factor_ee_gl_pderiv(1,i,k) + f * x1 * dx(1)
              factor_ee_gl_pderiv(2,i,k) = factor_ee_gl_pderiv(2,i,k) + f * x1 * dx(2)
              factor_ee_gl_pderiv(3,i,k) = factor_ee_gl_pderiv(3,i,k) + f * x1 * dx(3)
              factor_ee_gl_pderiv(4,i,k) = factor_ee_gl_pderiv(4,i,k) <span style="color: #a020f0;">&amp;</span>
                   + f * (x1 * dx(4) + (kf-1.d0) * grad_c2)
              x = x*x1
              kf = kf + 1.d0
           <span style="color: #a020f0;">end do</span>

        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>
  factor_ee_gl_pderiv = factor_ee_gl_pderiv / <span style="color: #a020f0;">dble</span>(walk_num)

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_ee_gl_pderiv_doc</span>
</pre>
</div>
</div>
</div>
</div>
</div>



<div id="outline-container-org5566163" class="outline-3">
<h3 id="org5566163"><span class="section-number-3">4.2.</span> Electron-nucleus component</h3>
<div class="outline-text-3" id="text-4-2">
</div>
<div id="outline-container-org87a62bd" class="outline-4">
<h4 id="org87a62bd"><span class="section-number-4">4.2.1.</span> Asymptotic component</h4>
<div class="outline-text-4" id="text-4-2-1">
<p>
Calculate the asymptotic component <code>asymp_jasa</code> to be subtracted from the final
electron-nucleus jastrow factor \(J_{\text{eN}}\). The asymptotic component is calculated
via the <code>a_vector</code> and the electron-nucleus rescale factors <code>rescale_factor_en</code>.
</p>

<p>
\[
   J_{\text{en}}^{\infty \alpha} = -\frac{a_1 \kappa_\alpha^{-1}}{1 + a_2  \kappa_\alpha^{-1}}
   \]
</p>
</div>

<div id="outline-container-org13a1acc" class="outline-5">
<h5 id="org13a1acc"><span class="section-number-5">4.2.1.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-2-1-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_asymp_jasa</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                   <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">asymp_jasa</span>,
                                   <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org236947c"></a>Fortran interface<br />
<div class="outline-text-6" id="text-4-2-1-1-1">
<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_asymp_jasa</span><span style="color: #a0522d;">(context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        asymp_jasa, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> asymp_jasa(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_asymp_jasa</span>
<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orga1ccca8" class="outline-5">
<h5 id="orga1ccca8"><span class="section-number-5">4.2.1.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-2-1-2">
<table id="org72b519f" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>aord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Order of the polynomial</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of nucleus types</td>
</tr>

<tr>
<td class="org-left"><code>a_vector</code></td>
<td class="org-left"><code>double[type_nucl_num][aord_num+1]</code></td>
<td class="org-left">in</td>
<td class="org-left">Values of a</td>
</tr>

<tr>
<td class="org-left"><code>rescale_factor_en</code></td>
<td class="org-left"><code>double[type_nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron nucleus distances</td>
</tr>

<tr>
<td class="org-left"><code>asymp_jasa</code></td>
<td class="org-left"><code>double[type_nucl_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">Asymptotic value</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_asymp_jasa</span>(context, aord_num, type_nucl_num, a_vector, <span style="color: #a020f0;">&amp;</span>
     rescale_factor_en, asymp_jasa) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> aord_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> type_nucl_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> a_vector(aord_num+1,type_nucl_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> rescale_factor_en(type_nucl_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> asymp_jasa(type_nucl_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, j, p</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> kappa_inv, x, asym_one</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (aord_num &lt; 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">do</span> i=1,type_nucl_num

     kappa_inv = 1.0d0 / rescale_factor_en(i)

     asymp_jasa(i) = a_vector(1,i) * kappa_inv / (1.0d0 + a_vector(2,i) * kappa_inv)

     x = kappa_inv
     <span style="color: #a020f0;">do</span> p = 2, aord_num
        x = x * kappa_inv
        asymp_jasa(i) = asymp_jasa(i) + a_vector(p+1, i) * x
     <span style="color: #a020f0;">end do</span>

  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_asymp_jasa</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_asymp_jasa</span> (
      <span style="color: #228b22;">Type</span> <span style="color: #a0522d;">Variable</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">aord_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">type_nucl_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">a_vector</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">rescale_factor_en</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">asymp_jasa</span> ); 
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge24abb6" class="outline-4">
<h4 id="orge24abb6"><span class="section-number-4">4.2.2.</span> Electron-nucleus rescaled distances</h4>
<div class="outline-text-4" id="text-4-2-2">
<p>
<code>en_distance_rescaled</code> stores the matrix of the rescaled distances between
electrons and nuclei.
</p>

<p>
\[
    C_{i\alpha} = \frac{ 1 - e^{-\kappa_\alpha R_{i\alpha}}}{\kappa_\alpha}
    \]
</p>

<p>
where \(R_{i\alpha}\) is the matrix of electron-nucleus distances.
</p>
</div>

<div id="outline-container-org801ded4" class="outline-5">
<h5 id="org801ded4"><span class="section-number-5">4.2.2.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-2-2-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_en_distance_rescaled</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                             <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">distance_rescaled</span>,
                                             <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>
</div>


<div id="outline-container-org63c8b7f" class="outline-5">
<h5 id="org63c8b7f"><span class="section-number-5">4.2.2.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-2-2-2">
<table id="orgda46973" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of types of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_vector</code></td>
<td class="org-left"><code>int64_t[nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of types of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>rescale_factor_en</code></td>
<td class="org-left"><code>double[type_nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">The factor for rescaled distances</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_coord</code></td>
<td class="org-left"><code>double[3][walk_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron coordinates</td>
</tr>

<tr>
<td class="org-left"><code>nucl_coord</code></td>
<td class="org-left"><code>double[3][nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Nuclear coordinates</td>
</tr>

<tr>
<td class="org-left"><code>en_distance_rescaled</code></td>
<td class="org-left"><code>double[walk_num][nucl_num][elec_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">Electron-nucleus distances</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_en_distance_rescaled_doc</span>(context, <span style="color: #a020f0;">&amp;</span>
     elec_num, nucl_num, type_nucl_num, <span style="color: #a020f0;">&amp;</span>
     type_nucl_vector, rescale_factor_en, walk_num, elec_coord, <span style="color: #a020f0;">&amp;</span>
     nucl_coord, en_distance_rescaled) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">bind</span>(C) <span style="color: #a020f0;">result</span>(info)
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span> (qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> type_nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> type_nucl_vector(nucl_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> rescale_factor_en(type_nucl_num)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> elec_coord(elec_num,walk_num,3)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> nucl_coord(nucl_num,3)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> en_distance_rescaled(elec_num,nucl_num,walk_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, k</span>
  <span style="color: #228b22;">double precision</span>      ::<span style="color: #a0522d;"> coord(3)</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (nucl_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_3
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_5
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">do</span> i=1, nucl_num
     coord(1:3) = nucl_coord(i,1:3)
     <span style="color: #a020f0;">do</span> k=1,walk_num
        info = qmckl_distance_rescaled(context, <span style="color: #8b2252;">'T'</span>, <span style="color: #8b2252;">'N'</span>, elec_num, 1_8, <span style="color: #a020f0;">&amp;</span>
             elec_coord(1,k,1), elec_num*walk_num, coord, 3_8, <span style="color: #a020f0;">&amp;</span>
             en_distance_rescaled(1,i,k), elec_num, rescale_factor_en(type_nucl_vector(i)+1))
        <span style="color: #a020f0;">if</span> (info /= QMCKL_SUCCESS) <span style="color: #a020f0;">then</span>
           <span style="color: #a020f0;">return</span>
        <span style="color: #a020f0;">endif</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_en_distance_rescaled_doc</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgab9f3dd" class="outline-4">
<h4 id="orgab9f3dd"><span class="section-number-4">4.2.3.</span> Electron-electron rescaled distance gradients and Laplacian with respect to electron coordinates</h4>
<div class="outline-text-4" id="text-4-2-3">
<p>
The rescaled distances, represented by \(C_{i\alpha} = (1 - e^{-\kappa_\alpha R_{i\alpha}})/\kappa\)
are differentiated with respect to the electron coordinates.
This information is stored in the tensor
<code>en_distance_rescaled_gl</code>. The initial three sequential
elements of this three-index tensor provide the \(x\), \(y\), and \(z\)
direction derivatives, while the fourth index corresponds to the Laplacian.
</p>
</div>

<div id="outline-container-orgd621f7c" class="outline-5">
<h5 id="orgd621f7c"><span class="section-number-5">4.2.3.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-2-3-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_en_distance_rescaled_gl</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                                <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">distance_rescaled_gl</span>,
                                                <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-org52be062" class="outline-5">
<h5 id="org52be062"><span class="section-number-5">4.2.3.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-2-3-2">
<table id="orge3c6598" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of nucleus types</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_vector</code></td>
<td class="org-left"><code>int64_t[nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Array of nucleus types</td>
</tr>

<tr>
<td class="org-left"><code>rescale_factor_en</code></td>
<td class="org-left"><code>double[nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">The factors for rescaled distances</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_coord</code></td>
<td class="org-left"><code>double[3][walk_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron coordinates</td>
</tr>

<tr>
<td class="org-left"><code>nucl_coord</code></td>
<td class="org-left"><code>double[3][nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Nuclear coordinates</td>
</tr>

<tr>
<td class="org-left"><code>en_distance_rescaled_gl</code></td>
<td class="org-left"><code>double[walk_num][nucl_num][elec_num][4]</code></td>
<td class="org-left">out</td>
<td class="org-left">Electron-nucleus distance derivatives</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_en_distance_rescaled_gl_doc</span>(context, elec_num, nucl_num, <span style="color: #a020f0;">&amp;</span>
     type_nucl_num, type_nucl_vector, rescale_factor_en, walk_num, elec_coord, <span style="color: #a020f0;">&amp;</span>
     nucl_coord, en_distance_rescaled_gl) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in)  ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> type_nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> type_nucl_vector(nucl_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> rescale_factor_en(nucl_num)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> elec_coord(elec_num,walk_num,3)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> nucl_coord(nucl_num,3)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> en_distance_rescaled_gl(4,elec_num,nucl_num,walk_num)</span>

  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>
  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, k</span>
  <span style="color: #228b22;">double precision</span> ::<span style="color: #a0522d;"> coord(3)</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (nucl_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_3
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_5
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">do</span> i=1, nucl_num
     coord(1:3) = nucl_coord(i,1:3)
     <span style="color: #a020f0;">do</span> k=1,walk_num
        info = qmckl_distance_rescaled_gl(context, <span style="color: #8b2252;">'T'</span>, <span style="color: #8b2252;">'T'</span>, elec_num, 1_8, <span style="color: #a020f0;">&amp;</span>
             elec_coord(1,k,1), elec_num*walk_num, coord, 1_8, <span style="color: #a020f0;">&amp;</span>
             en_distance_rescaled_gl(1,1,i,k), elec_num, rescale_factor_en(type_nucl_vector(i)+1))
        <span style="color: #a020f0;">if</span> (info /= QMCKL_SUCCESS) <span style="color: #a020f0;">then</span>
           <span style="color: #a020f0;">return</span>
        <span style="color: #a020f0;">endif</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_en_distance_rescaled_gl_doc</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgcb9b84a" class="outline-4">
<h4 id="orgcb9b84a"><span class="section-number-4">4.2.4.</span> Electron-nucleus component</h4>
<div class="outline-text-4" id="text-4-2-4">
<p>
Calculate the electron-electron jastrow component <code>factor_en</code> using the <code>a_vector</code>
coeffecients and the electron-nucleus rescaled distances <code>en_distance_rescaled</code>.
</p>

<p>
\[
 f_{\alpha}(R_{i\alpha}) = - \sum_{i,j<i} \left[ \frac{ A_0 C_{ij}}{1 + A_1 C_{ij}} + \sum_{k=2}^{N^\alpha_{\text{ord}}}A_k C_{ij}^k \right]
   \]
</p>
</div>


<div id="outline-container-org7fc46a4" class="outline-5">
<h5 id="org7fc46a4"><span class="section-number-5">4.2.4.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-2-4-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_en</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                            <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_en</span>,
                            <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org1edccf6"></a>Fortran interface<br />
<div class="outline-text-6" id="text-4-2-4-1-1">
<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_en</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        factor_en, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> factor_en(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_en</span>
<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org5542f68" class="outline-5">
<h5 id="org5542f68"><span class="section-number-5">4.2.4.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-2-4-2">
<table id="orgb23faff" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of unique nuclei</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_vector</code></td>
<td class="org-left"><code>int64_t[nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">IDs of unique nuclei</td>
</tr>

<tr>
<td class="org-left"><code>aord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of coefficients</td>
</tr>

<tr>
<td class="org-left"><code>a_vector</code></td>
<td class="org-left"><code>double[type_nucl_num][aord_num+1]</code></td>
<td class="org-left">in</td>
<td class="org-left">List of coefficients</td>
</tr>

<tr>
<td class="org-left"><code>en_distance_rescaled</code></td>
<td class="org-left"><code>double[walk_num][nucl_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus distances</td>
</tr>

<tr>
<td class="org-left"><code>asymp_jasa</code></td>
<td class="org-left"><code>double[type_nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Type of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>factor_en</code></td>
<td class="org-left"><code>double[walk_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">Electron-nucleus jastrow</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_en_doc</span>( <span style="color: #a020f0;">&amp;</span>
     context, walk_num, elec_num, nucl_num, type_nucl_num, <span style="color: #a020f0;">&amp;</span>
     type_nucl_vector, aord_num, a_vector, <span style="color: #a020f0;">&amp;</span>
     en_distance_rescaled, asymp_jasa, factor_en) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">bind</span>(C) <span style="color: #a020f0;">result</span>(info)
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>

  <span style="color: #228b22;">integer</span> (qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> type_nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> type_nucl_vector(nucl_num)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> aord_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> a_vector(aord_num+1,type_nucl_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> en_distance_rescaled(elec_num,nucl_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> asymp_jasa(type_nucl_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> factor_en(walk_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, a, p, nw</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> x, power_ser</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_3
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (nucl_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_4
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (type_nucl_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_4
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (aord_num &lt; 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_7
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>


  <span style="color: #a020f0;">do</span> nw =1, walk_num
     factor_en(nw) = 0.0d0
     <span style="color: #a020f0;">do</span> a = 1, nucl_num
        <span style="color: #a020f0;">do</span> i = 1, elec_num
           x = en_distance_rescaled(i, a, nw)

           factor_en(nw) = factor_en(nw) + a_vector(1, type_nucl_vector(a)+1) * x / <span style="color: #a020f0;">&amp;</span>
                (1.0d0 + a_vector(2, type_nucl_vector(a)+1) * x) - asymp_jasa(type_nucl_vector(a)+1)

           <span style="color: #a020f0;">do</span> p = 2, aord_num
              x = x * en_distance_rescaled(i, a, nw)
              factor_en(nw) = factor_en(nw) + a_vector(p + 1, type_nucl_vector(a)+1) * x
           <span style="color: #a020f0;">end do</span>

        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_en_doc</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_en_doc</span> (
      <span style="color: #228b22;">Type</span> <span style="color: #a0522d;">Variable</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nucl_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">type_nucl_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span>* <span style="color: #a0522d;">type_nucl_vector</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">aord_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">a_vector</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">en_distance_rescaled</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">asymp_jasa</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_en</span> ); 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_en</span> (
         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nucl_num</span>,
         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">type_nucl_num</span>,
         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span>* <span style="color: #a0522d;">type_nucl_vector</span>,
         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">aord_num</span>,
         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">a_vector</span>,
         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">en_distance_rescaled</span>,
         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">asymp_jasa</span>,
         <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_en</span> )
{
<span style="color: #483d8b;">#ifdef</span> HAVE_HPC
  <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_factor_en_hpc
<span style="color: #483d8b;">#else</span>
  <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_factor_en_doc
<span style="color: #483d8b;">#endif</span>
    (context, walk_num, elec_num, nucl_num, type_nucl_num,
     type_nucl_vector, aord_num, a_vector, en_distance_rescaled,
     asymp_jasa, factor_en );
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org1bceda1" class="outline-4">
<h4 id="org1bceda1"><span class="section-number-4">4.2.5.</span> Derivative</h4>
<div class="outline-text-4" id="text-4-2-5">
<p>
Calculate the electron-electron jastrow component <code>factor_en_gl</code> derivative
with respect to the electron coordinates using the <code>en_distance_rescaled</code> and
<code>en_distance_rescaled_gl</code> which are already calculated previously.
</p>

<p>
The derivative is calculated in the function <code>qmckl_compute_jastrow_champ_factor_en_gl</code>.
The formula is given by:
\[
\nabla_i f_{\alpha}(R_{i\alpha}) = \sum_{j=1}^{N_\text{elec}} \left[
   \frac{ A_0\, \nabla_i C_{ij} }{(1 + A_1 C_{ij})^2} + 
  \sum_{k=2}^{N^\alpha_{\text{ord}}} A_k\, k\, C_{ij}^{k-1}\,\nabla_i C_{ij} \right] 
   \]
</p>

<p>
\[
\Delta_i f_{\alpha}(R_{i\alpha}) = \sum_{j=1}^{N_\text{elec}} \left[
   \frac{ A_0\, \Delta_i C_{ij} }{(1 + A_1 C_{ij})^2} - 
   \frac{ 2 A_0\, A_1 (\nabla_i C_{ij})^2}{(1 + A_1 C_{ij})^3} + 
  \sum_{k=2}^{N^\alpha_{\text{ord}}} A_k\, k\, C_{ij}^{k-1} C_{ij}^{k-2}
\left[ \Delta_i C_{ij} + (k-1)(\nabla_i C_{ij})^2 \right] \right] 
   \]
</p>
</div>

<div id="outline-container-org83c3338" class="outline-5">
<h5 id="org83c3338"><span class="section-number-5">4.2.5.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-2-5-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_en_gl</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                    <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_en_gl</span>,
                                    <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="orgaa0ff54"></a>Fortran interface<br />
<div class="outline-text-6" id="text-4-2-5-1-1">
<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_en_gl</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        factor_en_gl, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> factor_en_gl(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_en_gl</span>
<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org0ed38ed" class="outline-5">
<h5 id="org0ed38ed"><span class="section-number-5">4.2.5.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-2-5-2">
<table id="org0732d6e" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of unique nuclei</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_vector</code></td>
<td class="org-left"><code>int64_t[nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">IDs of unique nuclei</td>
</tr>

<tr>
<td class="org-left"><code>aord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of coefficients</td>
</tr>

<tr>
<td class="org-left"><code>a_vector</code></td>
<td class="org-left"><code>double[type_nucl_num][aord_num+1]</code></td>
<td class="org-left">in</td>
<td class="org-left">List of coefficients</td>
</tr>

<tr>
<td class="org-left"><code>en_distance_rescaled</code></td>
<td class="org-left"><code>double[walk_num][nucl_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus distances</td>
</tr>

<tr>
<td class="org-left"><code>en_distance_rescaled_gl</code></td>
<td class="org-left"><code>double[walk_num][nucl_num][elec_num][4]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus distance derivatives</td>
</tr>

<tr>
<td class="org-left"><code>factor_en_gl</code></td>
<td class="org-left"><code>double[walk_num][4][elec_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">Electron-nucleus jastrow</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_en_gl_doc</span>( <span style="color: #a020f0;">&amp;</span>
     context, walk_num, elec_num, nucl_num, type_nucl_num, <span style="color: #a020f0;">&amp;</span>
     type_nucl_vector, aord_num, a_vector, <span style="color: #a020f0;">&amp;</span>
     en_distance_rescaled, en_distance_rescaled_gl, factor_en_gl) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">bind</span>(C) <span style="color: #a020f0;">result</span>(info)
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>

  <span style="color: #228b22;">integer</span> (qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> type_nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> type_nucl_vector(nucl_num)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> aord_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> a_vector(aord_num+1,type_nucl_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> en_distance_rescaled(elec_num,nucl_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> en_distance_rescaled_gl(4, elec_num,nucl_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> factor_en_gl(elec_num,4,walk_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, a, k, nw, ii</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> x, x1, kf</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> denom, invdenom, invdenom2, f</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> grad_c2</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> dx(4)</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_3
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (nucl_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_4
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (aord_num &lt; 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_7
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">do</span> nw =1, walk_num
     factor_en_gl(:,:,nw) = 0.0d0
     <span style="color: #a020f0;">do</span> a = 1, nucl_num
        <span style="color: #a020f0;">do</span> i = 1, elec_num

           x = en_distance_rescaled(i,a,nw)
           <span style="color: #a020f0;">if</span>(<span style="color: #a020f0;">abs</span>(x) &lt; 1.d-12) <span style="color: #a020f0;">continue</span>

           denom = 1.0d0 + a_vector(2, type_nucl_vector(a)+1) * x
           invdenom = 1.0d0 / denom
           invdenom2 = invdenom*invdenom

           dx(1) = en_distance_rescaled_gl(1,i,a,nw)
           dx(2) = en_distance_rescaled_gl(2,i,a,nw)
           dx(3) = en_distance_rescaled_gl(3,i,a,nw)
           dx(4) = en_distance_rescaled_gl(4,i,a,nw)

           f = a_vector(1, type_nucl_vector(a)+1) * invdenom2
           grad_c2 = dx(1)*dx(1) + dx(2)*dx(2) + dx(3)*dx(3)

           factor_en_gl(i,1,nw) = factor_en_gl(i,1,nw) + f * dx(1)
           factor_en_gl(i,2,nw) = factor_en_gl(i,2,nw) + f * dx(2)
           factor_en_gl(i,3,nw) = factor_en_gl(i,3,nw) + f * dx(3)
           factor_en_gl(i,4,nw) = factor_en_gl(i,4,nw) <span style="color: #a020f0;">&amp;</span>
                + f * (dx(4) - 2.d0 * a_vector(2, type_nucl_vector(a)+1) * grad_c2 * invdenom)


           kf = 2.d0
           x1 = x
           x = 1.d0
           <span style="color: #a020f0;">do</span> k=2, aord_num
              f = a_vector(k+1,type_nucl_vector(a)+1) * kf * x
              factor_en_gl(i,1,nw) = factor_en_gl(i,1,nw) + f * x1 * dx(1)
              factor_en_gl(i,2,nw) = factor_en_gl(i,2,nw) + f * x1 * dx(2)
              factor_en_gl(i,3,nw) = factor_en_gl(i,3,nw) + f * x1 * dx(3)
              factor_en_gl(i,4,nw) = factor_en_gl(i,4,nw) <span style="color: #a020f0;">&amp;</span>
                   + f * (x1 * dx(4) + (kf-1.d0) * grad_c2)
              x = x*x1
              kf = kf + 1.d0
           <span style="color: #a020f0;">end do</span>

        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_en_gl_doc</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgde5bc35" class="outline-5">
<h5 id="orgde5bc35"><span class="section-number-5">4.2.5.3.</span> Test</h5>
<div class="outline-text-5" id="text-4-2-5-3">
<div class="org-src-container">
<pre class="src src-c">/* <span style="color: #b22222;">Check if Jastrow is properly initialized</span> */
<span style="color: #0000ff;">assert</span>(<span style="color: #228b22;">qmckl_jastrow_champ_provided</span>(<span style="color: #a0522d;">context</span>));

{
  printf(<span style="color: #8b2252;">"factor_en_gl\n"</span>);
  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">fd</span>[walk_num][4][elec_num];
  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">delta_x</span> = 0.001;

  // <span style="color: #b22222;">Finite difference coefficients for gradients</span>
  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">coef</span>[9] = { 1.0/280.0, -4.0/105.0,  1.0/5.0, -4.0/5.0,         0.0, 4.0/5.0, -1.0/5.0, 4.0/105.0, -1.0/280.0 };

  // <span style="color: #b22222;">Finite difference coefficients for Laplacian</span>
  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">coef2</span>[9]= {-1.0/560.0,  8.0/315.0, -1.0/5.0,  8.0/5.0, -205.0/72.0, 8.0/5.0, -1.0/5.0, 8.0/315.0, -1.0/560.0 };

  <span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #a0522d;">rc</span>;

  <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>;
  rc = qmckl_get_electron_walk_num(context, &amp;walk_num);
  <span style="color: #a020f0;">if</span> (rc != QMCKL_SUCCESS) {
    <span style="color: #a020f0;">return</span> rc;
  }

  <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>;
  rc = qmckl_get_electron_num(context, &amp;elec_num);
  <span style="color: #a020f0;">if</span> (rc != QMCKL_SUCCESS) {
    <span style="color: #a020f0;">return</span> rc;
  }

  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">elec_coord</span>[walk_num][elec_num][3];
  rc = qmckl_get_electron_coord (context, <span style="color: #8b2252;">'N'</span>, &amp;(elec_coord[0][0][0]), 3*walk_num*elec_num);

  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">temp_coord</span>[walk_num][elec_num][3];
  memcpy(&amp;(temp_coord[0][0][0]), &amp;(elec_coord[0][0][0]), <span style="color: #a020f0;">sizeof</span>(temp_coord));

  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">function_values</span>[walk_num];

  memset(&amp;(fd[0][0][0]), 0, <span style="color: #a020f0;">sizeof</span>(fd));

  <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">i</span> = 0; i &lt; elec_num; i++) {
    <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">k</span> = 0; k &lt; 3; k++) {
      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">m</span> = -4; m &lt;= 4; m++) {          // <span style="color: #b22222;">Apply finite difference displacement</span>

        <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nw</span>=0 ; nw&lt;walk_num ; nw++) {
          temp_coord[nw][i][k] = elec_coord[nw][i][k] + (<span style="color: #228b22;">double</span>) <span style="color: #228b22;">m</span> * <span style="color: #a0522d;">delta_x</span>;
        }

        // <span style="color: #b22222;">Update coordinates in the context</span>
        rc = qmckl_set_electron_coord (context, <span style="color: #8b2252;">'N'</span>, walk_num, &amp;(temp_coord[0][0][0]), walk_num*3*elec_num);
        assert(rc == QMCKL_SUCCESS);

        // <span style="color: #b22222;">Call the provided function</span>
        rc = qmckl_get_jastrow_champ_factor_en(context, &amp;(function_values[0]), walk_num);
        assert(rc == QMCKL_SUCCESS);

        // <span style="color: #b22222;">Accumulate derivative using finite-difference coefficients</span>
        <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nw</span>=0 ; nw&lt;walk_num ; nw++) {
          fd[nw][k][i] += coef [m + 4] * function_values[nw];
          fd[nw][3][i] += coef2[m + 4] * function_values[nw];
        }
      }
      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nw</span>=0 ; nw&lt;walk_num ; nw++) {
        temp_coord[nw][i][k] = elec_coord[nw][i][k];
      }
    }
  }

  // <span style="color: #b22222;">Reset coordinates in the context</span>
  rc = qmckl_set_electron_coord (context, <span style="color: #8b2252;">'N'</span>, walk_num, &amp;(elec_coord[0][0][0]), walk_num*3*elec_num);
  assert(rc == QMCKL_SUCCESS);

  // <span style="color: #b22222;">Normalize by the step size</span>
  <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nw</span>=0 ; nw&lt;walk_num ; nw++) {
    <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">k</span> = 0; k &lt; 4; k++) {
      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">i</span> = 0; i &lt; elec_num; i++) {
          fd[nw][k][i] /= delta_x;
      }
    }
    <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">i</span> = 0; i &lt; elec_num; i++) {
      fd[nw][3][i] /= delta_x;
    }
  }


  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">factor_en_gl</span>[walk_num][4][elec_num];
  rc = qmckl_check(context,
                   qmckl_get_jastrow_champ_factor_en_gl(context,
                                                        &amp;(factor_en_gl[0][0][0]),
                                                        walk_num*4*elec_num)
                   );

  assert(rc == QMCKL_SUCCESS);

  <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">nw</span> = 0; nw &lt; walk_num; nw++){
    <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">i</span> = 0; i &lt; elec_num; i++) {
      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">k</span> = 0; k &lt; 3; k++){
        printf(<span style="color: #8b2252;">"%.10f\t"</span>, fd[nw][k][i]);
        printf(<span style="color: #8b2252;">"%.10f\n"</span>, factor_en_gl[nw][k][i]);
        fflush(stdout);
        assert(fabs(fd[nw][k][i] - factor_en_gl[nw][k][i]) &lt; 1.e-8);
      }
      <span style="color: #228b22;">int</span> <span style="color: #a0522d;">k</span>=3;
      <span style="color: #a020f0;">if</span> (fabs(fd[nw][k][i] - factor_en_gl[nw][k][i]) &gt; 1.e-5) {
        printf(<span style="color: #8b2252;">"i=%d doc=%f hpc=%f\n"</span>, i, fd[nw][k][i], factor_en_gl[nw][k][i]);
        fflush(stdout);
      }
      assert(fabs(fd[nw][k][i] - factor_en_gl[nw][k][i]) &lt; 1.e-5);
    }
  }
  printf(<span style="color: #8b2252;">"OK\n"</span>);
}

{
  printf(<span style="color: #8b2252;">"factor_en_gl_hpc\n"</span>);

  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">en_distance_rescaled</span>[walk_num][nucl_num][elec_num];
  rc = qmckl_get_jastrow_champ_en_distance_rescaled(context,
                                                    &amp;(en_distance_rescaled[0][0][0]),
                                                    walk_num*nucl_num*elec_num);
  assert(rc == QMCKL_SUCCESS);

  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">en_distance_rescaled_gl</span>[walk_num][4][elec_num][nucl_num];
  rc = qmckl_get_jastrow_champ_en_distance_rescaled_gl(context,
                                                       &amp;(en_distance_rescaled_gl[0][0][0][0]),
                                                       walk_num*4*elec_num*nucl_num);
  assert(rc == QMCKL_SUCCESS);

  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">factor_en_gl_doc</span>[walk_num*4*elec_num];
  memset(&amp;(factor_en_gl_doc[0]), 0, <span style="color: #a020f0;">sizeof</span>(factor_en_gl_doc));
  rc = qmckl_compute_jastrow_champ_factor_en_gl_doc(context, walk_num, elec_num,
       nucl_num, type_nucl_num, type_nucl_vector, aord_num, &amp;(a_vector[0]),
       &amp;(en_distance_rescaled[0][0][0]), &amp;(en_distance_rescaled_gl[0][0][0][0]), &amp;(factor_en_gl_doc[0]));
  assert(rc == QMCKL_SUCCESS);

  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">factor_en_gl_hpc</span>[walk_num*4*elec_num];
  memset(&amp;(factor_en_gl_hpc[0]), 0, <span style="color: #a020f0;">sizeof</span>(factor_en_gl_hpc));
  rc = qmckl_compute_jastrow_champ_factor_en_gl_hpc(context, walk_num, elec_num,
       nucl_num, type_nucl_num, type_nucl_vector, aord_num, &amp;(a_vector[0]),
       &amp;(en_distance_rescaled[0][0][0]), &amp;(en_distance_rescaled_gl[0][0][0][0]), &amp;(factor_en_gl_hpc[0]));
  assert(rc == QMCKL_SUCCESS);

  <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">i</span> = 0; i &lt; walk_num*4*elec_num; i++) {
    <span style="color: #a020f0;">if</span> (fabs(factor_en_gl_doc[i] - factor_en_gl_hpc[i]) &gt; 1.e-12) {
      printf(<span style="color: #8b2252;">"i=%ld doc=%f hpc=%f\n"</span>, i, factor_en_gl_doc[i], factor_en_gl_hpc[i]);
      fflush(stdout);
    }
    assert(fabs(factor_en_gl_doc[i] - factor_en_gl_hpc[i]) &lt; 1.e-8);
  }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org348fe69" class="outline-4">
<h4 id="org348fe69"><span class="section-number-4">4.2.6.</span> Parameter Derivative of the Asymptotic component</h4>
<div class="outline-text-4" id="text-4-2-6">
<p>
Calculate the derivative of the asymptotic component <code>asymp_jasa</code> to be subtracted from the final
electron-nucleus jastrow factor parameter derivatives \(J_{\text{eN}}\). The asymptotic component is calculated
via the <code>a_vector</code> and the electron-nucleus rescale factors <code>rescale_factor_en</code>.
</p>


<p>
\[
   J_{\text{en}}^{\infty} = \frac{A_0 \kappa_\text{en}^{-1}}{1 + A_1\,
   \kappa_\text{en}^{-1}} + \sum_{p=2}^{N_\text{ord}^B} A_{p+1}\, \kappa_\text{en}^{-p}
   \]
</p>

<p>
\[ \partial_{B_0} J_{\text{ee}}^\infty = \frac{\frac{1}{2}(1 + \delta^{\uparrow\downarrow}_{ij})
   \kappa_{\text{ee}}^{-1}}{1 + B_1 \kappa_{\text{ee}}^{-1}} \]
</p>

<p>
\[ \partial_{B_1}J_{\text{ee}}^\infty =  -\frac{ \frac{1}{2}(1 + \delta_{ij}) \kappa_{\text{ee}}^{-2}}
   {(1 + B_1 \kappa_{\text{ee}}^{-1})^2 } \]
</p>

<p>
\[ \partial_{B_k} J_{\text{ee}}^\infty = \kappa_{\text{ee}}^{-(k-1)} \] for \(k > 1\)
</p>

<p>
\[
   J_{\text{en}}^{\infty \alpha} = -\frac{a_1 \kappa_\alpha^{-1}}{1 + a_2  \kappa_\alpha^{-1}}
   \]
</p>
</div>

<div id="outline-container-org7fde76a" class="outline-5">
<h5 id="org7fde76a"><span class="section-number-5">4.2.6.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-2-6-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_asymp_jasa_pderiv</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                          <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">asymp_jasa_pderiv</span>,
                                          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org33a9217"></a>Fortran interface<br />
<div class="outline-text-6" id="text-4-2-6-1-1">
<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_asymp_jasa_pderiv</span><span style="color: #a0522d;">(context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        asymp_jasa_pderiv, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> asymp_jasa_pderiv(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_asymp_jasa_pderiv</span>
<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgeb0a641" class="outline-5">
<h5 id="orgeb0a641"><span class="section-number-5">4.2.6.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-2-6-2">
<table id="org9c7e696" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>aord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Order of the polynomial</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of nucleus types</td>
</tr>

<tr>
<td class="org-left"><code>a_vector</code></td>
<td class="org-left"><code>double[type_nucl_num][aord_num+1]</code></td>
<td class="org-left">in</td>
<td class="org-left">Values of a</td>
</tr>

<tr>
<td class="org-left"><code>rescale_factor_en</code></td>
<td class="org-left"><code>double[type_nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron nucleus distances</td>
</tr>

<tr>
<td class="org-left"><code>asymp_jasa_pderiv</code></td>
<td class="org-left"><code>double[type_nucl_num][aord_num+1]</code></td>
<td class="org-left">out</td>
<td class="org-left">Parameter derivative of Asymptotic value</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_asymp_jasa_pderiv</span>(context, aord_num, type_nucl_num, a_vector, <span style="color: #a020f0;">&amp;</span>
     rescale_factor_en, asymp_jasa_pderiv) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> aord_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> type_nucl_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> a_vector(aord_num+1,type_nucl_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> rescale_factor_en(type_nucl_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> asymp_jasa_pderiv(aord_num+1, type_nucl_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, j, p</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> kappa_inv, x, asym_one</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (aord_num &lt; 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">do</span> i=1,type_nucl_num

     kappa_inv = 1.0d0 / rescale_factor_en(i)

     asymp_jasa_pderiv(1,i) = kappa_inv / (1.0d0 + a_vector(2,i) * kappa_inv)
     asymp_jasa_pderiv(2,i) = - a_vector(1,i) * kappa_inv**2 / (1.0d0 + a_vector(2,i) * kappa_inv)**2

     x = kappa_inv
     <span style="color: #a020f0;">do</span> p = 2, aord_num
        x = x * kappa_inv
        asymp_jasa_pderiv(p+1, i) = x
     <span style="color: #a020f0;">end do</span>

  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_asymp_jasa_pderiv</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org4803ca5" class="outline-4">
<h4 id="org4803ca5"><span class="section-number-4">4.2.7.</span> Parameter Derivative</h4>
<div class="outline-text-4" id="text-4-2-7">
<p>
Calculate the parameter derivatives of the electron-nucleus jastrow component <code>factor_en_pderiv</code> using the <code>a_vector</code>
coeffecients and the electron-nucleus rescaled distances
<code>en_distance_rescaled</code>. The result is stored in <code>factor_en_pderiv</code>. If
\(\alpha\) only runs over atoms of the same type then the
expressions for the derivatives are:
\[ \frac{\partial f}{\partial A_0} = \sum_{i, \alpha} \frac{
   R_{i\alpha} }{1 + A_1 R_{i\alpha} } - \frac{\partial
   J_{en}^\infty}{\partial A_0} \]
\[ \frac{\partial f}{\partial A_1} = \sum_{i, \alpha} \frac{
   A_0 R_{i\alpha}^2 }{(1 + A_1 R_{i\alpha})^2 } - \frac{\partial
   J_{en}^\infty}{\partial A_1} \]
\[ \frac{\partial f}{\partial A_k} = \sum_{i, \alpha} R_{i\alpha}^k - \frac{\partial
   J_{en}^\infty}{\partial A_k}
   \]
</p>
</div>

<div id="outline-container-orgb33651a" class="outline-5">
<h5 id="orgb33651a"><span class="section-number-5">4.2.7.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-2-7-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_en_pderiv</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                         <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_en_pderiv</span>,
                                         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_en_pderiv</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        factor_en_pderiv, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> factor_en_pderiv(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_en_pderiv</span>
<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-org3fb026c" class="outline-5">
<h5 id="org3fb026c"><span class="section-number-5">4.2.7.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-2-7-2">
<table id="org1b8fba7" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of unique nuclei</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_vector</code></td>
<td class="org-left"><code>int64_t[nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">IDs of unique nuclei</td>
</tr>

<tr>
<td class="org-left"><code>aord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of coefficients</td>
</tr>

<tr>
<td class="org-left"><code>a_vector</code></td>
<td class="org-left"><code>double[type_nucl_num][aord_num+1]</code></td>
<td class="org-left">in</td>
<td class="org-left">List of coefficients</td>
</tr>

<tr>
<td class="org-left"><code>en_distance_rescaled</code></td>
<td class="org-left"><code>double[walk_num][nucl_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus distances</td>
</tr>

<tr>
<td class="org-left"><code>asymp_jasa_pderiv</code></td>
<td class="org-left"><code>double[type_nucl_num][aord_num+1]</code></td>
<td class="org-left">in</td>
<td class="org-left">Type of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>factor_en_pderiv</code></td>
<td class="org-left"><code>double[type_nucl_num][aord_num+1]</code></td>
<td class="org-left">out</td>
<td class="org-left">Electron-nucleus jastrow</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_en_pderiv_doc</span>( <span style="color: #a020f0;">&amp;</span>
     context, walk_num, elec_num, nucl_num, type_nucl_num, <span style="color: #a020f0;">&amp;</span>
     type_nucl_vector, aord_num, a_vector, <span style="color: #a020f0;">&amp;</span>
     en_distance_rescaled, asymp_jasa_pderiv, factor_en_pderiv) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">bind</span>(C) <span style="color: #a020f0;">result</span>(info)
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>

  <span style="color: #228b22;">integer</span> (qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> type_nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> type_nucl_vector(nucl_num)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> aord_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> a_vector(aord_num+1,type_nucl_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> en_distance_rescaled(elec_num,nucl_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> asymp_jasa_pderiv(aord_num+1,type_nucl_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> factor_en_pderiv(aord_num+1,type_nucl_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, a, p, nw</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> x, power_ser</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_3
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (nucl_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_4
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (type_nucl_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_4
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (aord_num &lt; 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_7
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  factor_en_pderiv = 0.0d0
  <span style="color: #a020f0;">do</span> nw =1, walk_num
     <span style="color: #a020f0;">do</span> a = 1, nucl_num
        <span style="color: #a020f0;">do</span> i = 1, elec_num
           x = en_distance_rescaled(i, a, nw)

           factor_en_pderiv(1,type_nucl_vector(a)+1) = factor_en_pderiv(1,type_nucl_vector(a)+1) + <span style="color: #a020f0;">&amp;</span> 
           x / (1.0d0 + a_vector(2, type_nucl_vector(a)+1) * x) - asymp_jasa_pderiv(1,type_nucl_vector(a)+1)

           factor_en_pderiv(2,type_nucl_vector(a)+1) = factor_en_pderiv(2,type_nucl_vector(a)+1) - <span style="color: #a020f0;">&amp;</span>
           a_vector(2, type_nucl_vector(a)+1) * x**2 / (1.0d0 + a_vector(2, type_nucl_vector(a)+1) * x)**2 <span style="color: #a020f0;">&amp;</span>
           - asymp_jasa_pderiv(2,type_nucl_vector(a)+1)

           <span style="color: #a020f0;">do</span> p = 2, aord_num
              x = x * en_distance_rescaled(i, a, nw)
              factor_en_pderiv(p+1,type_nucl_vector(a)+1) = factor_en_pderiv(p+1,type_nucl_vector(a)+1) + x <span style="color: #a020f0;">&amp;</span>
              - asymp_jasa_pderiv(p+1,type_nucl_vector(a)+1)
           <span style="color: #a020f0;">end do</span>
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>
  factor_en_pderiv = factor_en_pderiv / <span style="color: #a020f0;">dble</span>(walk_num)
<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_en_pderiv_doc</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org0738729" class="outline-4">
<h4 id="org0738729"><span class="section-number-4">4.2.8.</span> Parameter Derivative of the gradient and Laplacian</h4>
<div class="outline-text-4" id="text-4-2-8">
<p>
The derivative of <code>factor_en_gl</code> with respect to all the jastrow parameters C is computed and stored into <code>factor_en_gl_pderiv</code>
</p>
</div>

<div id="outline-container-org66bcb8b" class="outline-5">
<h5 id="org66bcb8b"><span class="section-number-5">4.2.8.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-2-8-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_en_gl_pderiv</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                    <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_en_gl_pderiv</span>,
                                    <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org4b5c252"></a>Fortran interface<br />
<div class="outline-text-6" id="text-4-2-8-1-1">
<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_en_gl_pderiv</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        factor_en_gl_pderiv, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> factor_en_gl_pderiv(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_en_gl_pderiv</span>
<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgbfaeefe" class="outline-5">
<h5 id="orgbfaeefe"><span class="section-number-5">4.2.8.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-2-8-2">
<table id="orgf2b2729" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of unique nuclei</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_vector</code></td>
<td class="org-left"><code>int64_t[nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">IDs of unique nuclei</td>
</tr>

<tr>
<td class="org-left"><code>aord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of coefficients</td>
</tr>

<tr>
<td class="org-left"><code>a_vector</code></td>
<td class="org-left"><code>double[type_nucl_num][aord_num+1]</code></td>
<td class="org-left">in</td>
<td class="org-left">List of coefficients</td>
</tr>

<tr>
<td class="org-left"><code>en_distance_rescaled</code></td>
<td class="org-left"><code>double[walk_num][nucl_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus distances</td>
</tr>

<tr>
<td class="org-left"><code>en_distance_rescaled_gl</code></td>
<td class="org-left"><code>double[walk_num][nucl_num][elec_num][4]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus distance derivatives</td>
</tr>

<tr>
<td class="org-left"><code>factor_en_gl_pderiv</code></td>
<td class="org-left"><code>double[type_nucl_num][aord_num+1][elec_num][4]</code></td>
<td class="org-left">out</td>
<td class="org-left">Electron-nucleus jastrow</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_en_gl_pderiv_doc</span>( <span style="color: #a020f0;">&amp;</span>
     context, walk_num, elec_num, nucl_num, type_nucl_num, <span style="color: #a020f0;">&amp;</span>
     type_nucl_vector, aord_num, a_vector, <span style="color: #a020f0;">&amp;</span>
     en_distance_rescaled, en_distance_rescaled_gl, factor_en_gl_pderiv) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">bind</span>(C) <span style="color: #a020f0;">result</span>(info)
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>

  <span style="color: #228b22;">integer</span> (qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> type_nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> type_nucl_vector(nucl_num)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> aord_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> a_vector(aord_num+1,type_nucl_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> en_distance_rescaled(elec_num,nucl_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> en_distance_rescaled_gl(4, elec_num,nucl_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> factor_en_gl_pderiv(4,elec_num,aord_num+1,type_nucl_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, a, k, nw, ii</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> x, x1, kf</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> denom, invdenom, invdenom2, invdenom3, f</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> grad_c2</span>
  <span style="color: #228b22;">double precision</span>   ::<span style="color: #a0522d;"> dx(4)</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_3
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (nucl_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_4
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (type_nucl_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_5
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (aord_num &lt; 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_7
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  factor_en_gl_pderiv = 0.0d0
  <span style="color: #a020f0;">do</span> nw =1, walk_num
     <span style="color: #a020f0;">do</span> a = 1, nucl_num
        <span style="color: #a020f0;">do</span> i = 1, elec_num

           x = en_distance_rescaled(i,a,nw)
           <span style="color: #a020f0;">if</span>(<span style="color: #a020f0;">abs</span>(x) &lt; 1.d-12) <span style="color: #a020f0;">continue</span>

           denom = 1.0d0 + a_vector(2, type_nucl_vector(a)+1) * x
           invdenom = 1.0d0 / denom
           invdenom2 = invdenom*invdenom
           invdenom3 = invdenom2*invdenom

           dx(1) = en_distance_rescaled_gl(1,i,a,nw)
           dx(2) = en_distance_rescaled_gl(2,i,a,nw)
           dx(3) = en_distance_rescaled_gl(3,i,a,nw)
           dx(4) = en_distance_rescaled_gl(4,i,a,nw)

           f = invdenom2
           grad_c2 = dx(1)*dx(1) + dx(2)*dx(2) + dx(3)*dx(3)

           factor_en_gl_pderiv(1,i,1,type_nucl_vector(a)+1) = factor_en_gl_pderiv(1,i,1,type_nucl_vector(a)+1) + f * dx(1)
           factor_en_gl_pderiv(2,i,1,type_nucl_vector(a)+1) = factor_en_gl_pderiv(2,i,1,type_nucl_vector(a)+1) + f * dx(2)
           factor_en_gl_pderiv(3,i,1,type_nucl_vector(a)+1) = factor_en_gl_pderiv(3,i,1,type_nucl_vector(a)+1) + f * dx(3)
           factor_en_gl_pderiv(4,i,1,type_nucl_vector(a)+1) = factor_en_gl_pderiv(4,i,1,type_nucl_vector(a)+1) <span style="color: #a020f0;">&amp;</span>
                + f * (dx(4) - 2.d0 * a_vector(2, type_nucl_vector(a)+1) * grad_c2 * invdenom)

           f = -2.d0 * a_vector(1, type_nucl_vector(a)+1) * invdenom3

           factor_en_gl_pderiv(1,i,2,type_nucl_vector(a)+1) = factor_en_gl_pderiv(1,i,2,type_nucl_vector(a)+1) + f * x * dx(1)
           factor_en_gl_pderiv(2,i,2,type_nucl_vector(a)+1) = factor_en_gl_pderiv(2,i,2,type_nucl_vector(a)+1) + f * x * dx(2)
           factor_en_gl_pderiv(3,i,2,type_nucl_vector(a)+1) = factor_en_gl_pderiv(3,i,2,type_nucl_vector(a)+1) + f * x * dx(3)
           factor_en_gl_pderiv(4,i,2,type_nucl_vector(a)+1) = factor_en_gl_pderiv(4,i,2,type_nucl_vector(a)+1) <span style="color: #a020f0;">&amp;</span>
                + f * (x * dx(4) + invdenom * (grad_c2 - 2 * grad_c2 * x * a_vector(2, type_nucl_vector(a)+1)))

           kf = 2.d0
           x1 = x
           x = 1.d0
           <span style="color: #a020f0;">do</span> k=3, aord_num+1
              f = kf * x
              factor_en_gl_pderiv(1,i,k,type_nucl_vector(a)+1) = factor_en_gl_pderiv(1,i,k,type_nucl_vector(a)+1) + f * x1 * dx(1)
              factor_en_gl_pderiv(2,i,k,type_nucl_vector(a)+1) = factor_en_gl_pderiv(2,i,k,type_nucl_vector(a)+1) + f * x1 * dx(2)
              factor_en_gl_pderiv(3,i,k,type_nucl_vector(a)+1) = factor_en_gl_pderiv(3,i,k,type_nucl_vector(a)+1) + f * x1 * dx(3)
              factor_en_gl_pderiv(4,i,k,type_nucl_vector(a)+1) = factor_en_gl_pderiv(4,i,k,type_nucl_vector(a)+1) <span style="color: #a020f0;">&amp;</span>
                   + f * (x1 * dx(4) + (kf-1.d0) * grad_c2)
              x = x*x1
              kf = kf + 1.d0
           <span style="color: #a020f0;">end do</span>

        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>
  factor_en_gl_pderiv = factor_en_gl_pderiv / <span style="color: #a020f0;">dble</span>(walk_num)
<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_en_gl_pderiv_doc</span>
</pre>
</div>
</div>
</div>
</div>
</div>


<div id="outline-container-org7d2a0d5" class="outline-3">
<h3 id="org7d2a0d5"><span class="section-number-3">4.3.</span> Electron-electron-nucleus component</h3>
<div class="outline-text-3" id="text-4-3">
</div>
<div id="outline-container-org9d1e396" class="outline-4">
<h4 id="org9d1e396"><span class="section-number-4">4.3.1.</span> Electron-electron rescaled distances in \(J_\text{eeN}\)</h4>
<div class="outline-text-4" id="text-4-3-1">
<p>
<code>een_rescaled_e</code> stores the table of the rescaled distances between all
pairs of electrons and raised to the power \(p\) defined by <code>cord_num</code>:
</p>

<p>
\[
    [g_e(r)_{ij}]^p = \begin{cases}
     \exp\left(-p\,\kappa_\text{e}\, r_{ij}\right) & \text{for } i \ne j \\
     0 &  \text{for } i = j 
    \]
</p>

<p>
where \(r_{ij}\) is the matrix of electron-electron distances.
</p>
</div>

<div id="outline-container-org52c11db" class="outline-5">
<h5 id="org52c11db"><span class="section-number-5">4.3.1.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-3-1-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_een_rescaled_e</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                                <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">een_rescaled_e</span>,
                                                <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-orge82f62d" class="outline-5">
<h5 id="orge82f62d"><span class="section-number-5">4.3.1.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-3-1-2">
<table id="orgdd7260b" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>cord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Order of polynomials</td>
</tr>

<tr>
<td class="org-left"><code>rescale_factor_ee</code></td>
<td class="org-left"><code>double</code></td>
<td class="org-left">in</td>
<td class="org-left">Factor to rescale ee distances</td>
</tr>

<tr>
<td class="org-left"><code>ee_distance</code></td>
<td class="org-left"><code>double[walk_num][elec_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-electron distances for each walker</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_e</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][elec_num][elec_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">Electron-electron rescaled distances for each walker</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_een_rescaled_e_doc</span>( <span style="color: #a020f0;">&amp;</span>
     context, walk_num, elec_num, cord_num, rescale_factor_ee,  <span style="color: #a020f0;">&amp;</span>
     ee_distance, een_rescaled_e) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> cord_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> rescale_factor_ee</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> ee_distance(elec_num,elec_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> een_rescaled_e(elec_num,elec_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">double precision</span>                    ::<span style="color: #a0522d;"> x</span>
  <span style="color: #228b22;">integer</span>*8                           ::<span style="color: #a0522d;"> i, j, k, l, nw</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_3
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (cord_num &lt; 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_4
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">do</span> nw = 1, walk_num
     <span style="color: #a020f0;">do</span> l = 0, cord_num
        <span style="color: #a020f0;">do</span> j = 1, elec_num
           <span style="color: #a020f0;">do</span> i = 1, elec_num
              een_rescaled_e(i, j, l, nw) = dexp(-rescale_factor_ee * ee_distance(i, j, nw))**l
           <span style="color: #a020f0;">end do</span>
           een_rescaled_e(j, j, l, nw) = 0.d0
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_een_rescaled_e_doc</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_een_rescaled_e_hpc</span> (<span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                                  <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
                                                  <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
                                                  <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
                                                  <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">rescale_factor_ee</span>,
                                                  <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">ee_distance</span>,
                                                  <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">een_rescaled_e</span> ) {

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) {
    <span style="color: #a020f0;">return</span> QMCKL_INVALID_CONTEXT;
  }

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) {
    <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_2;
  }

  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) {
    <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_3;
  }

  <span style="color: #a020f0;">if</span> (cord_num &lt; 0) {
    <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_4;
  }

<span style="color: #483d8b;">#ifdef</span> HAVE_OPENMP
<span style="color: #483d8b;">#pragma</span> omp parallel <span style="color: #a020f0;">for</span>
<span style="color: #483d8b;">#endif</span>
  <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nw</span>=0 ; nw&lt;walk_num ; ++nw) {
    <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">een_rescaled_e_</span> =
      &amp;een_rescaled_e[elec_num*elec_num*((cord_num+1)*nw)];

<span style="color: #483d8b;">#ifdef</span> HAVE_OPENMP
<span style="color: #483d8b;">#pragma</span> omp simd
<span style="color: #483d8b;">#endif</span>
    <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">j</span>=0 ; j&lt;elec_num ; ++j) {
      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">i</span>=0 ; i&lt;elec_num ; ++i) {
        een_rescaled_e_[i + elec_num*j] = 1.0;
      }
    }
    <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">j</span>=0 ; j&lt;elec_num ; ++j) {
      een_rescaled_e_[j + elec_num*j] = 0.0;
    }
    <span style="color: #a020f0;">if</span> (cord_num &gt; 0) {
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">kappa</span> = -rescale_factor_ee;
      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">j</span>=0 ; j&lt;elec_num ; ++j) {
<span style="color: #483d8b;">#ifdef</span> HAVE_OPENMP
<span style="color: #483d8b;">#pragma</span> omp simd
<span style="color: #483d8b;">#endif</span>
        <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">i</span>=0 ; i&lt;elec_num ; ++i) {
          een_rescaled_e_[i + elec_num*(j + elec_num)] =
            exp(kappa * ee_distance[i + elec_num*(j + elec_num*nw)]);
        }
      }
      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">j</span>=0 ; j&lt;elec_num ; ++j) {
        een_rescaled_e_[j + elec_num*(j + elec_num)] = 0.0;
      }
    }
    <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">l</span>=2 ; l&lt;=cord_num ; ++l) {
      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">j</span>=0 ; j&lt;elec_num ; ++j) {
<span style="color: #483d8b;">#ifdef</span> HAVE_OPENMP
<span style="color: #483d8b;">#pragma</span> omp simd
<span style="color: #483d8b;">#endif</span>
        <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">i</span>=0 ; i&lt;elec_num ; ++i) {
          een_rescaled_e_[i + elec_num*(j + elec_num*l)] =
            een_rescaled_e_[i + elec_num*(j + elec_num*(l-1))] *
            een_rescaled_e_[i + elec_num*(j + elec_num)];
        }
      }
      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">j</span>=0 ; j&lt;elec_num ; ++j) {
        een_rescaled_e_[j + elec_num*(j + elec_num*l)] = 0.0;
      }
    }
  } // <span style="color: #b22222;">OpenMP</span>

  <span style="color: #a020f0;">return</span> QMCKL_SUCCESS;
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_een_rescaled_e_doc</span> (
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">rescale_factor_ee</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">ee_distance</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">een_rescaled_e</span> );
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_een_rescaled_e_hpc</span> (
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">rescale_factor_ee</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">ee_distance</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">een_rescaled_e</span> );
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c">    <span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_een_rescaled_e</span> (
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">rescale_factor_ee</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">ee_distance</span>,
          <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">een_rescaled_e</span> ) {

<span style="color: #483d8b;">#ifdef</span> HAVE_HPC
    <span style="color: #a020f0;">return</span> qmckl_compute_een_rescaled_e_hpc
<span style="color: #483d8b;">#else</span>
    <span style="color: #a020f0;">return</span> qmckl_compute_een_rescaled_e_doc
<span style="color: #483d8b;">#endif</span>
      (context, walk_num, elec_num, cord_num, rescale_factor_ee, ee_distance, een_rescaled_e);
    }
</pre>
</div>
</div>
</div>

<div id="outline-container-org72a1147" class="outline-5">
<h5 id="org72a1147"><span class="section-number-5">4.3.1.3.</span> Test</h5>
<div class="outline-text-5" id="text-4-3-1-3">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #0000ff;">assert</span>(<span style="color: #228b22;">qmckl_electron_provided</span>(<span style="color: #a0522d;">context</span>));
{

  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">een_rescaled_e</span>[walk_num][(cord_num + 1)][elec_num][elec_num];
  rc = qmckl_get_jastrow_champ_een_rescaled_e(context, &amp;(een_rescaled_e[0][0][0][0]),elec_num*elec_num*(cord_num+1)*walk_num);

  assert( fabs(een_rescaled_e[0][0][0][0] - (0.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][0][0][1] - (1.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][0][0][2] - (1.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][0][1][0] - (1.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][0][1][1] - (0.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][0][1][2] - (1.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][0][2][0] - (1.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][0][2][1] - (1.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][0][2][2] - (0.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][1][0][0] - (0.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][1][0][1] - (0.6191495547586775)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][1][0][2] - (0.2211015082992776)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][1][1][0] - (0.6191495547586775)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][1][1][1] - (0.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][1][1][2] - (0.1891080158548495)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][1][2][0] - (0.2211015082992776)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][1][2][1] - (0.1891080158548495)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][1][2][2] - (0.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][2][0][0] - (0.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][2][0][1] - (0.38334617115786856)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][2][0][2] - (0.048885876972215525)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][2][1][0] - (0.38334617115786856)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][2][1][1] - (0.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][2][1][2] - (0.03576184166055801)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][2][2][0] - (0.048885876972215525)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][2][2][1] - (0.03576184166055801)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][2][2][2] - (0.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][3][0][0] - (0.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][3][0][1] - (0.23734861119083814)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][3][0][2] - (0.010808741133089782)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][3][1][0] - (0.23734861119083814)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][3][1][1] - (0.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][3][1][2] - (0.006762850919743422)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][3][2][0] - (0.010808741133089782)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][3][2][1] - (0.006762850919743422)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][3][2][2] - (0.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][4][0][0] - (0.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][4][0][1] - (0.14695428694139787)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][4][0][2] - (0.002389828967342592)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][4][1][0] - (0.14695428694139787)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][4][1][1] - (0.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][4][1][2] - (0.0012789093189548221)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][4][2][0] - (0.002389828967342592)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][4][2][1] - (0.0012789093189548221)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][4][2][2] - (0.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][5][0][0] - (0.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][5][0][1] - (0.09098668132964542)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][5][0][2] - (0.0005283947892567522)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][5][1][0] - (0.09098668132964542)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][5][1][1] - (0.0)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][5][1][2] - (0.0002418520037658232)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][5][2][0] - (0.0005283947892567522)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][5][2][1] - (0.0002418520037658232)) &lt; 1.e-10 );
  assert( fabs(een_rescaled_e[0][5][2][2] - (0.0)) &lt; 1.e-10 );
}

{
  printf(<span style="color: #8b2252;">"een_rescaled_e_hpc\n"</span>);
  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">ee_distance</span>[walk_num * elec_num * elec_num];
  rc = qmckl_get_electron_ee_distance(context, &amp;(ee_distance[0]), walk_num*elec_num*elec_num);
  assert(rc == QMCKL_SUCCESS);

  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">een_rescaled_e_doc</span>[walk_num][cord_num+1][elec_num][elec_num];
  memset(&amp;(een_rescaled_e_doc[0][0][0][0]), 0, <span style="color: #a020f0;">sizeof</span>(een_rescaled_e_doc));
  rc = qmckl_compute_een_rescaled_e(context, walk_num, elec_num, cord_num,
                                    rescale_factor_ee, &amp;(ee_distance[0]), &amp;(een_rescaled_e_doc[0][0][0][0]));
  assert(rc == QMCKL_SUCCESS);

  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">een_rescaled_e_hpc</span>[walk_num][cord_num+1][elec_num][elec_num];
  memset(&amp;(een_rescaled_e_hpc[0][0][0][0]), 0, <span style="color: #a020f0;">sizeof</span>(een_rescaled_e_hpc));
  rc = qmckl_compute_een_rescaled_e_hpc(context, walk_num, elec_num, cord_num,
                                        rescale_factor_ee, &amp;(ee_distance[0]), &amp;(een_rescaled_e_hpc[0][0][0][0]));
  assert(rc == QMCKL_SUCCESS);

  <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">i</span> = 0; i &lt; walk_num; i++) {
    <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">j</span> = 0; j &lt; cord_num+1; j++) {
      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">k</span> = 0; k &lt; elec_num; k++) {
        <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">l</span> = 0; l &lt; elec_num; l++) {
          <span style="color: #a020f0;">if</span> (fabs(een_rescaled_e_doc[i][j][k][l] - een_rescaled_e_hpc[i][j][k][l]) &gt; 1.e-12) {
            printf(<span style="color: #8b2252;">"i=%ld j=%ld k=%ld l=%ld doc=%f hpc=%f\n"</span>, i, j, k, l, een_rescaled_e_doc[i][j][k][l], een_rescaled_e_hpc[i][j][k][l]);
            fflush(stdout);
          }
          assert(fabs(een_rescaled_e_doc[i][j][k][l] - een_rescaled_e_hpc[i][j][k][l]) &lt; 1.e-8);
        }
      }
    }
  }
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgd2b3893" class="outline-4">
<h4 id="orgd2b3893"><span class="section-number-4">4.3.2.</span> Electron-electron rescaled distances derivatives in \(J_\text{eeN}\)</h4>
<div class="outline-text-4" id="text-4-3-2">
<p>
<code>een_rescaled_e_gl</code> stores the table of the derivatives of the
rescaled distances between all pairs of electrons and raised to the
power \(p\) defined by <code>cord_num</code>.  Here we take its derivatives
required for the een jastrow<sub>champ</sub>.
</p>

<p>
\[ \frac{\partial}{\partial x} \left[ {g_\text{e}(r)}\right]^p =
    -\frac{x}{r} \kappa_\text{e}\, p\,\left[ {g_\text{e}(r)}\right]^p \]
</p>

<p>
\[ \Delta \left[ {g_\text{e}(r)}\right]^p = \kappa_\text{e}\,
    p\,\left[ - \frac{2}{r} + \kappa_\text{e}\, p \right] \left[
    {g_\text{e}(r)} \right]^p \]
</p>

<p>
Derivatives are set to zero at \(r_{ii}\) to avoid NaNs.
</p>
</div>

<div id="outline-container-org1ead28a" class="outline-5">
<h5 id="org1ead28a"><span class="section-number-5">4.3.2.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-3-2-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_een_rescaled_e_gl</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                          <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">een_rescaled_e_gl</span>,
                                          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-org24b4852" class="outline-5">
<h5 id="org24b4852"><span class="section-number-5">4.3.2.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-3-2-2">
<table id="orgff01bb5" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>cord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Order of polynomials</td>
</tr>

<tr>
<td class="org-left"><code>rescale_factor_ee</code></td>
<td class="org-left"><code>double</code></td>
<td class="org-left">in</td>
<td class="org-left">Factor to rescale ee distances</td>
</tr>

<tr>
<td class="org-left"><code>coord_ee</code></td>
<td class="org-left"><code>double[3][walk_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron coordinates</td>
</tr>

<tr>
<td class="org-left"><code>ee_distance</code></td>
<td class="org-left"><code>double[walk_num][elec_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-electron distances</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_e</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][elec_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-electron distances</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_e_gl</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][elec_num][4][elec_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">Electron-electron rescaled distances</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_rescaled_e_gl_doc</span>( <span style="color: #a020f0;">&amp;</span>
     context, walk_num, elec_num, cord_num, rescale_factor_ee,  <span style="color: #a020f0;">&amp;</span>
     coord_ee, ee_distance, een_rescaled_e, een_rescaled_e_gl) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>  ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>)    , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>  ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>)    , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>  ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>)    , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>  ::<span style="color: #a0522d;"> cord_num</span>
  <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>)        , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>  ::<span style="color: #a0522d;"> rescale_factor_ee</span>
  <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>)        , <span style="color: #a020f0;">intent</span>(in)  ::<span style="color: #a0522d;"> coord_ee(elec_num,walk_num,3)</span>
  <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>)        , <span style="color: #a020f0;">intent</span>(in)  ::<span style="color: #a0522d;"> ee_distance(elec_num,elec_num,walk_num)</span>
  <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>)        , <span style="color: #a020f0;">intent</span>(in)  ::<span style="color: #a0522d;"> een_rescaled_e(elec_num,elec_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>)        , <span style="color: #a020f0;">intent</span>(out) ::<span style="color: #a0522d;"> een_rescaled_e_gl(elec_num,4,elec_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)            ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">double precision</span>, <span style="color: #a020f0;">allocatable</span>       ::<span style="color: #a0522d;"> elec_dist_gl(:,:,:)</span>
  <span style="color: #228b22;">double precision</span>                    ::<span style="color: #a0522d;"> x, kappa_l</span>
  <span style="color: #228b22;">integer</span>*8                           ::<span style="color: #a0522d;"> i, j, k, l, nw, ii</span>

  <span style="color: #228b22;">double precision</span>  ::<span style="color: #a0522d;"> rij_inv(elec_num)</span>


  <span style="color: #a020f0;">allocate</span>(elec_dist_gl(elec_num, 4, elec_num))
  elec_dist_gl = 0.d0
  een_rescaled_e_gl = 0.d0

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_3
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (cord_num &lt; 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_4
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">do</span> nw = 1, walk_num

     ! <span style="color: #b22222;">Prepare table of exponentiated distances raised to appropriate power</span>
     <span style="color: #a020f0;">do</span> j = 1, elec_num
        <span style="color: #a020f0;">do</span> i = 1, j-1
           rij_inv(i) = 1.0d0 / ee_distance(i, j, nw)
        <span style="color: #a020f0;">enddo</span>
        rij_inv(j) = 0.0d0
        <span style="color: #a020f0;">do</span> i = j+1, elec_num
           rij_inv(i) = 1.0d0 / ee_distance(i, j, nw)
        <span style="color: #a020f0;">enddo</span>
        <span style="color: #a020f0;">do</span> i = 1, elec_num
           <span style="color: #a020f0;">do</span> ii = 1, 3
              elec_dist_gl(i, ii, j) = (coord_ee(i, nw, ii) - coord_ee(j, nw, ii)) * rij_inv(i)
           <span style="color: #a020f0;">end do</span>
           elec_dist_gl(i, 4, j) = 2.0d0 * rij_inv(i)
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>

     !   <span style="color: #b22222;">Not necessary: should be set to zero by qmckl_malloc</span>
     een_rescaled_e_gl(:,:,:,0,nw) = 0.d0

     <span style="color: #a020f0;">do</span> l = 1, cord_num
        kappa_l = -<span style="color: #a020f0;">dble</span>(l) * rescale_factor_ee
        <span style="color: #a020f0;">do</span> j = 1, elec_num
           <span style="color: #a020f0;">do</span> i = 1, elec_num
              <span style="color: #a020f0;">if</span> (i /= j) <span style="color: #a020f0;">then</span>
                 een_rescaled_e_gl(i, 1, j, l, nw) = kappa_l *  elec_dist_gl(i, 1, j) * een_rescaled_e(i,j,l,nw)
                 een_rescaled_e_gl(i, 2, j, l, nw) = kappa_l *  elec_dist_gl(i, 2, j) * een_rescaled_e(i,j,l,nw)
                 een_rescaled_e_gl(i, 3, j, l, nw) = kappa_l *  elec_dist_gl(i, 3, j) * een_rescaled_e(i,j,l,nw)
                 een_rescaled_e_gl(i, 4, j, l, nw) = kappa_l * (elec_dist_gl(i, 4, j) + kappa_l) * een_rescaled_e(i,j,l,nw)
              <span style="color: #a020f0;">else</span>
                 een_rescaled_e_gl(i, 1, j, l, nw) = 0.d0
                 een_rescaled_e_gl(i, 2, j, l, nw) = 0.d0
                 een_rescaled_e_gl(i, 3, j, l, nw) = 0.d0
                 een_rescaled_e_gl(i, 4, j, l, nw) = 0.d0
              <span style="color: #a020f0;">end if</span>
           <span style="color: #a020f0;">end do</span>
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_rescaled_e_gl_doc</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_rescaled_e_gl_hpc</span> (<span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                                          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
                                                          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
                                                          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
                                                          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">rescale_factor_ee</span>,
                                                          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">coord_ee</span>,
                                                          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">ee_distance</span>,
                                                          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">een_rescaled_e</span>,
                                                          <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">een_rescaled_e_gl</span> )
{
  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">return</span> QMCKL_INVALID_CONTEXT;
  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_2;
  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_3;
  <span style="color: #a020f0;">if</span> (cord_num &lt; 0) <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_4;

<span style="color: #483d8b;">#ifdef</span> HAVE_OPENMP
<span style="color: #483d8b;">#pragma</span> omp parallel
<span style="color: #483d8b;">#endif</span>
  {

    <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">elec_dist_gl0</span> = (<span style="color: #228b22;">double</span>*) calloc(elec_num * elec_num, <span style="color: #a020f0;">sizeof</span>(<span style="color: #228b22;">double</span>));
    <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">elec_dist_gl1</span> = (<span style="color: #228b22;">double</span>*) calloc(elec_num * elec_num, <span style="color: #a020f0;">sizeof</span>(<span style="color: #228b22;">double</span>));
    <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">elec_dist_gl2</span> = (<span style="color: #228b22;">double</span>*) calloc(elec_num * elec_num, <span style="color: #a020f0;">sizeof</span>(<span style="color: #228b22;">double</span>));
    <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">elec_dist_gl3</span> = (<span style="color: #228b22;">double</span>*) calloc(elec_num * elec_num, <span style="color: #a020f0;">sizeof</span>(<span style="color: #228b22;">double</span>));
    assert (elec_dist_gl0 != <span style="color: #008b8b;">NULL</span>);
    assert (elec_dist_gl1 != <span style="color: #008b8b;">NULL</span>);
    assert (elec_dist_gl2 != <span style="color: #008b8b;">NULL</span>);
    assert (elec_dist_gl3 != <span style="color: #008b8b;">NULL</span>);

<span style="color: #483d8b;">#ifdef</span> HAVE_OPENMP
<span style="color: #483d8b;">#pragma</span> omp <span style="color: #a020f0;">for</span>
<span style="color: #483d8b;">#endif</span>
    <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nw</span> = 0; nw &lt; walk_num; ++nw) {

      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">j</span>=0; j&lt;elec_num; ++j) {

        <span style="color: #228b22;">double</span> <span style="color: #a0522d;">rij_inv</span>[elec_num];

<span style="color: #483d8b;">#ifdef</span> HAVE_OPENMP
<span style="color: #483d8b;">#pragma</span> omp simd
<span style="color: #483d8b;">#endif</span>
        <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">i</span> = 0; i &lt; elec_num ; ++i) {
          rij_inv[i] = ee_distance[i+j*elec_num+nw*elec_num*elec_num];
        }

        rij_inv[j] = 1.0;
<span style="color: #483d8b;">#ifdef</span> HAVE_OPENMP
<span style="color: #483d8b;">#pragma</span> omp simd
<span style="color: #483d8b;">#endif</span>
        <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">i</span> = 0; i &lt; elec_num ; ++i) {
          rij_inv[i] = 1.0/rij_inv[i];
        }
        rij_inv[j] = 0.0;

        <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">xj</span> = coord_ee[j+elec_num*nw];
        <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">yj</span> = coord_ee[j+elec_num*(nw+walk_num) ];
        <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">zj</span> = coord_ee[j+elec_num*(nw+walk_num*2)];

<span style="color: #483d8b;">#ifdef</span> HAVE_OPENMP
<span style="color: #483d8b;">#pragma</span> omp simd
<span style="color: #483d8b;">#endif</span>
        <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">i</span> = 0; i &lt; elec_num ; ++i) {

          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">xi</span> = coord_ee[i+elec_num*nw];
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">yi</span> = coord_ee[i+elec_num*(nw+walk_num) ];
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">zi</span> = coord_ee[i+elec_num*(nw+walk_num*2)];

          elec_dist_gl0[i + j * elec_num] = rij_inv[i] * (xi-xj);
          elec_dist_gl1[i + j * elec_num] = rij_inv[i] * (yi-yj);
          elec_dist_gl2[i + j * elec_num] = rij_inv[i] * (zi-zj);
          elec_dist_gl3[i + j * elec_num] = rij_inv[i] + rij_inv[i];
        }
      }

      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">eegl</span> = &amp;een_rescaled_e_gl[elec_num*4*elec_num*(cord_num+1)*nw];
      memset(eegl, 0, 4*elec_num*elec_num*<span style="color: #a020f0;">sizeof</span>(<span style="color: #228b22;">double</span>));

      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">l</span>=1; l&lt;=cord_num; ++l) {

        <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">kappa_l</span>  = -rescale_factor_ee * (<span style="color: #228b22;">double</span>) l;

        <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">j</span>=0; j&lt;elec_num; ++j) {

          <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">eegl</span> =
            &amp;een_rescaled_e_gl[elec_num*4*(j+elec_num*(l+(cord_num+1)*nw))];

          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">restrict</span> <span style="color: #a0522d;">ee</span> =
            &amp;een_rescaled_e[elec_num*(j+elec_num*(l+(cord_num+1)*nw))];

          <span style="color: #228b22;">double</span> <span style="color: #a0522d;">kee</span>[elec_num];
<span style="color: #483d8b;">#ifdef</span> HAVE_OPENMP
<span style="color: #483d8b;">#pragma</span> omp simd
<span style="color: #483d8b;">#endif</span>
          <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">i</span>=0; i&lt;elec_num; ++i) {
            kee[i] = kappa_l * ee[i];
          }

<span style="color: #483d8b;">#ifdef</span> HAVE_OPENMP
<span style="color: #483d8b;">#pragma</span> omp simd
<span style="color: #483d8b;">#endif</span>
          <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">i</span>=0; i&lt;elec_num; ++i) {
            eegl[i           ] = kee[i] *  elec_dist_gl0[i+j*elec_num];
            eegl[i+elec_num  ] = kee[i] *  elec_dist_gl1[i+j*elec_num];
            eegl[i+elec_num*2] = kee[i] *  elec_dist_gl2[i+j*elec_num];
            eegl[i+elec_num*3] = kee[i] * (elec_dist_gl3[i+j*elec_num] + kappa_l);
          }
          eegl[j           ] = 0.0;
          eegl[j+elec_num  ] = 0.0;
          eegl[j+elec_num*2] = 0.0;
          eegl[j+elec_num*3] = 0.0;
        }
      }
    }

    free(elec_dist_gl0);
    free(elec_dist_gl1);
    free(elec_dist_gl2);
    free(elec_dist_gl3);
  }

  <span style="color: #a020f0;">return</span> QMCKL_SUCCESS;
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_rescaled_e_gl</span> (
         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> <span style="color: #a0522d;">rescale_factor_ee</span>,
         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">coord_ee</span>,
         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">ee_distance</span>,
         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">een_rescaled_e</span>,
         <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">een_rescaled_e_gl</span> )
{
<span style="color: #483d8b;">#ifdef</span> HAVE_HPC
  <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_factor_een_rescaled_e_gl_hpc
<span style="color: #483d8b;">#else</span>
  <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_factor_een_rescaled_e_gl_doc
<span style="color: #483d8b;">#endif</span>
    (context, walk_num, elec_num, cord_num, rescale_factor_ee,
    coord_ee, ee_distance, een_rescaled_e, een_rescaled_e_gl );
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org388d78d" class="outline-4">
<h4 id="org388d78d"><span class="section-number-4">4.3.3.</span> Electron-nucleus rescaled distances in \(J_\text{eeN}\)</h4>
<div class="outline-text-4" id="text-4-3-3">
<p>
<code>een_rescaled_n</code> stores the table of the rescaled distances between
electrons and nuclei raised to the power \(p\) defined by <code>cord_num</code>:
</p>

<p>
\[
    [g_{\alpha}(R_{i\alpha})]^p = \exp\left(-p\, \kappa_\alpha\, R_{i\alpha}\right) 
    \]
</p>

<p>
where \(R_{i\alpha}\) is the matrix of electron-nucleus distances.
</p>
</div>

<div id="outline-container-orgf3e946c" class="outline-5">
<h5 id="orgf3e946c"><span class="section-number-5">4.3.3.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-3-3-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_een_rescaled_n</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                 <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">een_rescaled_n</span>,
                                 <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-org0390a82" class="outline-5">
<h5 id="org0390a82"><span class="section-number-5">4.3.3.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-3-3-2">
<table id="orga3a104a" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of atoms</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of atom types</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_vector</code></td>
<td class="org-left"><code>int64_t[nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Types of atoms</td>
</tr>

<tr>
<td class="org-left"><code>cord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Order of polynomials</td>
</tr>

<tr>
<td class="org-left"><code>rescale_factor_en</code></td>
<td class="org-left"><code>double[nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Factor to rescale ee distances</td>
</tr>

<tr>
<td class="org-left"><code>en_distance</code></td>
<td class="org-left"><code>double[walk_num][elec_num][nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus distances</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][nucl_num][elec_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">Electron-nucleus rescaled distances</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_een_rescaled_n</span>( <span style="color: #a020f0;">&amp;</span>
     context, walk_num, elec_num, nucl_num, <span style="color: #a020f0;">&amp;</span>
     type_nucl_num, type_nucl_vector, cord_num, rescale_factor_en,  <span style="color: #a020f0;">&amp;</span>
     en_distance, een_rescaled_n) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> type_nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> type_nucl_vector(nucl_num)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> cord_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> rescale_factor_en(nucl_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> en_distance(nucl_num,elec_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> een_rescaled_n(elec_num,nucl_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">double precision</span>                    ::<span style="color: #a0522d;"> x</span>
  <span style="color: #228b22;">integer</span>*8                           ::<span style="color: #a0522d;"> i, a, k, l, nw</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_3
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (nucl_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_4
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (cord_num &lt; 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_5
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">do</span> nw = 1, walk_num

     ! <span style="color: #b22222;">prepare the actual een table</span>
     een_rescaled_n(:, :, 0, nw) = 1.0d0

     <span style="color: #a020f0;">do</span> a = 1, nucl_num
        <span style="color: #a020f0;">do</span> i = 1, elec_num
           een_rescaled_n(i, a, 1, nw) = dexp(-rescale_factor_en(type_nucl_vector(a)+1) * en_distance(a, i, nw))
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>

     <span style="color: #a020f0;">do</span> l = 2, cord_num
        <span style="color: #a020f0;">do</span> a = 1, nucl_num
           <span style="color: #a020f0;">do</span> i = 1, elec_num
              een_rescaled_n(i, a, l, nw) = een_rescaled_n(i, a, l - 1, nw) * een_rescaled_n(i, a, 1, nw)
           <span style="color: #a020f0;">end do</span>
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>

  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_een_rescaled_n</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c">/*
<span style="color: #b22222;">qmckl_exit_code qmckl_compute_een_rescaled_n_hpc (</span>
<span style="color: #b22222;">      const qmckl_context context,</span>
<span style="color: #b22222;">      const int64_t walk_num,</span>
<span style="color: #b22222;">      const int64_t elec_num,</span>
<span style="color: #b22222;">      const int64_t nucl_num,</span>
<span style="color: #b22222;">      const int64_t type_nucl_num,</span>
<span style="color: #b22222;">      int64_t* const type_nucl_vector,</span>
<span style="color: #b22222;">      const int64_t cord_num,</span>
<span style="color: #b22222;">      const double* rescale_factor_en,</span>
<span style="color: #b22222;">      const double* en_distance,</span>
<span style="color: #b22222;">      double* const een_rescaled_n ) {</span>


<span style="color: #b22222;">  if (context == QMCKL_NULL_CONTEXT) {</span>
<span style="color: #b22222;">    return QMCKL_INVALID_CONTEXT;</span>
<span style="color: #b22222;">  }</span>

<span style="color: #b22222;">  if (walk_num &lt;= 0) {</span>
<span style="color: #b22222;">    return QMCKL_INVALID_ARG_2;</span>
<span style="color: #b22222;">  }</span>

<span style="color: #b22222;">  if (elec_num &lt;= 0) {</span>
<span style="color: #b22222;">    return QMCKL_INVALID_ARG_3;</span>
<span style="color: #b22222;">  }</span>

<span style="color: #b22222;">  if (nucl_num &lt;= 0) {</span>
<span style="color: #b22222;">    return QMCKL_INVALID_ARG_4;</span>
<span style="color: #b22222;">  }</span>

<span style="color: #b22222;">  if (cord_num &lt; 0) {</span>
<span style="color: #b22222;">    return QMCKL_INVALID_ARG_5;</span>
<span style="color: #b22222;">  }</span>

<span style="color: #b22222;">  // Prepare table of exponentiated distances raised to appropriate power</span>
<span style="color: #b22222;">  for (int i = 0; i &lt; (walk_num*(cord_num+1)*nucl_num*elec_num); ++i) {</span>
<span style="color: #b22222;">    een_rescaled_n[i] = 1.0;</span>
<span style="color: #b22222;">  }</span>

<span style="color: #b22222;">  for (int nw = 0; nw &lt; walk_num; ++nw) {</span>
<span style="color: #b22222;">    for (int a = 0; a &lt; nucl_num; ++a) {</span>
<span style="color: #b22222;">      for (int i = 0; i &lt; elec_num; ++i) {</span>
<span style="color: #b22222;">        een_rescaled_n[i + a*elec_num + nw * elec_num*nucl_num*(cord_num+1)] = 1.0;</span>
<span style="color: #b22222;">        een_rescaled_n[i + a*elec_num + elec_num*nucl_num + nw*elec_num*nucl_num*(cord_num+1)] =</span>
<span style="color: #b22222;">          exp(-rescale_factor_en[type_nucl_vector[a]] * en_distance[a + i*nucl_num + nw*elec_num*nucl_num]);</span>
<span style="color: #b22222;">      }</span>
<span style="color: #b22222;">    }</span>

<span style="color: #b22222;">    for (int l = 2; l &lt; (cord_num+1); ++l){</span>
<span style="color: #b22222;">      for (int a = 0; a &lt; nucl_num; ++a) {</span>
<span style="color: #b22222;">        for (int i = 0; i &lt; elec_num; ++i) {</span>
<span style="color: #b22222;">          een_rescaled_n[i + a*elec_num + l*elec_num*nucl_num + nw*elec_num*nucl_num*(cord_num+1)] =</span>
<span style="color: #b22222;">            een_rescaled_n[i + a*elec_num + (l-1)*elec_num*nucl_num + nw*elec_num*nucl_num*(cord_num+1)] *</span>
<span style="color: #b22222;">            een_rescaled_n[i + a*elec_num +       elec_num*nucl_num + nw*elec_num*nucl_num*(cord_num+1)];</span>
<span style="color: #b22222;">        }</span>
<span style="color: #b22222;">      }</span>
<span style="color: #b22222;">    }</span>

<span style="color: #b22222;">  }</span>

<span style="color: #b22222;">  return QMCKL_SUCCESS;</span>
<span style="color: #b22222;">}</span>
*/
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org6c6c47e" class="outline-4">
<h4 id="org6c6c47e"><span class="section-number-4">4.3.4.</span> Electron-nucleus rescaled distances derivatives in \(J_\text{eeN}\)</h4>
<div class="outline-text-4" id="text-4-3-4">
<p>
<code>een_rescaled_n_gl</code> stores the table of the derivatives of the
rescaled distances between all electron-nucleus pairs and raised to the
power \(p\) defined by <code>cord_num</code>.  Here we take its derivatives
required for the een jastrow<sub>champ</sub>.
</p>

<p>
\[ \frac{\partial}{\partial x} \left[ {g_\alpha(R_{i\alpha})}\right]^p =
    -\frac{x}{R_{i\alpha}} \kappa_\alpha\, p\,\left[ {g_\alpha(R_{i\alpha})}\right]^p \]
\[ \Delta \left[ {g_\alpha(R_{i\alpha})}\right]^p = \frac{2}{R_{i\alpha}}
    \kappa_\alpha\, p\,\left[ {g_\alpha(R_{i\alpha})}\right]^p \right]  +
    \left(\frac{\partial}{\partial x}\left[ {g_\alpha(R_{i\alpha})}\right]^p
    \right)^2 + \left(\frac{\partial}{\partial y}\left[
    {g_\alpha(R_{i\alpha})}\right]^p \right)^2 + \left(\frac{\partial}{\partial
    z}\left[ {g_\alpha(R_{i\alpha})}\right]^p \right)^2 \]
</p>
</div>

<div id="outline-container-orge3b7f72" class="outline-5">
<h5 id="orge3b7f72"><span class="section-number-5">4.3.4.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-3-4-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_een_rescaled_n_gl</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                         <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">een_rescaled_n_gl</span>,
                                         <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-org55310d7" class="outline-5">
<h5 id="org55310d7"><span class="section-number-5">4.3.4.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-3-4-2">
<table id="org95eaa9d" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of atoms</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of atom types</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_vector</code></td>
<td class="org-left"><code>int64_t[nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Types of atoms</td>
</tr>

<tr>
<td class="org-left"><code>cord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Order of polynomials</td>
</tr>

<tr>
<td class="org-left"><code>rescale_factor_en</code></td>
<td class="org-left"><code>double[nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Factor to rescale ee distances</td>
</tr>

<tr>
<td class="org-left"><code>coord_ee</code></td>
<td class="org-left"><code>double[3][walk_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron coordinates</td>
</tr>

<tr>
<td class="org-left"><code>coord_n</code></td>
<td class="org-left"><code>double[3][nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Nuclear coordinates</td>
</tr>

<tr>
<td class="org-left"><code>en_distance</code></td>
<td class="org-left"><code>double[walk_num][elec_num][nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus distances</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][nucl_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus distances</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n_gl</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][nucl_num][4][elec_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">Electron-nucleus rescaled distances</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_rescaled_n_gl</span>( <span style="color: #a020f0;">&amp;</span>
     context, walk_num, elec_num, nucl_num, type_nucl_num, type_nucl_vector, <span style="color: #a020f0;">&amp;</span>
     cord_num, rescale_factor_en, <span style="color: #a020f0;">&amp;</span>
     coord_ee, coord_n, en_distance, een_rescaled_n, een_rescaled_n_gl) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> type_nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> type_nucl_vector(nucl_num)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> cord_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> rescale_factor_en(nucl_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> coord_ee(elec_num,walk_num,3)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> coord_n(nucl_num,3)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> en_distance(nucl_num,elec_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> een_rescaled_n(elec_num,nucl_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> een_rescaled_n_gl(elec_num,4,nucl_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">double precision</span>,<span style="color: #a020f0;">allocatable</span>        ::<span style="color: #a0522d;"> elnuc_dist_gl(:,:,:)</span>
  <span style="color: #228b22;">double precision</span>                    ::<span style="color: #a0522d;"> x, ria_inv, kappa_l</span>
  <span style="color: #228b22;">integer</span>*8                           ::<span style="color: #a0522d;"> i, a, k, l, nw, ii</span>

  <span style="color: #a020f0;">allocate</span>(elnuc_dist_gl(elec_num, 4, nucl_num))

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_3
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (nucl_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_4
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (cord_num &lt; 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_5
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  ! <span style="color: #b22222;">Prepare table of exponentiated distances raised to appropriate power</span>
  een_rescaled_n_gl             = 0.0d0
  <span style="color: #a020f0;">do</span> nw = 1, walk_num

     ! <span style="color: #b22222;">prepare the actual een table</span>
     <span style="color: #a020f0;">do</span> a = 1, nucl_num
        <span style="color: #a020f0;">do</span> i = 1, elec_num
           ria_inv = 1.0d0 / en_distance(a, i, nw)
           <span style="color: #a020f0;">do</span> ii = 1, 3
              elnuc_dist_gl(i, ii, a) = (coord_ee(i, nw, ii) - coord_n(a, ii)) * ria_inv
           <span style="color: #a020f0;">end do</span>
           elnuc_dist_gl(i, 4, a) = 2.0d0 * ria_inv
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>

     <span style="color: #a020f0;">do</span> l = 0, cord_num
        <span style="color: #a020f0;">do</span> a = 1, nucl_num
           kappa_l = - <span style="color: #a020f0;">dble</span>(l) * rescale_factor_en(type_nucl_vector(a)+1)
           <span style="color: #a020f0;">do</span> i = 1, elec_num
              een_rescaled_n_gl(i, 1, a, l, nw) = kappa_l * elnuc_dist_gl(i, 1, a)
              een_rescaled_n_gl(i, 2, a, l, nw) = kappa_l * elnuc_dist_gl(i, 2, a)
              een_rescaled_n_gl(i, 3, a, l, nw) = kappa_l * elnuc_dist_gl(i, 3, a)
              een_rescaled_n_gl(i, 4, a, l, nw) = kappa_l * elnuc_dist_gl(i, 4, a)

              een_rescaled_n_gl(i, 4, a, l, nw) = een_rescaled_n_gl(i, 4, a, l, nw)           <span style="color: #a020f0;">&amp;</span>
                   + een_rescaled_n_gl(i, 1, a, l, nw) * een_rescaled_n_gl(i, 1, a, l, nw) <span style="color: #a020f0;">&amp;</span>
                   + een_rescaled_n_gl(i, 2, a, l, nw) * een_rescaled_n_gl(i, 2, a, l, nw) <span style="color: #a020f0;">&amp;</span>
                   + een_rescaled_n_gl(i, 3, a, l, nw) * een_rescaled_n_gl(i, 3, a, l, nw)

              een_rescaled_n_gl(i, 1, a, l, nw) = een_rescaled_n_gl(i, 1, a, l, nw) * <span style="color: #a020f0;">&amp;</span>
                   een_rescaled_n(i, a, l, nw)
              een_rescaled_n_gl(i, 2, a, l, nw) = een_rescaled_n_gl(i, 2, a, l, nw) * <span style="color: #a020f0;">&amp;</span>
                   een_rescaled_n(i, a, l, nw)
              een_rescaled_n_gl(i, 3, a, l, nw) = een_rescaled_n_gl(i, 3, a, l, nw) * <span style="color: #a020f0;">&amp;</span>
                   een_rescaled_n(i, a, l, nw)
              een_rescaled_n_gl(i, 4, a, l, nw) = een_rescaled_n_gl(i, 4, a, l, nw) * <span style="color: #a020f0;">&amp;</span>
                   een_rescaled_n(i, a, l, nw)
           <span style="color: #a020f0;">end do</span>
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_rescaled_n_gl</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org407b09a" class="outline-4">
<h4 id="org407b09a"><span class="section-number-4">4.3.5.</span> Temporary arrays for electron-electron-nucleus Jastrow \(f_{een}\)</h4>
<div class="outline-text-4" id="text-4-3-5">
<p>
Prepare <code>c_vector_full</code> and <code>lkpm_combined_index</code> tables required for the
calculation of the three-body jastrow <code>factor_een</code> and its derivative
<code>factor_een_gl</code>.
</p>

<p>
The array <code>tmp_c</code> corresponds to the tensor \(P\) defined at the
beginning of this section:
</p>

<p>
\[ P_{i\alpha}^{km} = 
      \sum_{j=1}^{N_{\text{elec}}} 
             \left[ g_\text{e}({r}_{ij}) \right]^k
             \left[ g_\alpha({R}_{j\alpha}) \right]^{m}
             \]
</p>

<p>
\[ \nabla_i P_{i\alpha}^{km} = 
      \sum_{j=1}^{N_{\text{elec}}} 
             \nabla_i \left[ g_\text{e}({r}_{ij}) \right]^k
             \left[ g_\alpha({R}_{j\alpha}) \right]^{m}
             \]
</p>
</div>
<div id="outline-container-orgbba6149" class="outline-5">
<h5 id="orgbba6149"><span class="section-number-5">4.3.5.1.</span> Compute dim<sub>c</sub><sub>vector</sub></h5>
<div class="outline-text-5" id="text-4-3-5-1">
<p>
Computes the dimension of the vector of parameters.
</p>

<table border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-right" />

<col  class="org-right" />
</colgroup>
<tbody>
<tr>
<td class="org-right">\(N_{ord}\)</td>
<td class="org-right">Number of parameters</td>
</tr>

<tr>
<td class="org-right">&#xa0;</td>
<td class="org-right">&#xa0;</td>
</tr>

<tr>
<td class="org-right">1</td>
<td class="org-right">0</td>
</tr>

<tr>
<td class="org-right">2</td>
<td class="org-right">2</td>
</tr>

<tr>
<td class="org-right">3</td>
<td class="org-right">6</td>
</tr>

<tr>
<td class="org-right">4</td>
<td class="org-right">13</td>
</tr>

<tr>
<td class="org-right">5</td>
<td class="org-right">23</td>
</tr>

<tr>
<td class="org-right">6</td>
<td class="org-right">37</td>
</tr>

<tr>
<td class="org-right">7</td>
<td class="org-right">55</td>
</tr>

<tr>
<td class="org-right">8</td>
<td class="org-right">78</td>
</tr>

<tr>
<td class="org-right">9</td>
<td class="org-right">106</td>
</tr>

<tr>
<td class="org-right">10</td>
<td class="org-right">140</td>
</tr>
</tbody>
</table>

<table id="orgabe70de" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>cord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Order of polynomials</td>
</tr>

<tr>
<td class="org-left"><code>dim_c_vector</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">out</td>
<td class="org-left">Number of parameters per atom type</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_dim_c_vector_doc</span>( <span style="color: #a020f0;">&amp;</span>
     context, cord_num, dim_c_vector) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> cord_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> dim_c_vector</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">double precision</span>                    ::<span style="color: #a0522d;"> x</span>
  <span style="color: #228b22;">integer</span>*8                           ::<span style="color: #a0522d;"> i, a, k, l, p, lmax</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (cord_num &lt; 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  dim_c_vector = 0

  <span style="color: #a020f0;">do</span> p = 2, cord_num
    <span style="color: #a020f0;">do</span> k = p - 1, 0, -1
      <span style="color: #a020f0;">if</span> (k <span style="color: #a020f0;">.ne.</span> 0) <span style="color: #a020f0;">then</span>
        lmax = p - k
      <span style="color: #a020f0;">else</span>
        lmax = p - k - 2
      <span style="color: #a020f0;">endif</span>
      <span style="color: #a020f0;">do</span> l = lmax, 0, -1
        <span style="color: #a020f0;">if</span> (<span style="color: #a020f0;">iand</span>(p - k - l, 1_8) == 1) <span style="color: #a020f0;">cycle</span>
        dim_c_vector = dim_c_vector + 1
      <span style="color: #a020f0;">end do</span>
    <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_dim_c_vector_doc</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orgeca1056" class="outline-5">
<h5 id="orgeca1056"><span class="section-number-5">4.3.5.2.</span> Get</h5>
<div class="outline-text-5" id="text-4-3-5-2">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_tmp_c</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                              <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">tmp_c</span>,
                              <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);

<span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_dtmp_c</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                               <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">dtmp_c</span>,
                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>
</div>

<div id="outline-container-orgdf879ab" class="outline-5">
<h5 id="orgdf879ab"><span class="section-number-5">4.3.5.3.</span> Compute c<sub>vector</sub><sub>full</sub></h5>
<div class="outline-text-5" id="text-4-3-5-3">
<table id="org470ea28" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of atoms</td>
</tr>

<tr>
<td class="org-left"><code>dim_c_vector</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">dimension of cord full table</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">dimension of cord full table</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_vector</code></td>
<td class="org-left"><code>int64_t[nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">dimension of cord full table</td>
</tr>

<tr>
<td class="org-left"><code>c_vector</code></td>
<td class="org-left"><code>double[dim_c_vector][type_nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">dimension of cord full table</td>
</tr>

<tr>
<td class="org-left"><code>c_vector_full</code></td>
<td class="org-left"><code>double[dim_c_vector][nucl_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">Full list of coefficients</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_c_vector_full_doc</span>( <span style="color: #a020f0;">&amp;</span>
     context, nucl_num, dim_c_vector, type_nucl_num,  <span style="color: #a020f0;">&amp;</span>
     type_nucl_vector, c_vector, c_vector_full) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> dim_c_vector</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> type_nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> type_nucl_vector(nucl_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> c_vector(dim_c_vector, type_nucl_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> c_vector_full(nucl_num,dim_c_vector)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">double precision</span>                    ::<span style="color: #a0522d;"> x</span>
  <span style="color: #228b22;">integer</span>*8                           ::<span style="color: #a0522d;"> i, a, k, l, nw</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) info = QMCKL_INVALID_CONTEXT
  <span style="color: #a020f0;">if</span> (nucl_num &lt;= 0)                 info = QMCKL_INVALID_ARG_2
  <span style="color: #a020f0;">if</span> (dim_c_vector &lt; 0)              info = QMCKL_INVALID_ARG_3
  <span style="color: #a020f0;">if</span> (type_nucl_num &lt;= 0)            info = QMCKL_INVALID_ARG_4
  <span style="color: #a020f0;">if</span> (info /= QMCKL_SUCCESS)         <span style="color: #a020f0;">return</span>

  <span style="color: #a020f0;">do</span> a = 1, nucl_num
    c_vector_full(a,1:dim_c_vector) = c_vector(1:dim_c_vector, type_nucl_vector(a)+1)
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_c_vector_full_doc</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_c_vector_full_hpc</span> (
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nucl_num</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">dim_c_vector</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">type_nucl_num</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span>* <span style="color: #a0522d;">type_nucl_vector</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">c_vector</span>,
          <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">c_vector_full</span> ) {

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">return</span> QMCKL_INVALID_CONTEXT;
  <span style="color: #a020f0;">if</span> (nucl_num &lt;= 0)                 <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_2;
  <span style="color: #a020f0;">if</span> (dim_c_vector &lt; 0)              <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_3;
  <span style="color: #a020f0;">if</span> (type_nucl_num &lt;= 0)            <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_4;
  <span style="color: #a020f0;">if</span> (type_nucl_vector == <span style="color: #008b8b;">NULL</span>)      <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_5;
  <span style="color: #a020f0;">if</span> (c_vector == <span style="color: #008b8b;">NULL</span>)              <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_6;
  <span style="color: #a020f0;">if</span> (c_vector_full == <span style="color: #008b8b;">NULL</span>)         <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_7;

  <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">i</span>=0; i &lt; dim_c_vector; ++i) {
    <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">a</span>=0; a &lt; nucl_num; ++a){
      c_vector_full[a + i*nucl_num] = c_vector[i + type_nucl_vector[a]*dim_c_vector];
    }
  }

  <span style="color: #a020f0;">return</span> QMCKL_SUCCESS;
}
</pre>
</div>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_c_vector_full_doc</span> (
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nucl_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">dim_c_vector</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">type_nucl_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span>* <span style="color: #a0522d;">type_nucl_vector</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">c_vector</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">c_vector_full</span> );
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_c_vector_full_hpc</span> (
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nucl_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">dim_c_vector</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">type_nucl_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span>* <span style="color: #a0522d;">type_nucl_vector</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">c_vector</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">c_vector_full</span> );
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_c_vector_full</span> (
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nucl_num</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">dim_c_vector</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">type_nucl_num</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span>* <span style="color: #a0522d;">type_nucl_vector</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">c_vector</span>,
          <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">c_vector_full</span> ) {

<span style="color: #483d8b;">#ifdef</span> HAVE_HPC
      <span style="color: #a020f0;">return</span> qmckl_compute_c_vector_full_hpc
<span style="color: #483d8b;">#else</span>
      <span style="color: #a020f0;">return</span> qmckl_compute_c_vector_full_doc
<span style="color: #483d8b;">#endif</span>
(context, nucl_num, dim_c_vector, type_nucl_num, type_nucl_vector, c_vector, c_vector_full);
    }
</pre>
</div>
</div>
</div>

<div id="outline-container-orgbf551b6" class="outline-5">
<h5 id="orgbf551b6"><span class="section-number-5">4.3.5.4.</span> Compute lkpm<sub>combined</sub><sub>index</sub></h5>
<div class="outline-text-5" id="text-4-3-5-4">
<table id="org298ee27" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>cord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Order of polynomials</td>
</tr>

<tr>
<td class="org-left"><code>dim_c_vector</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">dimension of cord full table</td>
</tr>

<tr>
<td class="org-left"><code>lkpm_combined_index</code></td>
<td class="org-left"><code>int64_t[4][dim_c_vector]</code></td>
<td class="org-left">out</td>
<td class="org-left">Full list of combined indices</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_lkpm_combined_index_doc</span>( <span style="color: #a020f0;">&amp;</span>
     context, cord_num, dim_c_vector,  lkpm_combined_index) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> cord_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> dim_c_vector</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> lkpm_combined_index(dim_c_vector,4)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">double precision</span>                    ::<span style="color: #a0522d;"> x</span>
  <span style="color: #228b22;">integer</span>*8                           ::<span style="color: #a0522d;"> i, a, k, l, kk, p, lmax, m</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) info = QMCKL_INVALID_CONTEXT
  <span style="color: #a020f0;">if</span> (cord_num &lt; 0)                  info = QMCKL_INVALID_ARG_2
  <span style="color: #a020f0;">if</span> (dim_c_vector &lt; 0)              info = QMCKL_INVALID_ARG_3
  <span style="color: #a020f0;">if</span> (info /= QMCKL_SUCCESS)         <span style="color: #a020f0;">return</span>

  kk = 0
  <span style="color: #a020f0;">do</span> p = 2, cord_num
    <span style="color: #a020f0;">do</span> k = p - 1, 0, -1
      <span style="color: #a020f0;">if</span> (k /= 0) <span style="color: #a020f0;">then</span>
        lmax = p - k
      <span style="color: #a020f0;">else</span>
        lmax = p - k - 2
      <span style="color: #a020f0;">end if</span>
      <span style="color: #a020f0;">do</span> l = lmax, 0, -1
        <span style="color: #a020f0;">if</span> (<span style="color: #a020f0;">iand</span>(p - k - l, 1_8) <span style="color: #a020f0;">.eq.</span> 1_8) <span style="color: #a020f0;">cycle</span>
        m = (p - k - l)/2
        kk = kk + 1
        lkpm_combined_index(kk, 1) = l
        lkpm_combined_index(kk, 2) = k
        lkpm_combined_index(kk, 3) = p
        lkpm_combined_index(kk, 4) = m
      <span style="color: #a020f0;">end do</span>
    <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_lkpm_combined_index_doc</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_lkpm_combined_index_hpc</span> (
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">dim_c_vector</span>,
      <span style="color: #228b22;">int64_t</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">lkpm_combined_index</span> ) {

  <span style="color: #228b22;">int</span> <span style="color: #a0522d;">kk</span>, <span style="color: #a0522d;">lmax</span>, <span style="color: #a0522d;">m</span>;

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">return</span> QMCKL_INVALID_CONTEXT;
  <span style="color: #a020f0;">if</span> (cord_num &lt; 0) <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_2;
  <span style="color: #a020f0;">if</span> (dim_c_vector &lt; 0) <span style="color: #a020f0;">return</span> QMCKL_INVALID_ARG_3;

  kk = 0;
  <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">p</span> = 2; p &lt;= cord_num; ++p) {
    <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">k</span>=(p-1); k &gt;= 0; --k) {
      <span style="color: #a020f0;">if</span> (k != 0) {
        lmax = p - k;
      } <span style="color: #a020f0;">else</span> {
        lmax = p - k - 2;
      }
      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">l</span>=lmax; l &gt;= 0; --l) {
        <span style="color: #a020f0;">if</span> (((p - k - l) &amp; 1) == 1) <span style="color: #a020f0;">continue</span>;
        m = (p - k - l)/2;
        lkpm_combined_index[kk                 ] = l;
        lkpm_combined_index[kk +   dim_c_vector] = k;
        lkpm_combined_index[kk + 2*dim_c_vector] = p;
        lkpm_combined_index[kk + 3*dim_c_vector] = m;
        kk = kk + 1;
      }
    }
  }

  <span style="color: #a020f0;">return</span> QMCKL_SUCCESS;
}
</pre>
</div>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_lkpm_combined_index</span> (
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">dim_c_vector</span>,
      <span style="color: #228b22;">int64_t</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">lkpm_combined_index</span> ) {

<span style="color: #483d8b;">    #ifdef</span> HAVE_HPC
      <span style="color: #a020f0;">return</span> qmckl_compute_lkpm_combined_index_hpc
<span style="color: #483d8b;">    #else</span>
      <span style="color: #a020f0;">return</span> qmckl_compute_lkpm_combined_index_doc
<span style="color: #483d8b;">    #endif</span>
        (context, cord_num, dim_c_vector, lkpm_combined_index);
}
</pre>
</div>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_lkpm_combined_index</span> (
      <span style="color: #228b22;">Type</span> <span style="color: #a0522d;">Variable</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">dim_c_vector</span>,
      <span style="color: #228b22;">int64_t</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">lkpm_combined_index</span> ); 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_lkpm_combined_index_doc</span> (
      <span style="color: #228b22;">Type</span> <span style="color: #a0522d;">Variable</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">dim_c_vector</span>,
      <span style="color: #228b22;">int64_t</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">lkpm_combined_index</span> ); 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_lkpm_combined_index_hpc</span> (
      <span style="color: #228b22;">Type</span> <span style="color: #a0522d;">Variable</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">dim_c_vector</span>,
      <span style="color: #228b22;">int64_t</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">lkpm_combined_index</span> ); 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_lkpm_combined_index</span> (
      <span style="color: #228b22;">Type</span> <span style="color: #a0522d;">Variable</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">dim_c_vector</span>,
      <span style="color: #228b22;">int64_t</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">lkpm_combined_index</span> ); 
</pre>
</div>
</div>
</div>

<div id="outline-container-org2fddc6e" class="outline-5">
<h5 id="org2fddc6e"><span class="section-number-5">4.3.5.5.</span> Compute tmp<sub>c</sub></h5>
<div class="outline-text-5" id="text-4-3-5-5">
<table id="org003d8b8" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>cord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Order of polynomials</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_e</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][elec_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-electron rescaled factor</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][nucl_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus rescaled factor</td>
</tr>

<tr>
<td class="org-left"><code>tmp_c</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num-1][0:cord_num][nucl_num][elec_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">vector of non-zero coefficients</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_tmp_c</span> (<span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                     <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
                                     <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
                                     <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nucl_num</span>,
                                     <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
                                     <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">een_rescaled_e</span>,
                                     <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">een_rescaled_n</span>,
                                     <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">tmp_c</span> )
{
<span style="color: #483d8b;">#ifdef</span> HAVE_HPC
  <span style="color: #a020f0;">return</span> qmckl_compute_tmp_c_hpc
<span style="color: #483d8b;">#else</span>
  <span style="color: #a020f0;">return</span> qmckl_compute_tmp_c_doc
<span style="color: #483d8b;">#endif</span>
    (context, cord_num, elec_num, nucl_num, walk_num,
     een_rescaled_e, een_rescaled_n, tmp_c);
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_tmp_c_doc</span>( <span style="color: #a020f0;">&amp;</span>
     context, cord_num, elec_num, nucl_num, <span style="color: #a020f0;">&amp;</span>
     walk_num, een_rescaled_e, een_rescaled_n, tmp_c) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>  ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> cord_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> een_rescaled_e(elec_num,elec_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> een_rescaled_n(elec_num,nucl_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> tmp_c(elec_num,nucl_num,0:cord_num,0:cord_num-1,walk_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">double precision</span>                    ::<span style="color: #a0522d;"> x</span>
  <span style="color: #228b22;">integer</span>*8                           ::<span style="color: #a0522d;"> i, j, a, l, kk, p, lmax, nw</span>
  <span style="color: #228b22;">character</span>                           ::<span style="color: #a0522d;"> TransA, TransB</span>
  <span style="color: #228b22;">double precision</span>                    ::<span style="color: #a0522d;"> alpha, beta</span>
  <span style="color: #228b22;">integer</span>*8                           ::<span style="color: #a0522d;"> M, N, K, LDA, LDB, LDC</span>

  TransA = <span style="color: #8b2252;">'N'</span>
  TransB = <span style="color: #8b2252;">'N'</span>
  alpha = 1.0d0
  beta  = 0.0d0

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) info = QMCKL_INVALID_CONTEXT
  <span style="color: #a020f0;">if</span> (cord_num &lt;  0)                 info = QMCKL_INVALID_ARG_2
  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0)                 info = QMCKL_INVALID_ARG_3
  <span style="color: #a020f0;">if</span> (nucl_num &lt;= 0)                 info = QMCKL_INVALID_ARG_4
  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0)                 info = QMCKL_INVALID_ARG_5
  <span style="color: #a020f0;">if</span> (info /= QMCKL_SUCCESS)         <span style="color: #a020f0;">return</span>


  M = elec_num
  K = elec_num
  N = nucl_num
  LDA = <span style="color: #a020f0;">size</span>(een_rescaled_e,1)
  LDB = <span style="color: #a020f0;">size</span>(een_rescaled_n,1)
  LDC = <span style="color: #a020f0;">size</span>(tmp_c,1)

  <span style="color: #a020f0;">do</span> nw=1, walk_num
     <span style="color: #a020f0;">do</span> i=0, cord_num-1
        <span style="color: #a020f0;">do</span> j=0, cord_num-i
           info = qmckl_dgemm(context, TransA, TransB, M, N, K, alpha, <span style="color: #a020f0;">&amp;</span>
                een_rescaled_e(1,1,i,nw),LDA*1_8,        <span style="color: #a020f0;">&amp;</span>
                een_rescaled_n(1,1,j,nw),LDB*1_8,        <span style="color: #a020f0;">&amp;</span>
                beta,                                    <span style="color: #a020f0;">&amp;</span>
                tmp_c(1,1,j,i,nw),LDC)
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_tmp_c_doc</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_tmp_c_doc</span> (
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nucl_num</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">een_rescaled_e</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">een_rescaled_n</span>,
          <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">tmp_c</span> );
</pre>
</div>
</div>
</div>

<div id="outline-container-org14a39c1" class="outline-5">
<h5 id="org14a39c1"><span class="section-number-5">4.3.5.6.</span> Compute dtmp<sub>c</sub></h5>
<div class="outline-text-5" id="text-4-3-5-6">
<table id="org31d01b4" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>cord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Order of polynomials</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_e_gl</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][elec_num][4][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-electron rescaled factor derivatives</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][nucl_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus rescaled factor</td>
</tr>

<tr>
<td class="org-left"><code>dtmp_c</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num-1][0:cord_num][nucl_num][4][elec_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">vector of non-zero coefficients</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_compute_dtmp_c</span> (<span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
                      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
                      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nucl_num</span>,
                      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
                      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">een_rescaled_e_gl</span>,
                      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">een_rescaled_n</span>,
                      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">dtmp_c</span> )
{
<span style="color: #483d8b;">#ifdef</span> HAVE_HPC
  <span style="color: #a020f0;">return</span> qmckl_compute_dtmp_c_hpc
<span style="color: #483d8b;">#else</span>
  <span style="color: #a020f0;">return</span> qmckl_compute_dtmp_c_doc
<span style="color: #483d8b;">#endif</span>
    (context, cord_num, elec_num, nucl_num, walk_num, een_rescaled_e_gl,
     een_rescaled_n, dtmp_c );
}
</pre>
</div>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_dtmp_c_doc</span>( <span style="color: #a020f0;">&amp;</span>
     context, cord_num, elec_num, nucl_num, <span style="color: #a020f0;">&amp;</span>
     walk_num, een_rescaled_e_gl, een_rescaled_n, dtmp_c) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> cord_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> een_rescaled_e_gl(elec_num,4,elec_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> een_rescaled_n(elec_num,nucl_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> dtmp_c(elec_num,4,nucl_num,0:cord_num,0:cord_num-1,walk_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">double precision</span>                    ::<span style="color: #a0522d;"> x</span>
  <span style="color: #228b22;">integer</span>*8                           ::<span style="color: #a0522d;"> i, j, a, l, kk, p, lmax, nw, ii</span>
  <span style="color: #228b22;">character</span>                           ::<span style="color: #a0522d;"> TransA, TransB</span>
  <span style="color: #228b22;">double precision</span>                    ::<span style="color: #a0522d;"> alpha, beta</span>
  <span style="color: #228b22;">integer</span>*8                           ::<span style="color: #a0522d;"> M, N, K, LDA, LDB, LDC</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) info = QMCKL_INVALID_CONTEXT
  <span style="color: #a020f0;">if</span> (cord_num &lt;  0)                 info = QMCKL_INVALID_ARG_2
  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0)                 info = QMCKL_INVALID_ARG_3
  <span style="color: #a020f0;">if</span> (nucl_num &lt;= 0)                 info = QMCKL_INVALID_ARG_4
  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0)                 info = QMCKL_INVALID_ARG_5
  <span style="color: #a020f0;">if</span> (info /= QMCKL_SUCCESS)         <span style="color: #a020f0;">return</span>

  TransA = <span style="color: #8b2252;">'N'</span>
  TransB = <span style="color: #8b2252;">'N'</span>
  alpha = 1.0d0
  beta  = 0.0d0

  M = 4*elec_num
  N = nucl_num
  K = elec_num
  LDA = 4*<span style="color: #a020f0;">size</span>(een_rescaled_e_gl,1)
  LDB = <span style="color: #a020f0;">size</span>(een_rescaled_n,1)
  LDC = 4*<span style="color: #a020f0;">size</span>(dtmp_c,1)

  <span style="color: #a020f0;">do</span> nw=1, walk_num
     <span style="color: #a020f0;">do</span> i=0, cord_num-1
        <span style="color: #a020f0;">do</span> j=0, cord_num-i
              info = qmckl_dgemm(context,TransA, TransB, M, N, K, alpha,  <span style="color: #a020f0;">&amp;</span>
                   een_rescaled_e_gl(1,1,1,i,nw),LDA*1_8,            <span style="color: #a020f0;">&amp;</span>
                   een_rescaled_n(1,1,j,nw),LDB*1_8,                      <span style="color: #a020f0;">&amp;</span>
                   beta,                                                  <span style="color: #a020f0;">&amp;</span>
                   dtmp_c(1,1,1,j,i,nw),LDC)
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_dtmp_c_doc</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orge68c493" class="outline-4">
<h4 id="orge68c493"><span class="section-number-4">4.3.6.</span> Electron-electron-nucleus Jastrow \(f_{een}\)</h4>
<div class="outline-text-4" id="text-4-3-6">
<p>
Calculate the electron-electron-nuclear three-body jastrow component <code>factor_een</code>
using the above prepared tables.
</p>

<p>
TODO: write equations.
</p>
</div>

<div id="outline-container-orged18fd9" class="outline-5">
<h5 id="orged18fd9"><span class="section-number-5">4.3.6.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-3-6-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_een</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                             <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_een</span>,
                             <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org4b146e8"></a>Fortran interface<br />
<div class="outline-text-6" id="text-4-3-6-1-1">
<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_een</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        factor_een, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> factor_een(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_een</span>
<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org8f92e0e" class="outline-5">
<h5 id="org8f92e0e"><span class="section-number-5">4.3.6.2.</span> Compute naive</h5>
<div class="outline-text-5" id="text-4-3-6-2">
<table id="orgf585d5a" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>cord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">order of polynomials</td>
</tr>

<tr>
<td class="org-left"><code>dim_c_vector</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">dimension of full coefficient vector</td>
</tr>

<tr>
<td class="org-left"><code>c_vector_full</code></td>
<td class="org-left"><code>double[dim_c_vector][nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">full coefficient vector</td>
</tr>

<tr>
<td class="org-left"><code>lkpm_combined_index</code></td>
<td class="org-left"><code>int64_t[4][dim_c_vector]</code></td>
<td class="org-left">in</td>
<td class="org-left">combined indices</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_e</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][elec_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus rescaled</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][nucl_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus rescaled factor</td>
</tr>

<tr>
<td class="org-left"><code>factor_een</code></td>
<td class="org-left"><code>double[walk_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">Electron-nucleus jastrow</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_naive</span>( <span style="color: #a020f0;">&amp;</span>
     context, walk_num, elec_num, nucl_num, cord_num,<span style="color: #a020f0;">&amp;</span>
     dim_c_vector, c_vector_full, lkpm_combined_index, <span style="color: #a020f0;">&amp;</span>
     een_rescaled_e, een_rescaled_n, factor_een) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> cord_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> dim_c_vector</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> c_vector_full(nucl_num,dim_c_vector)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> lkpm_combined_index(dim_c_vector,4)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> een_rescaled_e(elec_num,elec_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> een_rescaled_n(elec_num,nucl_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> factor_een(walk_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, a, j, l, k, m, n, p, nw</span>
  <span style="color: #228b22;">double precision</span> ::<span style="color: #a0522d;"> cn</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) info = QMCKL_INVALID_CONTEXT
  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0)                 info = QMCKL_INVALID_ARG_2
  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0)                 info = QMCKL_INVALID_ARG_3
  <span style="color: #a020f0;">if</span> (nucl_num &lt;= 0)                 info = QMCKL_INVALID_ARG_4
  <span style="color: #a020f0;">if</span> (cord_num &lt;  0)                 info = QMCKL_INVALID_ARG_5
  <span style="color: #a020f0;">if</span> (info /= QMCKL_SUCCESS)         <span style="color: #a020f0;">return</span>

  <span style="color: #a020f0;">do</span> nw =1, walk_num
     factor_een(nw) = 0.d0
     <span style="color: #a020f0;">do</span> n = 1, dim_c_vector
        l = lkpm_combined_index(n, 1)
        k = lkpm_combined_index(n, 2)
        p = lkpm_combined_index(n, 3)
        m = lkpm_combined_index(n, 4)

        <span style="color: #a020f0;">do</span> a = 1, nucl_num
           cn = c_vector_full(a, n)
           <span style="color: #a020f0;">if</span> (cn == 0.d0) <span style="color: #a020f0;">cycle</span>
           <span style="color: #a020f0;">do</span> j = 1, elec_num
              <span style="color: #a020f0;">do</span> i = 1, j-1
                 factor_een(nw) = factor_een(nw) + cn*( <span style="color: #a020f0;">&amp;</span>
                      een_rescaled_e(i,j,k,nw) *       <span style="color: #a020f0;">&amp;</span>
                      (een_rescaled_n(i,a,l,nw) + een_rescaled_n(j,a,l,nw)) * <span style="color: #a020f0;">&amp;</span>
                      (een_rescaled_n(i,a,m,nw) * een_rescaled_n(j,a,m,nw)) )
              <span style="color: #a020f0;">end do</span>
           <span style="color: #a020f0;">end do</span>
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_naive</span>

</pre>
</div>
</div>
</div>

<div id="outline-container-orga2aa6cb" class="outline-5">
<h5 id="orga2aa6cb"><span class="section-number-5">4.3.6.3.</span> Compute</h5>
<div class="outline-text-5" id="text-4-3-6-3">
<table id="org3db6091" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>cord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">order of polynomials</td>
</tr>

<tr>
<td class="org-left"><code>dim_c_vector</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">dimension of full coefficient vector</td>
</tr>

<tr>
<td class="org-left"><code>c_vector_full</code></td>
<td class="org-left"><code>double[dim_c_vector][nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">full coefficient vector</td>
</tr>

<tr>
<td class="org-left"><code>lkpm_combined_index</code></td>
<td class="org-left"><code>int64_t[4][dim_c_vector]</code></td>
<td class="org-left">in</td>
<td class="org-left">combined indices</td>
</tr>

<tr>
<td class="org-left"><code>tmp_c</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num-1][0:cord_num][nucl_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">vector of non-zero coefficients</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][nucl_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus rescaled distances</td>
</tr>

<tr>
<td class="org-left"><code>factor_een</code></td>
<td class="org-left"><code>double[walk_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">Electron-nucleus jastrow</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_doc</span>( <span style="color: #a020f0;">&amp;</span>
     context, walk_num, elec_num, nucl_num, cord_num,   <span style="color: #a020f0;">&amp;</span>
     dim_c_vector, c_vector_full, lkpm_combined_index, <span style="color: #a020f0;">&amp;</span>
     tmp_c, een_rescaled_n, factor_een) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> cord_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> dim_c_vector</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> c_vector_full(nucl_num,dim_c_vector)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> lkpm_combined_index(dim_c_vector,4)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> tmp_c(elec_num,nucl_num,0:cord_num,0:cord_num-1,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> een_rescaled_n(elec_num,nucl_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> factor_een(walk_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, a, j, l, k, p, m, n, nw</span>
  <span style="color: #228b22;">double precision</span> ::<span style="color: #a0522d;"> accu, accu2, cn</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) info = QMCKL_INVALID_CONTEXT
  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0)                 info = QMCKL_INVALID_ARG_2
  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0)                 info = QMCKL_INVALID_ARG_3
  <span style="color: #a020f0;">if</span> (nucl_num &lt;= 0)                 info = QMCKL_INVALID_ARG_4
  <span style="color: #a020f0;">if</span> (cord_num &lt;  0)                 info = QMCKL_INVALID_ARG_5
  <span style="color: #a020f0;">if</span> (info /= QMCKL_SUCCESS)         <span style="color: #a020f0;">return</span>

  factor_een = 0.0d0

  <span style="color: #a020f0;">if</span> (cord_num == 0) <span style="color: #a020f0;">return</span>

  <span style="color: #a020f0;">do</span> nw =1, walk_num
     <span style="color: #a020f0;">do</span> n = 1, dim_c_vector
        l = lkpm_combined_index(n, 1)
        k = lkpm_combined_index(n, 2)
        m = lkpm_combined_index(n, 4)

        <span style="color: #a020f0;">do</span> a = 1, nucl_num
           cn = c_vector_full(a, n)
           <span style="color: #a020f0;">if</span>(cn == 0.d0) <span style="color: #a020f0;">cycle</span>

           accu = 0.0d0
           <span style="color: #a020f0;">do</span> j = 1, elec_num
              accu = accu + een_rescaled_n(j,a,m,nw) * tmp_c(j,a,m+l,k,nw)
           <span style="color: #a020f0;">end do</span>
           factor_een(nw) = factor_een(nw) + accu * cn
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_doc</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org8e6cb61" class="outline-4">
<h4 id="org8e6cb61"><span class="section-number-4">4.3.7.</span> Electron-electron-nucleus Jastrow \(f_{een}\) derivative</h4>
<div class="outline-text-4" id="text-4-3-7">
<p>
Calculate the electron-electron-nuclear three-body jastrow component <code>factor_een_gl</code>
using the above prepared tables.
</p>

<p>
TODO: write equations.
</p>
</div>

<div id="outline-container-org52fc4bb" class="outline-5">
<h5 id="org52fc4bb"><span class="section-number-5">4.3.7.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-3-7-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_een_gl</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                     <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_een_gl</span>,
                                     <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_een_grad</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                        <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_een_grad</span>,
                                        <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org95ff9c1"></a>Fortran interface<br />
<div class="outline-text-6" id="text-4-3-7-1-1">
<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_een_gl</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        factor_een_gl, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> factor_een_gl(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_een_gl</span>
<span style="color: #a020f0;">end interface</span>

<span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_een_grad</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        factor_een_grad, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> factor_een_grad(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_een_grad</span>
<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgaf36a02" class="outline-5">
<h5 id="orgaf36a02"><span class="section-number-5">4.3.7.2.</span> Compute Naive</h5>
<div class="outline-text-5" id="text-4-3-7-2">
<table id="orgef7c201" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>cord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">order of polynomials</td>
</tr>

<tr>
<td class="org-left"><code>dim_c_vector</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">dimension of full coefficient vector</td>
</tr>

<tr>
<td class="org-left"><code>c_vector_full</code></td>
<td class="org-left"><code>double[dim_c_vector][nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">full coefficient vector</td>
</tr>

<tr>
<td class="org-left"><code>lkpm_combined_index</code></td>
<td class="org-left"><code>int64_t[4][dim_c_vector]</code></td>
<td class="org-left">in</td>
<td class="org-left">combined indices</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_e</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][elec_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus rescaled</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][nucl_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus rescaled factor</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_e_gl</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][elec_num][4][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus rescaled</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n_gl</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][nucl_num][4][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus rescaled factor</td>
</tr>

<tr>
<td class="org-left"><code>factor_een_gl</code></td>
<td class="org-left"><code>double[walk_num][4][elec_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">Electron-nucleus jastrow</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_gl_naive</span>( <span style="color: #a020f0;">&amp;</span>
     context, walk_num, elec_num, nucl_num, cord_num, dim_c_vector, <span style="color: #a020f0;">&amp;</span>
     c_vector_full, lkpm_combined_index, een_rescaled_e, een_rescaled_n, <span style="color: #a020f0;">&amp;</span>
     een_rescaled_e_gl, een_rescaled_n_gl, factor_een_gl)<span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> cord_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> dim_c_vector</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> c_vector_full(nucl_num,dim_c_vector)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> lkpm_combined_index(dim_c_vector,4)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> een_rescaled_e(elec_num,elec_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> een_rescaled_n(elec_num,nucl_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> een_rescaled_e_gl(elec_num,4,elec_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> een_rescaled_n_gl(elec_num,4,nucl_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> factor_een_gl(elec_num,4,walk_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, a, j, l, k, m, n, nw</span>
  <span style="color: #228b22;">double precision</span> ::<span style="color: #a0522d;"> accu, accu2, cn</span>
  <span style="color: #228b22;">double precision</span> ::<span style="color: #a0522d;"> daccu(1:4), daccu2(1:4)</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) info = QMCKL_INVALID_CONTEXT
  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0)                 info = QMCKL_INVALID_ARG_2
  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0)                 info = QMCKL_INVALID_ARG_3
  <span style="color: #a020f0;">if</span> (nucl_num &lt;= 0)                 info = QMCKL_INVALID_ARG_4
  <span style="color: #a020f0;">if</span> (cord_num &lt;  0)                 info = QMCKL_INVALID_ARG_5
  <span style="color: #a020f0;">if</span> (info /= QMCKL_SUCCESS)         <span style="color: #a020f0;">return</span>

  factor_een_gl = 0.0d0

  <span style="color: #a020f0;">do</span> nw =1, walk_num
     <span style="color: #a020f0;">do</span> n = 1, dim_c_vector
        l = lkpm_combined_index(n, 1)
        k = lkpm_combined_index(n, 2)
        m = lkpm_combined_index(n, 4)

        <span style="color: #a020f0;">do</span> a = 1, nucl_num
           cn = c_vector_full(a, n)
           <span style="color: #a020f0;">do</span> j = 1, elec_num
              accu = 0.0d0
              accu2 = 0.0d0
              daccu = 0.0d0
              daccu2 = 0.0d0
              <span style="color: #a020f0;">do</span> i = 1, elec_num
                 accu = accu + een_rescaled_e(i, j, k, nw) * een_rescaled_n(i, a, m, nw)
                 accu2 = accu2 + een_rescaled_e(i, j, k, nw) * een_rescaled_n(i, a, m + l, nw)
                 daccu(1:4) = daccu(1:4) + een_rescaled_e_gl(j, 1:4, i, k, nw) *   <span style="color: #a020f0;">&amp;</span>
                      een_rescaled_n(i, a, m, nw)
                 daccu2(1:4) = daccu2(1:4) + een_rescaled_e_gl(j, 1:4, i, k, nw) * <span style="color: #a020f0;">&amp;</span>
                      een_rescaled_n(i, a, m + l, nw)
              <span style="color: #a020f0;">end do</span>
              factor_een_gl(j, 1:4, nw) = factor_een_gl(j, 1:4, nw) +   <span style="color: #a020f0;">&amp;</span>
                   (accu * een_rescaled_n_gl(j, 1:4, a, m + l, nw)      <span style="color: #a020f0;">&amp;</span>
                   + daccu(1:4) * een_rescaled_n(j, a, m + l, nw)       <span style="color: #a020f0;">&amp;</span>
                   + daccu2(1:4) * een_rescaled_n(j, a, m, nw)          <span style="color: #a020f0;">&amp;</span>
                   + accu2 * een_rescaled_n_gl(j, 1:4, a, m, nw)) * cn

              factor_een_gl(j, 4, nw) = factor_een_gl(j, 4, nw) + 2.0d0 * ( <span style="color: #a020f0;">&amp;</span>
                   daccu (1) * een_rescaled_n_gl(j, 1, a, m + l, nw) +      <span style="color: #a020f0;">&amp;</span>
                   daccu (2) * een_rescaled_n_gl(j, 2, a, m + l, nw) +      <span style="color: #a020f0;">&amp;</span>
                   daccu (3) * een_rescaled_n_gl(j, 3, a, m + l, nw) +      <span style="color: #a020f0;">&amp;</span>
                   daccu2(1) * een_rescaled_n_gl(j, 1, a, m, nw    ) +      <span style="color: #a020f0;">&amp;</span>
                   daccu2(2) * een_rescaled_n_gl(j, 2, a, m, nw    ) +      <span style="color: #a020f0;">&amp;</span>
                   daccu2(3) * een_rescaled_n_gl(j, 3, a, m, nw    ) ) * cn

           <span style="color: #a020f0;">end do</span>
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_gl_naive</span>
</pre>
</div>
</div>
</div>

<div id="outline-container-orge9c1060" class="outline-5">
<h5 id="orge9c1060"><span class="section-number-5">4.3.7.3.</span> Compute GL</h5>
<div class="outline-text-5" id="text-4-3-7-3">
<table id="org0fcc6d7" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>cord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">order of polynomials</td>
</tr>

<tr>
<td class="org-left"><code>dim_c_vector</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">dimension of full coefficient vector</td>
</tr>

<tr>
<td class="org-left"><code>c_vector_full</code></td>
<td class="org-left"><code>double[dim_c_vector][nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">full coefficient vector</td>
</tr>

<tr>
<td class="org-left"><code>lkpm_combined_index</code></td>
<td class="org-left"><code>int64_t[4][dim_c_vector]</code></td>
<td class="org-left">in</td>
<td class="org-left">combined indices</td>
</tr>

<tr>
<td class="org-left"><code>tmp_c</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num-1][0:cord_num][nucl_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Temporary intermediate tensor</td>
</tr>

<tr>
<td class="org-left"><code>dtmp_c</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num-1][0:cord_num][nucl_num][4][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">vector of non-zero coefficients</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][nucl_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus rescaled factor</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n_gl</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][nucl_num][4][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Derivative of Electron-nucleus rescaled factor</td>
</tr>

<tr>
<td class="org-left"><code>factor_een_gl</code></td>
<td class="org-left"><code>double[walk_num][4][elec_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">Derivative of Electron-nucleus jastrow</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_gl_doc</span>( <span style="color: #a020f0;">&amp;</span>
     context, walk_num, elec_num, nucl_num, <span style="color: #a020f0;">&amp;</span>
     cord_num, dim_c_vector, c_vector_full, lkpm_combined_index, <span style="color: #a020f0;">&amp;</span>
     tmp_c, dtmp_c, een_rescaled_n, een_rescaled_n_gl, factor_een_gl)<span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> cord_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> dim_c_vector</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> c_vector_full(nucl_num,dim_c_vector)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> lkpm_combined_index(dim_c_vector,4)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> tmp_c(elec_num,nucl_num,0:cord_num,0:cord_num-1,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> dtmp_c(elec_num,4,nucl_num,0:cord_num,0:cord_num-1,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> een_rescaled_n(elec_num,nucl_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> een_rescaled_n_gl(elec_num,4,nucl_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> factor_een_gl(elec_num,4,walk_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, a, j, l, k, m, n, nw, ii</span>
  <span style="color: #228b22;">double precision</span> ::<span style="color: #a0522d;"> accu, accu2, cn</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) info = QMCKL_INVALID_CONTEXT
  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0)                 info = QMCKL_INVALID_ARG_2
  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0)                 info = QMCKL_INVALID_ARG_3
  <span style="color: #a020f0;">if</span> (nucl_num &lt;= 0)                 info = QMCKL_INVALID_ARG_4
  <span style="color: #a020f0;">if</span> (cord_num &lt;  0)                 info = QMCKL_INVALID_ARG_5
  <span style="color: #a020f0;">if</span> (info /= QMCKL_SUCCESS)         <span style="color: #a020f0;">return</span>

  <span style="color: #a020f0;">if</span> (cord_num == 0) <span style="color: #a020f0;">then</span>
     factor_een_gl = 0.0d0
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">end if</span>

  <span style="color: #a020f0;">do</span> nw =1, walk_num
     factor_een_gl(:,:,nw) = 0.0d0
     <span style="color: #a020f0;">do</span> n = 1, dim_c_vector
        l = lkpm_combined_index(n, 1)
        k = lkpm_combined_index(n, 2)
        m = lkpm_combined_index(n, 4)

        <span style="color: #a020f0;">do</span> a = 1, nucl_num
           cn = c_vector_full(a, n)
           <span style="color: #a020f0;">if</span>(cn == 0.d0) <span style="color: #a020f0;">cycle</span>

           <span style="color: #a020f0;">do</span> ii = 1, 4
              <span style="color: #a020f0;">do</span> j = 1, elec_num
                 factor_een_gl(j,ii,nw) = factor_een_gl(j,ii,nw) + ( <span style="color: #a020f0;">&amp;</span>
                      tmp_c (j,   a,m  ,k,nw) * een_rescaled_n_gl(j,ii,a,m+l,nw) + <span style="color: #a020f0;">&amp;</span>
                      tmp_c (j,   a,m+l,k,nw) * een_rescaled_n_gl(j,ii,a,m  ,nw) + <span style="color: #a020f0;">&amp;</span>
                      dtmp_c(j,ii,a,m  ,k,nw) * een_rescaled_n   (j,   a,m+l,nw) + <span style="color: #a020f0;">&amp;</span>
                      dtmp_c(j,ii,a,m+l,k,nw) * een_rescaled_n   (j,   a,m  ,nw)   <span style="color: #a020f0;">&amp;</span>
                      ) * cn
              <span style="color: #a020f0;">end do</span>
           <span style="color: #a020f0;">end do</span>

           cn = cn + cn
           <span style="color: #a020f0;">do</span> j = 1, elec_num
              factor_een_gl(j,4,nw) = factor_een_gl(j,4,nw) +  ( <span style="color: #a020f0;">&amp;</span>
                   dtmp_c(j,1,a,m  ,k,nw) * een_rescaled_n_gl(j,1,a,m+l,nw)  + <span style="color: #a020f0;">&amp;</span>
                   dtmp_c(j,2,a,m  ,k,nw) * een_rescaled_n_gl(j,2,a,m+l,nw)  + <span style="color: #a020f0;">&amp;</span>
                   dtmp_c(j,3,a,m  ,k,nw) * een_rescaled_n_gl(j,3,a,m+l,nw)  + <span style="color: #a020f0;">&amp;</span>
                   dtmp_c(j,1,a,m+l,k,nw) * een_rescaled_n_gl(j,1,a,m  ,nw)  + <span style="color: #a020f0;">&amp;</span>
                   dtmp_c(j,2,a,m+l,k,nw) * een_rescaled_n_gl(j,2,a,m  ,nw)  + <span style="color: #a020f0;">&amp;</span>
                   dtmp_c(j,3,a,m+l,k,nw) * een_rescaled_n_gl(j,3,a,m  ,nw)    <span style="color: #a020f0;">&amp;</span>
                   ) * cn
           <span style="color: #a020f0;">end do</span>
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_gl_doc</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_gl_doc</span> (
      <span style="color: #228b22;">Type</span> <span style="color: #a0522d;">Variable</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nucl_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">dim_c_vector</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">c_vector_full</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span>* <span style="color: #a0522d;">lkpm_combined_index</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">tmp_c</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">dtmp_c</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">een_rescaled_n</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">een_rescaled_n_gl</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_een_gl</span> ); 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_gl</span> (
      <span style="color: #228b22;">Type</span> <span style="color: #a0522d;">Variable</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nucl_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">dim_c_vector</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">c_vector_full</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span>* <span style="color: #a0522d;">lkpm_combined_index</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">tmp_c</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">dtmp_c</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">een_rescaled_n</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">een_rescaled_n_gl</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_een_gl</span> ); 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_gl</span>(<span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nucl_num</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">dim_c_vector</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> *<span style="color: #a0522d;">c_vector_full</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> *<span style="color: #a0522d;">lkpm_combined_index</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> *<span style="color: #a0522d;">tmp_c</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> *<span style="color: #a0522d;">dtmp_c</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> *<span style="color: #a0522d;">een_rescaled_n</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> *<span style="color: #a0522d;">een_rescaled_n_gl</span>,
                                               <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_een_gl</span>)
{
<span style="color: #483d8b;">#ifdef</span> HAVE_HPC
  <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_factor_een_gl_hpc
<span style="color: #483d8b;">#else</span>
  <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_factor_een_gl_doc
<span style="color: #483d8b;">#endif</span>
    (context, walk_num, elec_num, nucl_num,
     cord_num, dim_c_vector, c_vector_full,
     lkpm_combined_index, tmp_c, dtmp_c,
     een_rescaled_n, een_rescaled_n_gl,
     factor_een_gl);
}
</pre>
</div>
</div>
</div>

<div id="outline-container-org4c4e6e2" class="outline-5">
<h5 id="org4c4e6e2"><span class="section-number-5">4.3.7.4.</span> Compute Gradient only</h5>
<div class="outline-text-5" id="text-4-3-7-4">
<table id="orga0ddc05" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>cord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">order of polynomials</td>
</tr>

<tr>
<td class="org-left"><code>dim_c_vector</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">dimension of full coefficient vector</td>
</tr>

<tr>
<td class="org-left"><code>c_vector_full</code></td>
<td class="org-left"><code>double[dim_c_vector][nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">full coefficient vector</td>
</tr>

<tr>
<td class="org-left"><code>lkpm_combined_index</code></td>
<td class="org-left"><code>int64_t[4][dim_c_vector]</code></td>
<td class="org-left">in</td>
<td class="org-left">combined indices</td>
</tr>

<tr>
<td class="org-left"><code>tmp_c</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num-1][0:cord_num][nucl_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Temporary intermediate tensor</td>
</tr>

<tr>
<td class="org-left"><code>dtmp_c</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num-1][0:cord_num][nucl_num][4][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">vector of non-zero coefficients</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][nucl_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus rescaled factor</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n_gl</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][nucl_num][4][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Derivative of Electron-nucleus rescaled factor</td>
</tr>

<tr>
<td class="org-left"><code>factor_een_grad</code></td>
<td class="org-left"><code>double[walk_num][3][elec_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">Derivative of Electron-nucleus jastrow</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_grad_doc</span>( <span style="color: #a020f0;">&amp;</span>
     context, walk_num, elec_num, nucl_num, <span style="color: #a020f0;">&amp;</span>
     cord_num, dim_c_vector, c_vector_full, lkpm_combined_index, <span style="color: #a020f0;">&amp;</span>
     tmp_c, dtmp_c, een_rescaled_n, een_rescaled_n_gl, factor_een_grad) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">bind</span>(C) <span style="color: #a020f0;">result</span>(info)

  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> cord_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> dim_c_vector</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> c_vector_full(nucl_num,dim_c_vector)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> lkpm_combined_index(dim_c_vector,4)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> tmp_c(elec_num,nucl_num,0:cord_num,0:cord_num-1,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> dtmp_c(elec_num,4,nucl_num,0:cord_num,0:cord_num-1,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> een_rescaled_n(elec_num,nucl_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> een_rescaled_n_gl(elec_num,4,nucl_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> factor_een_grad(elec_num,3,walk_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, a, j, l, k, m, n, nw, ii</span>
  <span style="color: #228b22;">double precision</span> ::<span style="color: #a0522d;"> accu, accu2, cn</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) info = QMCKL_INVALID_CONTEXT
  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0)                 info = QMCKL_INVALID_ARG_2
  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0)                 info = QMCKL_INVALID_ARG_3
  <span style="color: #a020f0;">if</span> (nucl_num &lt;= 0)                 info = QMCKL_INVALID_ARG_4
  <span style="color: #a020f0;">if</span> (cord_num &lt;  0)                 info = QMCKL_INVALID_ARG_5
  <span style="color: #a020f0;">if</span> (info /= QMCKL_SUCCESS)         <span style="color: #a020f0;">return</span>


  <span style="color: #a020f0;">if</span> (cord_num == 0) <span style="color: #a020f0;">then</span>
     factor_een_grad = 0.0d0
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">end if</span>

  <span style="color: #a020f0;">do</span> nw =1, walk_num
     factor_een_grad(:,:,nw) = 0.0d0
     <span style="color: #a020f0;">do</span> n = 1, dim_c_vector
        l = lkpm_combined_index(n, 1)
        k = lkpm_combined_index(n, 2)
        m = lkpm_combined_index(n, 4)

        <span style="color: #a020f0;">do</span> a = 1, nucl_num
           cn = c_vector_full(a, n)
           <span style="color: #a020f0;">if</span>(cn == 0.d0) <span style="color: #a020f0;">cycle</span>

           <span style="color: #a020f0;">do</span> ii = 1, 3
              <span style="color: #a020f0;">do</span> j = 1, elec_num
                 factor_een_grad(j,ii,nw) = factor_een_grad(j,ii,nw) + (           <span style="color: #a020f0;">&amp;</span>
                      dtmp_c(j,ii,a,m  ,k,nw) * een_rescaled_n   (j,   a,m+l,nw) + <span style="color: #a020f0;">&amp;</span>
                      dtmp_c(j,ii,a,m+l,k,nw) * een_rescaled_n   (j,   a,m  ,nw) + <span style="color: #a020f0;">&amp;</span>
                      tmp_c(j,a,m  ,k,nw)     * een_rescaled_n_gl(j,ii,a,m+l,nw) + <span style="color: #a020f0;">&amp;</span>
                      tmp_c(j,a,m+l,k,nw)     * een_rescaled_n_gl(j,ii,a,m  ,nw)   <span style="color: #a020f0;">&amp;</span>
                      ) * cn
              <span style="color: #a020f0;">end do</span>
           <span style="color: #a020f0;">end do</span>

        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_grad_doc</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_grad_doc</span> (
      <span style="color: #228b22;">Type</span> <span style="color: #a0522d;">Variable</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nucl_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">dim_c_vector</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">c_vector_full</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span>* <span style="color: #a0522d;">lkpm_combined_index</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">tmp_c</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">dtmp_c</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">een_rescaled_n</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">een_rescaled_n_gl</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_een_grad</span> ); 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_grad</span> (
      <span style="color: #228b22;">Type</span> <span style="color: #a0522d;">Variable</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nucl_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">dim_c_vector</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">c_vector_full</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span>* <span style="color: #a0522d;">lkpm_combined_index</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">tmp_c</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">dtmp_c</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">een_rescaled_n</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">een_rescaled_n_gl</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_een_grad</span> ); 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_grad</span>(<span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">nucl_num</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">cord_num</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">dim_c_vector</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> *<span style="color: #a0522d;">c_vector_full</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> *<span style="color: #a0522d;">lkpm_combined_index</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> *<span style="color: #a0522d;">tmp_c</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> *<span style="color: #a0522d;">dtmp_c</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> *<span style="color: #a0522d;">een_rescaled_n</span>,
                                               <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span> *<span style="color: #a0522d;">een_rescaled_n_gl</span>,
                                               <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_een_grad</span>)
{
<span style="color: #483d8b;">#ifdef</span> HAVE_HPC
  <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_factor_een_grad_hpc
<span style="color: #483d8b;">#else</span>
  <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_factor_een_grad_doc
<span style="color: #483d8b;">#endif</span>
    (context, walk_num, elec_num, nucl_num,
     cord_num, dim_c_vector, c_vector_full,
     lkpm_combined_index, tmp_c, dtmp_c,
     een_rescaled_n, een_rescaled_n_gl,
     factor_een_grad);
}
</pre>
</div>
</div>
<ol class="org-ol">
<li><a id="org0a34188"></a>Test<br />
<div class="outline-text-6" id="text-4-3-7-4-1">
<div class="org-src-container">
<pre class="src src-c">/* <span style="color: #b22222;">Check if Jastrow is properly initialized</span> */
<span style="color: #0000ff;">assert</span>(<span style="color: #228b22;">qmckl_jastrow_champ_provided</span>(<span style="color: #a0522d;">context</span>));

{
  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">factor_een_gl</span>[walk_num][4][elec_num];
  rc = qmckl_get_jastrow_champ_factor_een_gl(context, &amp;(factor_een_gl[0][0][0]),4*walk_num*elec_num);

  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">factor_een_grad</span>[walk_num][3][elec_num];
  rc = qmckl_get_jastrow_champ_factor_een_grad(context, &amp;(factor_een_grad[0][0][0]),3*walk_num*elec_num);

  <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">nw</span>=0 ; nw&lt;walk_num ; nw++) {
    <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">k</span>=0 ; k&lt;3; k++) {
      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int</span> <span style="color: #a0522d;">i</span>=0 ; i&lt;elec_num ; i++) {
        assert(fabs(factor_een_gl[nw][k][i] - factor_een_grad[nw][k][i]) &lt; 1e-8);
      }
    }
  }
}
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>

<div id="outline-container-orgffe2e30" class="outline-4">
<h4 id="orgffe2e30"><span class="section-number-4">4.3.8.</span> Electron-electron-nucleus Jastrow Parameter derivatives</h4>
<div class="outline-text-4" id="text-4-3-8">
<p>
Calculate the derivatives of electron-electron-nuclear three-body jastrow component <code>factor_een</code>
wit respect to the parameters. 
</p>

<p>
TODO: write equations.
</p>
</div>

<div id="outline-container-orgcc2b38b" class="outline-5">
<h5 id="orgcc2b38b"><span class="section-number-5">4.3.8.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-3-8-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_een_pderiv</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                          <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_een_pderiv</span>,
                                          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org856c38d"></a>Fortran interface<br />
<div class="outline-text-6" id="text-4-3-8-1-1">
<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_een_pderiv</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        factor_een_pderiv, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> factor_een_pderiv(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_een_pderiv</span>
<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org2c68709" class="outline-5">
<h5 id="org2c68709"><span class="section-number-5">4.3.8.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-3-8-2">
<table id="orga5d3637" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of unique nuclei</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_vector</code></td>
<td class="org-left"><code>int64_t[nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">IDs of unique nuclei</td>
</tr>

<tr>
<td class="org-left"><code>cord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">order of polynomials</td>
</tr>

<tr>
<td class="org-left"><code>dim_c_vector</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">dimension of full coefficient vector</td>
</tr>

<tr>
<td class="org-left"><code>c_vector_full</code></td>
<td class="org-left"><code>double[dim_c_vector][nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">full coefficient vector</td>
</tr>

<tr>
<td class="org-left"><code>lkpm_combined_index</code></td>
<td class="org-left"><code>int64_t[4][dim_c_vector]</code></td>
<td class="org-left">in</td>
<td class="org-left">combined indices</td>
</tr>

<tr>
<td class="org-left"><code>tmp_c</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num-1][0:cord_num][nucl_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">vector of non-zero coefficients</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][nucl_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus rescaled distances</td>
</tr>

<tr>
<td class="org-left"><code>factor_een_pderiv</code></td>
<td class="org-left"><code>double[type_nucl_num][dim_c_vector]</code></td>
<td class="org-left">out</td>
<td class="org-left">Electron-nucleus jastrow</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_pderiv_doc</span>( <span style="color: #a020f0;">&amp;</span>
     context, walk_num, elec_num, nucl_num, type_nucl_num, <span style="color: #a020f0;">&amp;</span>
     type_nucl_vector, cord_num, dim_c_vector, c_vector_full, <span style="color: #a020f0;">&amp;</span>
     lkpm_combined_index, tmp_c, een_rescaled_n, factor_een_pderiv) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> type_nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> type_nucl_vector(nucl_num)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> cord_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> dim_c_vector</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> c_vector_full(nucl_num,dim_c_vector)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> lkpm_combined_index(dim_c_vector,4)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> tmp_c(elec_num,nucl_num,0:cord_num,0:cord_num-1,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> een_rescaled_n(elec_num,nucl_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> factor_een_pderiv(dim_c_vector, type_nucl_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, a, j, l, k, p, m, n, nw</span>
  <span style="color: #228b22;">double precision</span> ::<span style="color: #a0522d;"> accu, accu2, cn</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) info = QMCKL_INVALID_CONTEXT
  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0)                 info = QMCKL_INVALID_ARG_2
  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0)                 info = QMCKL_INVALID_ARG_3
  <span style="color: #a020f0;">if</span> (nucl_num &lt;= 0)                 info = QMCKL_INVALID_ARG_4
  <span style="color: #a020f0;">if</span> (cord_num &lt;  0)                 info = QMCKL_INVALID_ARG_5
  <span style="color: #a020f0;">if</span> (info /= QMCKL_SUCCESS)         <span style="color: #a020f0;">return</span>

  factor_een_pderiv = 0.0d0

  <span style="color: #a020f0;">if</span> (cord_num == 0) <span style="color: #a020f0;">return</span>

  <span style="color: #a020f0;">do</span> nw =1, walk_num
     <span style="color: #a020f0;">do</span> n = 1, dim_c_vector
        l = lkpm_combined_index(n, 1)
        k = lkpm_combined_index(n, 2)
        m = lkpm_combined_index(n, 4)

        <span style="color: #a020f0;">do</span> a = 1, nucl_num
           accu = 0.0d0
           <span style="color: #a020f0;">do</span> j = 1, elec_num
              accu = accu + een_rescaled_n(j,a,m,nw) * tmp_c(j,a,m+l,k,nw)
           <span style="color: #a020f0;">end do</span>
           factor_een_pderiv(n, type_nucl_vector(a)+1) = factor_een_pderiv(n, type_nucl_vector(a)+1) + accu
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_pderiv_doc</span>
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org32333b6" class="outline-4">
<h4 id="org32333b6"><span class="section-number-4">4.3.9.</span> Electron-electron-nucleus Parameter Derivative of the gradient and Laplacian</h4>
<div class="outline-text-4" id="text-4-3-9">
<p>
The derivative of <code>factor_een_gl</code> with respect to all the jastrow parameters
C is computed and stored into <code>factor_een_gl_pderiv</code>
</p>

<p>
TODO: write equations
</p>
</div>

<div id="outline-container-org71f71e0" class="outline-5">
<h5 id="org71f71e0"><span class="section-number-5">4.3.9.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-3-9-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_een_gl_pderiv</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                                     <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">factor_een_gl_pderiv</span>,
                                     <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>


<ol class="org-ol">
<li><a id="org25d50b3"></a>Fortran interface<br />
<div class="outline-text-6" id="text-4-3-9-1-1">
<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_een_gl_pderiv</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        factor_een_gl_pderiv, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> factor_een_gl_pderiv(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_factor_een_gl_pderiv</span>
<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgfc7ef13" class="outline-5">
<h5 id="orgfc7ef13"><span class="section-number-5">4.3.9.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-3-9-2">
<table id="orgfec4ba1" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of types of nuclei</td>
</tr>

<tr>
<td class="org-left"><code>type_nucl_vector</code></td>
<td class="org-left"><code>int64_t[nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">The nucl type index of each nucleus</td>
</tr>

<tr>
<td class="org-left"><code>cord_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">order of polynomials</td>
</tr>

<tr>
<td class="org-left"><code>dim_c_vector</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">dimension of full coefficient vector</td>
</tr>

<tr>
<td class="org-left"><code>c_vector_full</code></td>
<td class="org-left"><code>double[dim_c_vector][nucl_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">full coefficient vector</td>
</tr>

<tr>
<td class="org-left"><code>lkpm_combined_index</code></td>
<td class="org-left"><code>int64_t[4][dim_c_vector]</code></td>
<td class="org-left">in</td>
<td class="org-left">combined indices</td>
</tr>

<tr>
<td class="org-left"><code>tmp_c</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num-1][0:cord_num][nucl_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Temporary intermediate tensor</td>
</tr>

<tr>
<td class="org-left"><code>dtmp_c</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num-1][0:cord_num][nucl_num][4][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">vector of non-zero coefficients</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][nucl_num][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Electron-nucleus rescaled factor</td>
</tr>

<tr>
<td class="org-left"><code>een_rescaled_n_gl</code></td>
<td class="org-left"><code>double[walk_num][0:cord_num][nucl_num][4][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Derivative of Electron-nucleus rescaled factor</td>
</tr>

<tr>
<td class="org-left"><code>factor_een_gl_pderiv</code></td>
<td class="org-left"><code>double[type_nucl_num][dim_c_vector][elec_num][4]</code></td>
<td class="org-left">out</td>
<td class="org-left">Derivative of Electron-nucleus jastrow</td>
</tr>
</tbody>
</table>


<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_gl_pderiv_doc</span>( <span style="color: #a020f0;">&amp;</span>
     context, walk_num, elec_num, nucl_num, type_nucl_num, type_nucl_vector, <span style="color: #a020f0;">&amp;</span>
     cord_num, dim_c_vector, c_vector_full, lkpm_combined_index, <span style="color: #a020f0;">&amp;</span>
     tmp_c, dtmp_c, een_rescaled_n, een_rescaled_n_gl, factor_een_gl_pderiv)<span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> type_nucl_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> type_nucl_vector(nucl_num)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> cord_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> dim_c_vector</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> c_vector_full(nucl_num,dim_c_vector)</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> lkpm_combined_index(dim_c_vector,4)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> tmp_c(elec_num,nucl_num,0:cord_num,0:cord_num-1,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> dtmp_c(elec_num,4,nucl_num,0:cord_num,0:cord_num-1,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> een_rescaled_n(elec_num,nucl_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> een_rescaled_n_gl(elec_num,4,nucl_num,0:cord_num,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> factor_een_gl_pderiv(4,elec_num,dim_c_vector,type_nucl_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, a, j, l, k, m, n, nw, ii</span>
  <span style="color: #228b22;">double precision</span> ::<span style="color: #a0522d;"> accu, accu2, cn</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) info = QMCKL_INVALID_CONTEXT
  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0)                 info = QMCKL_INVALID_ARG_2
  <span style="color: #a020f0;">if</span> (elec_num &lt;= 0)                 info = QMCKL_INVALID_ARG_3
  <span style="color: #a020f0;">if</span> (nucl_num &lt;= 0)                 info = QMCKL_INVALID_ARG_4
  <span style="color: #a020f0;">if</span> (cord_num &lt;  0)                 info = QMCKL_INVALID_ARG_5
  <span style="color: #a020f0;">if</span> (info /= QMCKL_SUCCESS)         <span style="color: #a020f0;">return</span>

  factor_een_gl_pderiv = 0.0d0
  <span style="color: #a020f0;">if</span> (cord_num == 0) <span style="color: #a020f0;">then</span>
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">end if</span>

  <span style="color: #a020f0;">do</span> nw =1, walk_num
     <span style="color: #a020f0;">do</span> n = 1, dim_c_vector
        l = lkpm_combined_index(n, 1)
        k = lkpm_combined_index(n, 2)
        m = lkpm_combined_index(n, 4)

        <span style="color: #a020f0;">do</span> a = 1, nucl_num
           cn = c_vector_full(a, n)
           ! <span style="color: #b22222;">if(cn == 0.d0) cycle</span>

           <span style="color: #a020f0;">do</span> ii = 1, 4
              <span style="color: #a020f0;">do</span> j = 1, elec_num
                 factor_een_gl_pderiv(ii,j,n,type_nucl_vector(a)+1) = factor_een_gl_pderiv(ii,j,n,type_nucl_vector(a)+1) + ( <span style="color: #a020f0;">&amp;</span>
                      tmp_c (j,   a,m  ,k,nw) * een_rescaled_n_gl(j,ii,a,m+l,nw) + <span style="color: #a020f0;">&amp;</span>
                      tmp_c (j,   a,m+l,k,nw) * een_rescaled_n_gl(j,ii,a,m  ,nw) + <span style="color: #a020f0;">&amp;</span>
                      dtmp_c(j,ii,a,m  ,k,nw) * een_rescaled_n   (j,   a,m+l,nw) + <span style="color: #a020f0;">&amp;</span>
                      dtmp_c(j,ii,a,m+l,k,nw) * een_rescaled_n   (j,   a,m  ,nw)   <span style="color: #a020f0;">&amp;</span>
                      )
              <span style="color: #a020f0;">end do</span>
           <span style="color: #a020f0;">end do</span>

           <span style="color: #a020f0;">do</span> j = 1, elec_num
              factor_een_gl_pderiv(4,j,n,type_nucl_vector(a)+1) = factor_een_gl_pderiv(4,j,n,type_nucl_vector(a)+1) +  ( <span style="color: #a020f0;">&amp;</span>
                   dtmp_c(j,1,a,m  ,k,nw) * een_rescaled_n_gl(j,1,a,m+l,nw)  + <span style="color: #a020f0;">&amp;</span>
                   dtmp_c(j,2,a,m  ,k,nw) * een_rescaled_n_gl(j,2,a,m+l,nw)  + <span style="color: #a020f0;">&amp;</span>
                   dtmp_c(j,3,a,m  ,k,nw) * een_rescaled_n_gl(j,3,a,m+l,nw)  + <span style="color: #a020f0;">&amp;</span>
                   dtmp_c(j,1,a,m+l,k,nw) * een_rescaled_n_gl(j,1,a,m  ,nw)  + <span style="color: #a020f0;">&amp;</span>
                   dtmp_c(j,2,a,m+l,k,nw) * een_rescaled_n_gl(j,2,a,m  ,nw)  + <span style="color: #a020f0;">&amp;</span>
                   dtmp_c(j,3,a,m+l,k,nw) * een_rescaled_n_gl(j,3,a,m  ,nw)    <span style="color: #a020f0;">&amp;</span>
                   ) * 2
           <span style="color: #a020f0;">end do</span>
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_factor_een_gl_pderiv_doc</span>
</pre>
</div>
</div>
</div>
</div>
</div>

<div id="outline-container-org0760f83" class="outline-3">
<h3 id="org0760f83"><span class="section-number-3">4.4.</span> Total Jastrow</h3>
<div class="outline-text-3" id="text-4-4">
</div>
<div id="outline-container-org848d1c4" class="outline-4">
<h4 id="org848d1c4"><span class="section-number-4">4.4.1.</span> Value</h4>
<div class="outline-text-4" id="text-4-4-1">
<p>
Value of the total Jastrow factor: \(\exp(J)\)
</p>
</div>

<div id="outline-container-org5b0b780" class="outline-5">
<h5 id="org5b0b780"><span class="section-number-5">4.4.1.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-4-1-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_value</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                            <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">value</span>,
                            <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org4d1080e"></a>Fortran interface<br />
<div class="outline-text-6" id="text-4-4-1-1-1">
<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_value</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        value, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> value(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_value</span>
<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-orgbd177d0" class="outline-5">
<h5 id="orgbd177d0"><span class="section-number-5">4.4.1.2.</span> Compute</h5>
<div class="outline-text-5" id="text-4-4-1-2">
<table id="org80bc513" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>f_ee</code></td>
<td class="org-left"><code>double[walk_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">ee component</td>
</tr>

<tr>
<td class="org-left"><code>f_en</code></td>
<td class="org-left"><code>double[walk_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">eN component</td>
</tr>

<tr>
<td class="org-left"><code>f_een</code></td>
<td class="org-left"><code>double[walk_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">eeN component</td>
</tr>

<tr>
<td class="org-left"><code>value</code></td>
<td class="org-left"><code>double[walk_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">Total Jastrow factor</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_value_doc</span>(context, <span style="color: #a020f0;">&amp;</span>
     walk_num, f_ee, f_en, f_een, <span style="color: #a020f0;">value</span>) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> f_ee(walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> f_en(walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> f_een(walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> value(walk_num)</span>
  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                  ::<span style="color: #a0522d;"> info</span>

  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">do</span> i = 1, walk_num
     <span style="color: #a020f0;">value</span>(i) = f_ee(i) + f_en(i) + f_een(i)
  <span style="color: #a020f0;">end do</span>

  <span style="color: #a020f0;">do</span> i = 1, walk_num
     ! <span style="color: #b22222;">Flush to zero to avoid floating-point exception</span>
     <span style="color: #a020f0;">if</span> (<span style="color: #a020f0;">value</span>(i) &lt; -100.d0) <span style="color: #a020f0;">then</span>
       <span style="color: #a020f0;">value</span>(i) = 0.d0
     <span style="color: #a020f0;">else</span>
       <span style="color: #a020f0;">value</span>(i) = dexp(<span style="color: #a020f0;">value</span>(i))
     <span style="color: #a020f0;">endif</span>
  <span style="color: #a020f0;">end do</span>

<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_value_doc</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_value</span> (
      <span style="color: #228b22;">Type</span> <span style="color: #a0522d;">Variable</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">f_ee</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">f_en</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">f_een</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">value</span> ); 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_value_doc</span> (
      <span style="color: #228b22;">Type</span> <span style="color: #a0522d;">Variable</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">f_ee</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">f_en</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">f_een</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">value</span> ); 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_value_hpc</span> (
      <span style="color: #228b22;">Type</span> <span style="color: #a0522d;">Variable</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">f_ee</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">f_en</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">f_een</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">value</span> ); 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_value</span> (
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">factor_ee</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">factor_en</span>,
          <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">factor_een</span>,
          <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">value</span>)
{

<span style="color: #483d8b;">#ifdef</span> HAVE_HPC
  <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_value_hpc
<span style="color: #483d8b;">#else</span>
  <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_value_doc
<span style="color: #483d8b;">#endif</span>
    (context, walk_num, factor_ee, factor_en, factor_een, value);
}
</pre>
</div>
</div>
</div>
</div>

<div id="outline-container-org7563da5" class="outline-4">
<h4 id="org7563da5"><span class="section-number-4">4.4.2.</span> Derivatives</h4>
<div class="outline-text-4" id="text-4-4-2">
<p>
Gradients and Laplacian of the total Jastrow factor:
\[
      \nabla \left[ e^{J(\mathbf{r})} \right] = e^{J(\mathbf{r})} \nabla J(\mathbf{r})
    \]
\[
      \Delta \left[ e^{J(\mathbf{r})} \right] = e^{J(\mathbf{r})}
    \left[ \Delta J(\mathbf{r}) + \nabla J(\mathbf{r}) \cdot \nabla J(\mathbf{r}) \right]
    \]
</p>
</div>

<div id="outline-container-orgf3f5c6d" class="outline-5">
<h5 id="orgf3f5c6d"><span class="section-number-5">4.4.2.1.</span> Get</h5>
<div class="outline-text-5" id="text-4-4-2-1">
<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_gl</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                            <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">gl</span>,
                            <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);

<span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_grad</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                            <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">grad</span>,
                            <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span>
<span style="color: #0000ff;">qmckl_get_jastrow_champ_grad</span>(<span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
                            <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">grad</span>,
                            <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">size_max</span>);
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="orgb624da6"></a>Fortran interface<br />
<div class="outline-text-6" id="text-4-4-2-1-1">
<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">interface</span>
   <span style="color: #228b22;">integer</span>(qmckl_exit_code)<span style="color: #a0522d;"> </span><span style="color: #a020f0;">function</span><span style="color: #a0522d;"> </span><span style="color: #0000ff;">qmckl_get_jastrow_champ_gl</span><span style="color: #a0522d;"> (context, </span><span style="color: #a020f0;">&amp;</span>
<span style="color: #a0522d;">        gl, size_max) bind(C)</span>
     <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
     <span style="color: #a020f0;">import</span>
     <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
     <span style="color: #228b22;">integer</span> (qmckl_context) , <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
     <span style="color: #228b22;">integer</span>(<span style="color: #008b8b;">c_int64_t</span>), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span>       ::<span style="color: #a0522d;"> size_max</span>
     <span style="color: #228b22;">real</span>(<span style="color: #008b8b;">c_double</span>),   <span style="color: #a020f0;">intent</span>(out)               ::<span style="color: #a0522d;"> gl(size_max)</span>
   <span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_get_jastrow_champ_gl</span>
<span style="color: #a020f0;">end interface</span>
</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org8c40b62" class="outline-5">
<h5 id="org8c40b62"><span class="section-number-5">4.4.2.2.</span> Compute GL</h5>
<div class="outline-text-5" id="text-4-4-2-2">
<table id="orgbf3d116" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>value</code></td>
<td class="org-left"><code>double[walk_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Total Jastrow</td>
</tr>

<tr>
<td class="org-left"><code>gl_ee</code></td>
<td class="org-left"><code>double[walk_num][4][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">ee component</td>
</tr>

<tr>
<td class="org-left"><code>gl_en</code></td>
<td class="org-left"><code>double[walk_num][4][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">eN component</td>
</tr>

<tr>
<td class="org-left"><code>gl_een</code></td>
<td class="org-left"><code>double[walk_num][4][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">eeN component</td>
</tr>

<tr>
<td class="org-left"><code>gl</code></td>
<td class="org-left"><code>double[walk_num][4][elec_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">Total Jastrow factor</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_gl_doc</span>(context, <span style="color: #a020f0;">&amp;</span>
     walk_num, elec_num, <span style="color: #a020f0;">value</span>, gl_ee, gl_en, gl_een, gl) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">bind</span>(C) <span style="color: #a020f0;">result</span>(info)
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> value(walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> gl_ee(elec_num,4,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> gl_en(elec_num,4,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> gl_een(elec_num,4,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> gl(elec_num,4,walk_num)</span>

  <span style="color: #228b22;">integer</span>(qmckl_exit_code)                 ::<span style="color: #a0522d;"> info</span>
  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, j, k</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">do</span> k = 1, walk_num
     <span style="color: #a020f0;">do</span> j=1,4
        <span style="color: #a020f0;">do</span> i = 1, elec_num
           gl(i,j,k) = gl_ee(i,j,k) + gl_en(i,j,k) + gl_een(i,j,k)
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">do</span> i = 1, elec_num
        gl(i,4,k) = gl(i,4,k) + <span style="color: #a020f0;">&amp;</span>
             gl(i,1,k) * gl(i,1,k) + <span style="color: #a020f0;">&amp;</span>
             gl(i,2,k) * gl(i,2,k) + <span style="color: #a020f0;">&amp;</span>
             gl(i,3,k) * gl(i,3,k)
     <span style="color: #a020f0;">end do</span>
     gl(:,:,k) = gl(:,:,k) * <span style="color: #a020f0;">value</span>(k)
  <span style="color: #a020f0;">end do</span>


<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_gl_doc</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_gl</span> (
      <span style="color: #228b22;">Type</span> <span style="color: #a0522d;">Variable</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">value</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_ee</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_en</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_een</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">gl</span> ); 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_gl_doc</span> (
      <span style="color: #228b22;">Type</span> <span style="color: #a0522d;">Variable</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">value</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_ee</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_en</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_een</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">gl</span> ); 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_gl_hpc</span> (
      <span style="color: #228b22;">Type</span> <span style="color: #a0522d;">Variable</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">value</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_ee</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_en</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_een</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">gl</span> ); 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_gl</span> (
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">value</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_ee</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_en</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_een</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">gl</span>)
{

<span style="color: #483d8b;">#ifdef</span> HAVE_HPC
  <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_gl_hpc
<span style="color: #483d8b;">#else</span>
  <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_gl_doc
<span style="color: #483d8b;">#endif</span>
    (context, walk_num, elec_num, value, gl_ee, gl_en, gl_een, gl);
}
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org686ac1f"></a>Test<br />
<div class="outline-text-6" id="text-4-4-2-2-1">
<div class="org-src-container">
<pre class="src src-c">printf(<span style="color: #8b2252;">"Total Jastrow derivatives\n"</span>);
/* <span style="color: #b22222;">Check if Jastrow is properly initialized</span> */
<span style="color: #0000ff;">assert</span>(<span style="color: #228b22;">qmckl_jastrow_champ_provided</span>(<span style="color: #a0522d;">context</span>));
{

  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">factor_ee_gl</span>[walk_num][4][elec_num];
  rc = qmckl_check(context,
                   qmckl_get_jastrow_champ_factor_ee_gl(context, &amp;(factor_ee_gl[0][0][0]), walk_num*elec_num*4)
                   );
  assert(rc == QMCKL_SUCCESS);

  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">factor_en_gl</span>[walk_num][4][elec_num];
  rc = qmckl_check(context,
                   qmckl_get_jastrow_champ_factor_en_gl(context, &amp;(factor_en_gl[0][0][0]), walk_num*elec_num*4)
                   );
  assert(rc == QMCKL_SUCCESS);

  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">factor_een_gl</span>[walk_num][4][elec_num];
  rc = qmckl_check(context,
                   qmckl_get_jastrow_champ_factor_een_gl(context, &amp;(factor_een_gl[0][0][0]), walk_num*elec_num*4)
                   );
  assert(rc == QMCKL_SUCCESS);

  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">total_j_deriv</span>[walk_num][4][elec_num];
  rc = qmckl_check(context,
                   qmckl_get_jastrow_champ_gl(context, &amp;(total_j_deriv[0][0][0]), walk_num*elec_num*4)
                   );
  assert(rc == QMCKL_SUCCESS);

  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">total_j</span>[walk_num];
  rc = qmckl_check(context,
                   qmckl_get_jastrow_champ_value(context, &amp;(total_j[0]), walk_num)
                   );
  assert(rc == QMCKL_SUCCESS);


  <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">k</span>=0 ; k&lt; walk_num ; ++k) {
    <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">m</span>=0 ; m&lt;4; ++m) {
      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">e</span>=0 ; e&lt;elec_num; ++e) {
        <span style="color: #a020f0;">if</span> (m &lt; 3) { /* <span style="color: #b22222;">test only gradients</span> */
          <span style="color: #a020f0;">if</span> (fabs(total_j_deriv[k][m][e]/total_j[k] - (factor_ee_gl[k][m][e] + factor_en_gl[k][m][e] + factor_een_gl[k][m][e])) &gt; 1e-12) {
            printf(<span style="color: #8b2252;">"k = %ld\n"</span>, k);
            printf(<span style="color: #8b2252;">"m = %ld\n"</span>, m);
            printf(<span style="color: #8b2252;">"e = %ld\n"</span>, e);
            printf(<span style="color: #8b2252;">"total_j_deriv/total_j = %20.15e\n"</span>, total_j_deriv[k][m][e]/total_j[k]);
            printf(<span style="color: #8b2252;">"factor_ee_gl + factor_en_gl + factor_een_gl = %20.15e\n"</span>, factor_ee_gl[k][m][e] + factor_en_gl[k][m][e] + factor_een_gl[k][m][e]);
            fflush(stdout);
          }
          assert (fabs(total_j_deriv[k][m][e]/total_j[k] - (factor_ee_gl[k][m][e] + factor_en_gl[k][m][e] + factor_een_gl[k][m][e])) &lt; 1.e-8);
        }
      }
    }
  }


</pre>
</div>
</div>
</li>
</ol>
</div>

<div id="outline-container-org4b72240" class="outline-5">
<h5 id="org4b72240"><span class="section-number-5">4.4.2.3.</span> Compute Gradient only</h5>
<div class="outline-text-5" id="text-4-4-2-3">
<table id="orge9f846f" border="2" cellspacing="0" cellpadding="6" rules="groups" frame="hsides">


<colgroup>
<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />

<col  class="org-left" />
</colgroup>
<thead>
<tr>
<th scope="col" class="org-left">Variable</th>
<th scope="col" class="org-left">Type</th>
<th scope="col" class="org-left">In/Out</th>
<th scope="col" class="org-left">Description</th>
</tr>
</thead>
<tbody>
<tr>
<td class="org-left"><code>context</code></td>
<td class="org-left"><code>qmckl_context</code></td>
<td class="org-left">in</td>
<td class="org-left">Global state</td>
</tr>

<tr>
<td class="org-left"><code>walk_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of walkers</td>
</tr>

<tr>
<td class="org-left"><code>elec_num</code></td>
<td class="org-left"><code>int64_t</code></td>
<td class="org-left">in</td>
<td class="org-left">Number of electrons</td>
</tr>

<tr>
<td class="org-left"><code>value</code></td>
<td class="org-left"><code>double[walk_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">Total Jastrow</td>
</tr>

<tr>
<td class="org-left"><code>gl_ee</code></td>
<td class="org-left"><code>double[walk_num][4][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">ee component</td>
</tr>

<tr>
<td class="org-left"><code>gl_en</code></td>
<td class="org-left"><code>double[walk_num][4][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">eN component</td>
</tr>

<tr>
<td class="org-left"><code>grad_een</code></td>
<td class="org-left"><code>double[walk_num][3][elec_num]</code></td>
<td class="org-left">in</td>
<td class="org-left">eeN component</td>
</tr>

<tr>
<td class="org-left"><code>grad</code></td>
<td class="org-left"><code>double[walk_num][3][elec_num]</code></td>
<td class="org-left">out</td>
<td class="org-left">Total Jastrow factor</td>
</tr>
</tbody>
</table>

<div class="org-src-container">
<pre class="src src-f90"><span style="color: #a020f0;">function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_grad_doc</span>(context, <span style="color: #a020f0;">&amp;</span>
     walk_num, elec_num, <span style="color: #a020f0;">value</span>, gl_ee, gl_en, grad_een, grad) <span style="color: #a020f0;">&amp;</span>
     <span style="color: #a020f0;">result</span>(info) <span style="color: #a020f0;">bind</span>(C)
  <span style="color: #a020f0;">use</span>, <span style="color: #a020f0;">intrinsic</span> :: <span style="color: #0000ff;">iso_c_binding</span>
  <span style="color: #a020f0;">use</span> <span style="color: #0000ff;">qmckl</span>
  <span style="color: #a020f0;">implicit</span> <span style="color: #228b22;">none</span>
  <span style="color: #228b22;">integer</span>(qmckl_context), <span style="color: #a020f0;">intent</span>(in), <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> context</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> walk_num</span>
  <span style="color: #228b22;">integer</span> (<span style="color: #008b8b;">c_int64_t</span>) , <span style="color: #a020f0;">intent</span>(in)  , <span style="color: #a020f0;">value</span> ::<span style="color: #a0522d;"> elec_num</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> value(walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> gl_ee(elec_num,4,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> gl_en(elec_num,4,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(in)          ::<span style="color: #a0522d;"> grad_een(elec_num,3,walk_num)</span>
  <span style="color: #228b22;">real</span>    (<span style="color: #008b8b;">c_double</span> ) , <span style="color: #a020f0;">intent</span>(out)         ::<span style="color: #a0522d;"> grad(elec_num,3,walk_num)</span>

  <span style="color: #228b22;">integer</span>(qmckl_exit_code) ::<span style="color: #a0522d;"> info</span>
  <span style="color: #228b22;">integer</span>*8 ::<span style="color: #a0522d;"> i, j, k</span>

  info = QMCKL_SUCCESS

  <span style="color: #a020f0;">if</span> (context == QMCKL_NULL_CONTEXT) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_CONTEXT
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">if</span> (walk_num &lt;= 0) <span style="color: #a020f0;">then</span>
     info = QMCKL_INVALID_ARG_2
     <span style="color: #a020f0;">return</span>
  <span style="color: #a020f0;">endif</span>

  <span style="color: #a020f0;">do</span> k = 1, walk_num
     <span style="color: #a020f0;">do</span> j=1,3
        <span style="color: #a020f0;">do</span> i = 1, elec_num
           grad(i,j,k) = gl_ee(i,j,k) + gl_en(i,j,k) + grad_een(i,j,k)
        <span style="color: #a020f0;">end do</span>
     <span style="color: #a020f0;">end do</span>
     grad(:,:,k) = grad(:,:,k) * <span style="color: #a020f0;">value</span>(k)
  <span style="color: #a020f0;">end do</span>


<span style="color: #a020f0;">end function</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_grad_doc</span>
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_grad</span> (
      <span style="color: #228b22;">Type</span> <span style="color: #a0522d;">Variable</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">value</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_ee</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_en</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">grad_een</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">grad</span> ); 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_grad_doc</span> (
      <span style="color: #228b22;">Type</span> <span style="color: #a0522d;">Variable</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">value</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_ee</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_en</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">grad_een</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">grad</span> ); 
</pre>
</div>

<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_grad_hpc</span> (
      <span style="color: #228b22;">Type</span> <span style="color: #a0522d;">Variable</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">value</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_ee</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_en</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">grad_een</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">grad</span> ); 
</pre>
</div>


<div class="org-src-container">
<pre class="src src-c"><span style="color: #228b22;">qmckl_exit_code</span> <span style="color: #0000ff;">qmckl_compute_jastrow_champ_grad</span> (
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">qmckl_context</span> <span style="color: #a0522d;">context</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">walk_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">elec_num</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">value</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_ee</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">gl_en</span>,
      <span style="color: #a020f0;">const</span> <span style="color: #228b22;">double</span>* <span style="color: #a0522d;">grad_een</span>,
      <span style="color: #228b22;">double</span>* <span style="color: #a020f0;">const</span> <span style="color: #a0522d;">grad</span>)
{

<span style="color: #483d8b;">#ifdef</span> HAVE_HPC
  <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_grad_hpc
<span style="color: #483d8b;">#else</span>
  <span style="color: #a020f0;">return</span> qmckl_compute_jastrow_champ_grad_doc
<span style="color: #483d8b;">#endif</span>
    (context, walk_num, elec_num, value, gl_ee, gl_en, grad_een, grad);
}
</pre>
</div>
</div>

<ol class="org-ol">
<li><a id="org9d9a5c4"></a>Test<br />
<div class="outline-text-6" id="text-4-4-2-3-1">
<div class="org-src-container">
<pre class="src src-c">printf(<span style="color: #8b2252;">"Total Jastrow gradient only\n"</span>);
/* <span style="color: #b22222;">Check if Jastrow is properly initialized</span> */
<span style="color: #0000ff;">assert</span>(<span style="color: #228b22;">qmckl_jastrow_champ_provided</span>(<span style="color: #a0522d;">context</span>));

{
  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">total_j_grad</span>[walk_num][3][elec_num];
  rc = qmckl_check(context,
                  qmckl_get_jastrow_champ_grad(context, &amp;(total_j_grad[0][0][0]), walk_num*elec_num*3)
                  );
  assert(rc == QMCKL_SUCCESS);


  <span style="color: #228b22;">double</span> <span style="color: #a0522d;">total_j_deriv</span>[walk_num][4][elec_num];
  rc = qmckl_check(context,
                  qmckl_get_jastrow_champ_gl(context, &amp;(total_j_deriv[0][0][0]), walk_num*elec_num*4)
                  );
  assert(rc == QMCKL_SUCCESS);



  <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">k</span>=0 ; k&lt; walk_num ; ++k) {
    <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">m</span>=0 ; m&lt;3; ++m) {
      <span style="color: #a020f0;">for</span> (<span style="color: #228b22;">int64_t</span> <span style="color: #a0522d;">e</span>=0 ; e&lt;elec_num; ++e) {
        <span style="color: #a020f0;">if</span> (fabs(total_j_grad[k][m][e] - total_j_deriv[k][m][e]) &gt; 1e-12) {
          printf(<span style="color: #8b2252;">"%ld %ld %ld\n"</span>, k, m, e);
          printf(<span style="color: #8b2252;">"total_j_deriv = %20.15e\n"</span>, total_j_deriv[k][m][e]);
          printf(<span style="color: #8b2252;">"total_j_grad  = %20.15e\n"</span>, total_j_grad[k][m][e]);
          fflush(stdout);
        }
        assert (fabs(total_j_deriv[k][m][e] - total_j_grad[k][m][e]) &lt; 1.e-8);
      }
    }
  }
}

}
</pre>
</div>
</div>
</li>
</ol>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: TREX CoE</p>
<p class="date">Created: 2025-09-23 Tue 11:18</p>
<p class="validation"><a href="https://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
